<!doctype html><html lang dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Apache Kafka is an open-source distributed event streaming platform. Kafka 是一个开源的分布式事件流平台。 📑 基本概念 生产者 &amp;amp; 消费者 把消息放到队列里面的叫「生产者」；从队列中消费消息的叫「消费者」。"><title>Kafka</title><link rel=canonical href=https://emerywan.github.io/blog/p/kafka/><link rel=stylesheet href=/blog/scss/style.min.9fdfe1d69c4486d1a84c3c7b288ce74b0111a02a60a6c12f21c6b7cc02b131b4.css><meta property="og:title" content="Kafka"><meta property="og:description" content="Apache Kafka is an open-source distributed event streaming platform. Kafka 是一个开源的分布式事件流平台。 📑 基本概念 生产者 &amp;amp; 消费者 把消息放到队列里面的叫「生产者」；从队列中消费消息的叫「消费者」。"><meta property="og:url" content="https://emerywan.github.io/blog/p/kafka/"><meta property="og:site_name" content="一层"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Kafka"><meta property="article:published_time" content="2023-03-04T11:14:45+08:00"><meta property="article:modified_time" content="2023-03-04T11:14:45+08:00"><meta property="og:image" content="https://emerywan.github.io/blog/p/kafka/kafka.webp"><meta name=twitter:title content="Kafka"><meta name=twitter:description content="Apache Kafka is an open-source distributed event streaming platform. Kafka 是一个开源的分布式事件流平台。 📑 基本概念 生产者 &amp;amp; 消费者 把消息放到队列里面的叫「生产者」；从队列中消费消息的叫「消费者」。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://emerywan.github.io/blog/p/kafka/kafka.webp"><link rel="shortcut icon" href=https://emerywan.github.io/blog/imgs/favicon.ico><link rel=preconnect href=https://fonts.proxy.ustclug.org><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.proxy.ustclug.org/css2?family=Noto+Sans+SC&family=Roboto&family=Roboto+Mono&display=swap" rel=stylesheet><style>:root{--sys-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC", "Segoe UI", "Droid Sans", "Helvetica Neue", Ubuntu;--zh-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC",  "PingFang SC", "Hiragino Sans GB", "Droid Sans Fallback", Ubuntu, "Microsoft YaHei";--code-font-family:"SF Mono", SFMono-Regular, "Roboto Mono", "Ubuntu Mono", Menlo, Monaco, Consolas, "Courier New", monospace;--base-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC", var(--sys-font-family), var(--zh-font-family), sans-serif;--article-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC", var(--base-font-family);--article-line-height:1.6;--article-font-size:1.6rem}</style></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog><img src=/blog/img/avatar_hud10ed4afecf1b63b1391b35c2778f738_36574_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/blog>一层</a></h1><h2 class=site-description>迎着这岁月的风。</h2></div></header><ol class=social-menu><li><a href=https://github.com/emerywan target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://emery.letout.cn target=_blank title=Home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-smart-home" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#6f32be" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19 8.71l-5.333-4.148a2.666 2.666.0 00-3.274.0L5.059 8.71A2.665 2.665.0 004.03 10.815v7.2a2 2 0 002 2h12a2 2 0 002-2v-7.2c0-.823-.38-1.6-1.03-2.105"/><path d="M16 15c-2.21 1.333-5.792 1.333-8 0"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>首页</span></a></li><li><a href=/blog/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>关于</span></a></li><li><a href=/blog/categories/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg><span>分类</span></a></li><li><a href=/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>归档</span></a></li><li><a href=/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜索</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>🌗 Dark</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/p/kafka/><img src=/blog/p/kafka/kafka_hu0e688a86da638634e8e15b21ceb1a2b6_8026_800x0_resize_q75_h2_box_2.webp srcset="/blog/p/kafka/kafka_hu0e688a86da638634e8e15b21ceb1a2b6_8026_800x0_resize_q75_h2_box_2.webp 800w, /blog/p/kafka/kafka_hu0e688a86da638634e8e15b21ceb1a2b6_8026_1600x0_resize_q75_h2_box_2.webp 1600w" width=800 height=239 loading=lazy alt="Featured image of post Kafka"></a></div><div class=article-details><header class=article-category><a href=/blog/categories/%E6%8A%80%E6%9C%AF/ style=background-color:#91d5ff;color:#fff>技术</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/kafka/>Kafka</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>03 - 04, 2023</time></div></footer></div></header><section class=article-content><blockquote><p>Apache Kafka is an open-source distributed event streaming platform.</p><p>Kafka 是一个开源的分布式事件流平台。</p></blockquote><h2 id=-基本概念>📑 基本概念</h2><h3 id=生产者--消费者>生产者 & 消费者</h3><p>把消息放到队列里面的叫「生产者」；从队列中消费消息的叫「消费者」。</p><p><img src=/blog/p/kafka/productor-consumer.png width=1482 height=182 srcset="/blog/p/kafka/productor-consumer_hu2c5c2f226caa4e26dde9bd9923036917_30803_480x0_resize_box_3.png 480w, /blog/p/kafka/productor-consumer_hu2c5c2f226caa4e26dde9bd9923036917_30803_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=814 data-flex-basis=1954px></p><h3 id=topic>Topic</h3><p>Producer 将消息发送到特定的主题 <code>Topic</code>，Consumer 通过订阅特定的主题 <code>Topic</code> 来消费消息。</p><p>并非所有的消费者都想要全部的消息，消费者只对自己感兴趣的 Topic 进行订阅，从指定的 Topic 来获取消息。
这个发送问题由 生产者 <code>Product</code> 来解决，生产者在发送消息时，对消息进行逻辑上的分类，将消息发送到指定的 <code>Topic</code>。（发布-订阅模型）</p><p><img src=/blog/p/kafka/topic.png width=1702 height=464 srcset="/blog/p/kafka/topic_huc74fa2ac18b398764e9e6113e92396e7_102693_480x0_resize_box_3.png 480w, /blog/p/kafka/topic_huc74fa2ac18b398764e9e6113e92396e7_102693_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=366 data-flex-basis=880px></p><h3 id=offset>offset</h3><p>多个消费者可能对同一个主题感兴趣，即多个消费者 <code>Consumer</code> 订阅同一个主题 <code>Topic</code>。</p><p>这个消费问题由 消费者 <code>Consumer</code> 来解决。
Kafka 将所有的消息进行持久化存储，让消费者各取所需，想取哪个消息，想什么时候取都行，只需要传递一个消息的 <code>offset</code> 即可。</p><p>Kafka 将消息以消息日志的方式追加写在磁盘中（顺序磁盘 IO）。</p><p><code>offset</code> 表示了消费者的消费进度。每一条消息都会根据时间先后顺序有一个递增的序号，用 offset 来表示消费者的消费进度到哪了，每个消费者会都有自己的 offset。</p><p>每次消费消息的时候，都要提交这个 <code>offset</code>，Kafka 可以选择「自动提交」或者「手动提交」。</p><p><img src=/blog/p/kafka/offset.png width=1702 height=882 srcset="/blog/p/kafka/offset_hub631ed3146c750d7a1db077a25e92c8f_157136_480x0_resize_box_3.png 480w, /blog/p/kafka/offset_hub631ed3146c750d7a1db077a25e92c8f_157136_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=192 data-flex-basis=463px></p><h3 id=partition>Partition</h3><p><code>Partition</code> 是 Kafka 「最基本的部署单元」。</p><p>对于海量数据，单机的存储容量和读写性能肯定有限，一种常见的存储方案就是「对数据进行分片存储」。</p><ul><li><p>例如在 MySQL 中，单表的数量达到几千万、上亿时，会进行分库、分表操作</p></li><li><p>例如在 Redis 中，当单个实例的数据量达到几十G引发性能瓶颈时，会进行分片集群</p></li></ul><p>在 Kafka 中，同样采取了水平拆分的方案，将拆分后的数据子集称为 <code>Partition</code> 分区。各个分区的数据集合即为全量数据。</p><p><img src=/blog/p/kafka/partition.png width=1902 height=862 srcset="/blog/p/kafka/partition_hu6f8e653e05b83b30cced1268a2afdec4_169756_480x0_resize_box_3.png 480w, /blog/p/kafka/partition_hu6f8e653e05b83b30cced1268a2afdec4_169756_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=220 data-flex-basis=529px></p><p>分区路由可以简单地理解为一个 Hash 函数，生产者在发送消息时，可以自定义这个函数的规则决定发往的分区。将分区规则设计的合理，可以将消息均匀地分配到不同的分区上。</p><p>生产者 <code>Productor</code> 发送一条消息，先通过 <code>Topic</code> 对消息进行逻辑分类，在通过 <code>Partition</code> 进一步做物理分片，最终多个 Partition 会均匀地分布在集群的每台机器上，从而很好地解决了存储扩展性问题。</p><h3 id=broker>Broker</h3><p>一台 Kafka 服务器被称为 <code>Broker</code>，Kafka 集群由多台 Kafka 服务器组成。</p><p>Kafka 是「天然分布式」的。</p><p>一个 <code>Topic</code> 会被分为多个 <code>Partition</code>，这些 Partition 会分布在不同的 <code>Broker</code> 中。</p><p><img src=/blog/p/kafka/broker.png width=2744 height=1204 srcset="/blog/p/kafka/broker_huddafab0296be063dc2cfa60773db7d44_193217_480x0_resize_box_3.png 480w, /blog/p/kafka/broker_huddafab0296be063dc2cfa60773db7d44_193217_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=227 data-flex-basis=546px></p><h3 id=leader--follower>leader & follower</h3><p>在 Kafka 集群中，每台机器都会存储一些 Partition，为了防止机器宕机时，这部分数据无法访问的问题（持久化保证数据不丢失）。
需要 Kafka 具备故障转移能力，当某台机器宕机后，能够继续保证服务可用。</p><p>与 Reids Cluster 类似，Kafka 通过「Partition 多副本」的方式，解决了高可用问题。
在 Kafka 集群中，每个 Partition 都有多个副本，保存了相同的信息。</p><p>副本之间是 「一主多从」的关系：</p><ul><li><code>leader</code> 副本负责读写数据</li><li><code>follower</code> 副本负责同步消息，只负责待命</li></ul><p>当 leader 副本发送故障时，选举 follower 副本成为新的 leader 对外提供服务。</p><p><img src=/blog/p/kafka/leader_follwer.png width=1642 height=982 srcset="/blog/p/kafka/leader_follwer_hud0b2c7f759aaa7a9577276a758bf8076_131159_480x0_resize_box_3.png 480w, /blog/p/kafka/leader_follwer_hud0b2c7f759aaa7a9577276a758bf8076_131159_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=167 data-flex-basis=401px></p><h3 id=消费者组>消费者组</h3><p>Kafka 是个高并发的系统，消息的拉取同样是并行的，多个消费者去消费 Topic 消息。</p><p>Kafka 引入了消费者组的概念，每一个消费者都有一个对应的消费者组。组间进行广播消费，组内进行集群消费。同时限定：「每个 Partition 只能由消费者组中的一个消费者进行消费」。</p><p><img src=/blog/p/kafka/consumer_group.png width=1952 height=1378 srcset="/blog/p/kafka/consumer_group_hu7674cf08adee570cc4acecde56b2e047_315635_480x0_resize_box_3.png 480w, /blog/p/kafka/consumer_group_hu7674cf08adee570cc4acecde56b2e047_315635_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=141 data-flex-basis=339px></p><p>当需要加快消息的处理速度，（如消费者组B）只需要增加新的消费者即可，Kafka 会以 Patition 为单位重新做负载均衡。</p><p>一个消费者组可以消费 Topic 的全部数据，消费者组在逻辑上是相互独立的。</p><h2 id=-存储结构>🗳️ 存储结构</h2><p>Kafka 使用「日志文件 Logging」的方式来存储消息；使用「稀疏哈希索引」来加快查询。</p><ul><li><p>Kafka 存储的主要是消息流（文本、自定义格式），对于 Broker 来说，只需要关注消息的投递，无需关注内容本身</p></li><li><p>写入方面，数据量级非常大，都是按顺序写入（队列），且无需考虑更新</p></li><li><p>需求简单，只需要按照 offset 查询消息即可</p></li></ul><p>在为了满足其写入需求（量级大、不更新），采用 Append 追加日志的方式最理想，可以充分利用「磁盘顺序 IO」。</p><p>在查询时，只需要通过 offset 定位消息，在内存中维护了一个「从 offset 到日志文件的偏移量」的映射关系，每次
查询时，先根据 offset 找到日志文件的偏移量，即可快速读取到日志消息。</p><p>为了避免哈希索引常驻内存消耗过多空间的问题，将消息划分为若干个块 block，每个索引需要定位 block 块中的第一条消息的 offset 即可（稀疏索引），
然后在 block 中顺序查找。</p><p><img src=/blog/p/kafka/hash.png width=702 height=486 srcset="/blog/p/kafka/hash_hu74f0171d0dcbf8a19203c6a91442ff0f_91411_480x0_resize_box_3.png 480w, /blog/p/kafka/hash_hu74f0171d0dcbf8a19203c6a91442ff0f_91411_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=144 data-flex-basis=346px></p><h2 id=-kafka-的高性能>🔥 Kafka 的高性能</h2><p><img src=/blog/p/kafka/performance.png width=725 height=662 srcset="/blog/p/kafka/performance_hu3423f3489c82f749f8bb253d443fb73a_35239_480x0_resize_box_3.png 480w, /blog/p/kafka/performance_hu3423f3489c82f749f8bb253d443fb73a_35239_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=109 data-flex-basis=262px></p><h3 id=-生产消息>📑 生产消息</h3><p>Kafka 客户端与传统的数据库或消息中间件不同，在将消息发送给 Broker 之前，在 Client 端先完成大量的工作之后才发送消息，分摊 Broker 的计算压力。</p><ul><li><p>🫧 批量发送</p><p>Kafka 通过对多条消息按照分区进行分组，每次发送一个消息集合，从而减少网络传输的开销。</p></li><li><p>🫧 消息压缩</p><p>在批量发送的前提下，对消息进行压缩（数据量越大，压缩效果更好）。同时对多条消息进行压缩，能大幅减少数据量，
同时减少网络、磁盘IO开销。消息持久化到 Broker 的磁盘时，依旧是压缩状态，最终是在 Consumer 端进行解压。</p></li><li><p>🫧 高效序列化</p><p>Kafka 的 Key 和 Value，都支持自定义类型，只需要提供相应的序列化和反序列化器即可。可以根据情况选取对应的序列化方式。</p></li><li><p>🫧 内存池复用</p><p>Kafka 提出了「内存池机制」，提高复用，减少频繁的创建和回收。（本质上与连接池、线程池一样）。</p><p>Productor 在创建时，会占用一块固定大小的内存区域，划分为若干个块（例如 16KB）。当需要创建一个新的发送 Batch 时，直接从内存中取出一个块，
从中不断地写入消息（写满或到指定阈值时间时），将这个 Batch 发送给 Broker，之后内存块就会回到缓存池中继续复用。
不会涉及 JVM 的内存回收，以应对 Kafka 的高并发场景。</p></li></ul><h3 id=-存储消息>📇 存储消息</h3><ul><li><p>🫧 IO 多路复用</p><p>使用 <code>1</code> 个 <code>Acceptor</code> 线程，处理新的连接；使用 <code>N</code> 个 <code>Processor</code> 线程，读取请求；使用 <code>M</code> 个 <code>Handler</code> 线程，处理业务逻辑。</p><p>与 Redis 相同，IO 多路复用允许内核中同时管理多个 scoket 连接，内核会一直监听这些连接，一旦有请求到达，就会通知处理线程，达到一个线程处理多个请求的效果。</p></li><li><p>🫧 磁盘顺序 IO</p><p>Kafka 采用日志文件的方式持久化日志，以 Append Only 的方式追加到文件末尾，顺序 IO 使写入速度非常快。</p></li><li><p>🫧 Page Cache</p><p>利用了操作系统本身的缓存技术，在读写磁盘文件时，其实操作的都是内存，由操作系统决定什么时候将 Page Cache 中的数据真正刷入磁盘。</p><p>Page Cache 缓存中保存的是最近可能被使用的磁盘数据，具有时间局部性（最近访问的数据可能再次访问）和 空间局部性（访问的数据的周边数据被访问的概率极高）。
作为顺序写入的消息队列，如果生产和消费地特别快，利用 Broker Page Cache，甚至可以不经过磁盘完成操作。</p></li><li><p>🫧 分区分段结构</p><p>Kafka 的 Topic 会被分区为多个 Partition，在多台 Broker 中，使用多个服务来接受消息。</p><p>同时每个分区 Partition 会被分为多个段 Segment 来管理，每个段内都是顺序写，避免分区过大，利于管理。</p></li></ul><h3 id=-消费消息>📮 消费消息</h3><ul><li><p>🫧 稀疏索引</p><p>Kafka 查询场景非常简单，按照 offset 查询消息即可。为了加快读操作，只需要在内存中维护一个 offset 到日志文件的偏移量的映射关系 <code>Map</code> 即可。
每次查找消息，先从哈希表中查到文件偏移量，再去读日志文件。</p></li><li><p>🫧 mmap</p><p>memory mapped files</p><p>采用 mmap 映射索引文件，加快索引的查找过程。将磁盘文件与内存虚拟地址做了映射，不需要操作磁盘IO，进程可以使用指针的方式操作这一块内存，系统会自动将脏页写入到对应的磁盘文件上。</p></li><li><p>🫧 零拷贝</p><p>采用了零拷贝，将数据从内存中的缓存区直接拷贝到网卡设备，无需经过应用程序，减少了数据的拷贝和内核态与用户态的切换。</p></li><li><p>🫧 批量拉取</p><p>与发送消息对应，消费消息也是批量拉取的，每次拉取一个消息集合，减少网络的开销。</p></li></ul><h2 id=参考>参考</h2><ul><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&amp;mid=2247490102&amp;idx=1&amp;sn=68d55b3c5ac74038c76d6837b862a11c&amp;chksm=fc78c51acb0f4c0cd5a1d6ceedb9948f82d48791ab789e9edfd6e83e34fbad1ace5749bee203&amp;scene=21#wechat_redirect" target=_blank rel=noopener>https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&mid=2247490102&idx=1&sn=68d55b3c5ac74038c76d6837b862a11c&chksm=fc78c51acb0f4c0cd5a1d6ceedb9948f82d48791ab789e9edfd6e83e34fbad1ace5749bee203&scene=21#wechat_redirect</a></li><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&amp;mid=2247490102&amp;idx=1&amp;sn=68d55b3c5ac74038c76d6837b862a11c&amp;chksm=fc78c51acb0f4c0cd5a1d6ceedb9948f82d48791ab789e9edfd6e83e34fbad1ace5749bee203&amp;cur_album_id=1763234202604388353&amp;scene=189#wechat_redirect" target=_blank rel=noopener>https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&mid=2247490102&idx=1&sn=68d55b3c5ac74038c76d6837b862a11c&chksm=fc78c51acb0f4c0cd5a1d6ceedb9948f82d48791ab789e9edfd6e83e34fbad1ace5749bee203&cur_album_id=1763234202604388353&scene=189#wechat_redirect</a></li><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&amp;mid=2247491055&amp;idx=1&amp;sn=14bc485f91ec2629cc9e8bf7a36ad8f4&amp;chksm=fc78c2c3cb0f4bd566d5ca2534805839420ad3dc67210bc8f2b7ef05283785b02b8ddef640a8&amp;cur_album_id=1763234202604388353&amp;scene=189#wechat_redirect" target=_blank rel=noopener>https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&mid=2247491055&idx=1&sn=14bc485f91ec2629cc9e8bf7a36ad8f4&chksm=fc78c2c3cb0f4bd566d5ca2534805839420ad3dc67210bc8f2b7ef05283785b02b8ddef640a8&cur_album_id=1763234202604388353&scene=189#wechat_redirect</a></li><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&amp;mid=2247491168&amp;idx=1&amp;sn=bd37f96692b3f7cecdaf3172abdb7a8c&amp;chksm=fc78c14ccb0f485a451f70c7ffbf5b05d0f500dfef6321703e7cdebdc0de902d9d77a547d469&amp;cur_album_id=1763234202604388353&amp;scene=189#wechat_redirect" target=_blank rel=noopener>https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&mid=2247491168&idx=1&sn=bd37f96692b3f7cecdaf3172abdb7a8c&chksm=fc78c14ccb0f485a451f70c7ffbf5b05d0f500dfef6321703e7cdebdc0de902d9d77a547d469&cur_album_id=1763234202604388353&scene=189#wechat_redirect</a></li><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&amp;mid=2247491507&amp;idx=1&amp;sn=f1bec356c94cd0101809dc11dcf27ba2&amp;chksm=fc78c09fcb0f49898f6cc9b80499aeb871a80f95ab4fbe12c32567cab6a3521a6c33b61dd807&amp;cur_album_id=1763234202604388353&amp;scene=189#wechat_redirect" target=_blank rel=noopener>https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&mid=2247491507&idx=1&sn=f1bec356c94cd0101809dc11dcf27ba2&chksm=fc78c09fcb0f49898f6cc9b80499aeb871a80f95ab4fbe12c32567cab6a3521a6c33b61dd807&cur_album_id=1763234202604388353&scene=189#wechat_redirect</a></li><li><a class=link href="https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&amp;mid=2247491763&amp;idx=1&amp;sn=cc60a6ba13e5cf4384e623819c621e0d&amp;chksm=fc7b3f9fcb0cb6897be67103d91854831b71909c0d12385fb52b2f1d011fca5d1844b3892019&amp;cur_album_id=1763234202604388353&amp;scene=190#rd" target=_blank rel=noopener>https://mp.weixin.qq.com/s?__biz=MzU2MTM4NDAwMw==&mid=2247491763&idx=1&sn=cc60a6ba13e5cf4384e623819c621e0d&chksm=fc7b3f9fcb0cb6897be67103d91854831b71909c0d12385fb52b2f1d011fca5d1844b3892019&cur_album_id=1763234202604388353&scene=190#rd</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/blog/tags/kafka/>Kafka</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/blog/p/design-pattern/observer/><div class=article-image><img src=/blog/p/design-pattern/observer/observer.d66f5921d7d3ecf6b53b22504fe1af1d_hua5fe444eaf0979d6378130641051be73_47507_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 观察者模式" data-key=/design-pattern/observer data-hash="md5-1m9ZIdfT7Pa1OyJQT+GvHQ=="></div><div class=article-details><h2 class=article-title>观察者模式</h2></div></a></article><article class=has-image><a href=/blog/p/mysql/master-slave-replication/><div class=article-image><img src=/blog/p/mysql/master-slave-replication/copy.aadc4504c6a415278334a163547b1cd3_hu2815b7bcceb4bc2e593bd903d3b2a777_501311_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post MySQL 复制" data-key=/mysql/master-slave-replication data-hash="md5-qtxFBMakFSeDNKFjVHsc0w=="></div><div class=article-details><h2 class=article-title>MySQL 复制</h2></div></a></article><article class=has-image><a href=/blog/p/redis/replication/><div class=article-image><img src=/blog/p/redis/replication/replication.30f627456b5f3b1226d679fcb7c12eaf_hu79bab96584f6667bba9965688b174414_176167_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Redis 复制" data-key=/redis/replication data-hash="md5-MPYnRWtfOxIm1nn8t8Eurw=="></div><div class=article-details><h2 class=article-title>Redis 复制</h2></div></a></article><article class=has-image><a href=/blog/p/distributed/transaction/><div class=article-image><img src=/blog/p/distributed/transaction/cap.656dd86f9115f93b7182f059d2fa5f8e_hu553ea908437f51f5f9df5986bc7065cb_18394_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy alt="Featured image of post 分布式事务（Doing）" data-key=/distributed/transaction data-hash="md5-ZW3Yb5EV+TtxgvBZ0vpfjg=="></div><div class=article-details><h2 class=article-title>分布式事务（Doing）</h2></div></a></article><article class=has-image><a href=/blog/p/design-pattern/adapter/><div class=article-image><img src=/blog/p/design-pattern/adapter/adapter.b34e25db7e63438689a930d8722c3cad_hu8f557059998a06e7b13ad71eff607ec2_38612_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 适配器模式" data-key=/design-pattern/adapter data-hash="md5-s04l235jQ4aJqTDYciw8rQ=="></div><div class=article-details><h2 class=article-title>适配器模式</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 一层</section><section class=powerby><b><a href=http://beian.miit.gov.cn/ target=_blank rel="nofollow noopener">赣ICP备19004365号-3</a></b><br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=%s>Stack</a></b> by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a><br></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#-基本概念>📑 基本概念</a><ol><li><a href=#生产者--消费者>生产者 & 消费者</a></li><li><a href=#topic>Topic</a></li><li><a href=#offset>offset</a></li><li><a href=#partition>Partition</a></li><li><a href=#broker>Broker</a></li><li><a href=#leader--follower>leader & follower</a></li><li><a href=#消费者组>消费者组</a></li></ol></li><li><a href=#-存储结构>🗳️ 存储结构</a></li><li><a href=#-kafka-的高性能>🔥 Kafka 的高性能</a><ol><li><a href=#-生产消息>📑 生产消息</a></li><li><a href=#-存储消息>📇 存储消息</a></li><li><a href=#-消费消息>📮 消费消息</a></li></ol></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>