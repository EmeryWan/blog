<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‘½ä»¤è¡Œå·¥å…· Kafka æä¾›äº†ä¸€äº›åŸºäºè„šæœ¬çš„å‘½åè¡Œå·¥å…· ${dir}/bin/xxx.shï¼Œç”¨äºç®¡ç†é›†ç¾¤ã€‚è¿™äº›ç®¡ç†é€šè¿‡ Java ç±»å®ç°ï¼Œé€šè¿‡è„šæœ¬è°ƒç”¨ã€‚ 1 2 3 4 5 #"><title>Kafka æ“ä½œï¼ˆDoingï¼‰</title><link rel=canonical href=https://emerywan.github.io/blog/p/kafka/operation/><link rel=stylesheet href=/blog/scss/style.min.53b36bd111ab91c36b669e22939503ad8be1ecdac357e4514855ae8d8deda711.css><meta property="og:title" content="Kafka æ“ä½œï¼ˆDoingï¼‰"><meta property="og:description" content="å‘½ä»¤è¡Œå·¥å…· Kafka æä¾›äº†ä¸€äº›åŸºäºè„šæœ¬çš„å‘½åè¡Œå·¥å…· ${dir}/bin/xxx.shï¼Œç”¨äºç®¡ç†é›†ç¾¤ã€‚è¿™äº›ç®¡ç†é€šè¿‡ Java ç±»å®ç°ï¼Œé€šè¿‡è„šæœ¬è°ƒç”¨ã€‚ 1 2 3 4 5 #"><meta property="og:url" content="https://emerywan.github.io/blog/p/kafka/operation/"><meta property="og:site_name" content="ä¸€å±‚"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Kafka"><meta property="article:published_time" content="2023-03-26T08:08:08+08:00"><meta property="article:modified_time" content="2023-03-26T08:08:08+08:00"><meta property="og:image" content="https://emerywan.github.io/blog/p/kafka/operation/1.png"><meta name=twitter:title content="Kafka æ“ä½œï¼ˆDoingï¼‰"><meta name=twitter:description content="å‘½ä»¤è¡Œå·¥å…· Kafka æä¾›äº†ä¸€äº›åŸºäºè„šæœ¬çš„å‘½åè¡Œå·¥å…· ${dir}/bin/xxx.shï¼Œç”¨äºç®¡ç†é›†ç¾¤ã€‚è¿™äº›ç®¡ç†é€šè¿‡ Java ç±»å®ç°ï¼Œé€šè¿‡è„šæœ¬è°ƒç”¨ã€‚ 1 2 3 4 5 #"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://emerywan.github.io/blog/p/kafka/operation/1.png"><link rel="shortcut icon" href=https://emerywan.github.io/blog/imgs/favicon.ico><link rel=preconnect href=https://fonts.proxy.ustclug.org><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.proxy.ustclug.org/css2?family=Noto+Sans+SC&family=Roboto&family=Roboto+Mono&display=swap" rel=stylesheet><style>:root{--sys-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC", "Segoe UI", "Droid Sans", "Helvetica Neue", Ubuntu;--zh-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC",  "PingFang SC", "Hiragino Sans GB", "Droid Sans Fallback", Ubuntu, "Microsoft YaHei";--code-font-family:"SF Mono", SFMono-Regular, "Roboto Mono", "Ubuntu Mono", Menlo, Monaco, Consolas, "Courier New", monospace, var(--zh-font-family);--base-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC", var(--sys-font-family), var(--zh-font-family), sans-serif;--article-font-family:-apple-system, BlinkMacSystemFont, "Roboto", "Noto Sans SC", var(--base-font-family);--article-line-height:1.6;--article-font-size:1.6rem}</style></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog><img src=/blog/img/avatar_hud10ed4afecf1b63b1391b35c2778f738_36574_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/blog>ä¸€å±‚</a></h1><h2 class=site-description>è¿ç€è¿™å²æœˆçš„é£ã€‚</h2></div></header><ol class=social-menu><li><a href=https://github.com/emerywan target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://emery.letout.cn target=_blank title=Home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-smart-home" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#6f32be" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19 8.71l-5.333-4.148a2.666 2.666.0 00-3.274.0L5.059 8.71A2.665 2.665.0 004.03 10.815v7.2a2 2 0 002 2h12a2 2 0 002-2v-7.2c0-.823-.38-1.6-1.03-2.105"/><path d="M16 15c-2.21 1.333-5.792 1.333-8 0"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>é¦–é¡µ</span></a></li><li><a href=/blog/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>å…³äº</span></a></li><li><a href=/blog/categories/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg><span>åˆ†ç±»</span></a></li><li><a href=/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>å½’æ¡£</span></a></li><li><a href=/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>æœç´¢</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>ğŸŒ— Dark</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/p/kafka/operation/><img src=/blog/p/kafka/operation/1_hu7e5e6f704cbbe344fcb15d211398a1e1_48507_800x0_resize_box_3.png srcset="/blog/p/kafka/operation/1_hu7e5e6f704cbbe344fcb15d211398a1e1_48507_800x0_resize_box_3.png 800w, /blog/p/kafka/operation/1_hu7e5e6f704cbbe344fcb15d211398a1e1_48507_1600x0_resize_box_3.png 1600w" width=800 height=433 loading=lazy alt="Featured image of post Kafka æ“ä½œï¼ˆDoingï¼‰"></a></div><div class=article-details><header class=article-category><a href=/blog/categories/%E6%8A%80%E6%9C%AF/ style=background-color:#91d5ff;color:#fff>æŠ€æœ¯</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/kafka/operation/>Kafka æ“ä½œï¼ˆDoingï¼‰</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>03 - 26, 2023</time></div></footer></div></header><section class=article-content><h2 id=å‘½ä»¤è¡Œå·¥å…·>å‘½ä»¤è¡Œå·¥å…·</h2><p>Kafka æä¾›äº†ä¸€äº›åŸºäºè„šæœ¬çš„å‘½åè¡Œå·¥å…· <code>${dir}/bin/xxx.sh</code>ï¼Œç”¨äºç®¡ç†é›†ç¾¤ã€‚è¿™äº›ç®¡ç†é€šè¿‡ Java ç±»å®ç°ï¼Œé€šè¿‡è„šæœ¬è°ƒç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># å¯åŠ¨ Zookeeper æœåŠ¡ï¼ˆæ–°ç‰ˆå·²å†…ç½®ï¼‰</span>
</span></span><span class=line><span class=cl>bin/zookeeper-server-start.sh config/zeekeeper.properties
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯åŠ¨ Kafka æœåŠ¡</span>
</span></span><span class=line><span class=cl>bin/kafka-server-start.sh config/server.properties
</span></span></code></pre></td></tr></table></div></div><blockquote><p>ğŸ” æ›´å¤š CLI æ“ä½œï¼š<a class=link href=https://www.conduktor.io/kafka/kafka-topics-cli-tutorial/ target=_blank rel=noopener>ğŸŒ https://www.conduktor.io/kafka/kafka-topics-cli-tutorial/</a></p></blockquote><h3 id=topic-æ“ä½œ>Topic æ“ä½œ</h3><p>Kafka å¤§éƒ¨åˆ†å‘½ä»¤è¡Œå·¥å…·ç›´æ¥æ“ä½œ Zookeeper ä¸Šçš„å…ƒæ•°æ®ï¼Œå¹¶ä¸ä¼šç›´æ¥è¿æ¥åˆ° Broker ä¸Šï¼Œéœ€è¦ç¡®ä¿æ‰€ä½¿ç”¨çš„å·¥å…·ç‰ˆæœ¬ä¸é›†ç¾¤ä¸­çš„ Broker ç‰ˆæœ¬ç›¸åŒ¹é…ã€‚</p><blockquote><p>ğŸ—ï¸</p><p>Kafka 2.2+ ä½¿ç”¨ Kafka çš„ hostname & port è¿›è¡Œæ“ä½œ <code>--bootstrap-server 127.0.0.1:9092</code></p><p>æ—§ç‰ˆæœ¬ä½¿ç”¨ Zookeeper çš„ URL & port è¿›è¡Œæ“ä½œ <code>--zookeeper 127.0.0.1:2181</code></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># åˆ›å»ºä¸»é¢˜</span>
</span></span><span class=line><span class=cl><span class=c1># 2.2 +</span>
</span></span><span class=line><span class=cl>kafka-topics.sh --bootstrap-server localhost:9092 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --create <span class=se>\ </span>
</span></span><span class=line><span class=cl>                --topic first_topic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --partitions <span class=m>3</span> <span class=se>\ </span> <span class=c1># åˆ†åŒºæ•°é‡</span>
</span></span><span class=line><span class=cl>                --replication-factor <span class=m>1</span>  <span class=c1># å‰¯æœ¬æ•°é‡</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># old</span>
</span></span><span class=line><span class=cl>kafka-topics.sh --zookeeper localhost:2181 --topic first_topic --create --partitions <span class=m>3</span> --replication-factor <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># åˆ—å‡ºä¸»é¢˜</span>
</span></span><span class=line><span class=cl><span class=c1># 2.2 + </span>
</span></span><span class=line><span class=cl>kafka-topics.sh --bootstrap-server localhost:9092 --list
</span></span><span class=line><span class=cl><span class=c1># è¯¦ç»†ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>kafka-topics.sh --bootstrap-server localhost:9092 --describe --topic first_topic
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ä¿®æ”¹ä¸»é¢˜</span>
</span></span><span class=line><span class=cl>kafka-topics.sh --bootstrap-server localhost:9092 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --alter <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --topic first_topic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                --partitions <span class=m>5</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ç”Ÿäº§--æ¶ˆè´¹>ç”Ÿäº§ & æ¶ˆè´¹</h3><blockquote><p>ğŸ—ï¸ Producer</p><p>Kafka 2.5+ ä½¿ç”¨ <code>--bootstrap-server</code></p><p>æ—§ç‰ˆæœ¬ Kafka ä½¿ç”¨ <code>--broker-list</code></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ç”Ÿäº§</span>
</span></span><span class=line><span class=cl>kafka-console-producer.sh --bootstrap-server localhost:9092 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                          --topic first_topic
</span></span></code></pre></td></tr></table></div></div><blockquote><p>ğŸ—ï¸ Consumer</p><p>ä½¿ç”¨ <code>--bootstrap-server</code>ï¼Œè‡ª v0.10 å¼€å§‹ <code>--zookeeper</code> å·²è¢«åºŸå¼ƒ</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kafka-console-consumer.sh --bootstrap-server localhost:9092 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                          --topic first_topic
</span></span></code></pre></td></tr></table></div></div><h2 id=-producer>ğŸ¤² Producer</h2><h3 id=-ç”Ÿäº§è€…>ğŸˆ ç”Ÿäº§è€…</h3><ul><li>ğŸ§© <code>ProducerRecord</code> å¯¹è±¡åŒ…å«ç›®æ ‡ä¸»é¢˜ Topic å’Œéœ€è¦å‘é€çš„å†…å®¹ Valueï¼Œå¯ä»¥å¯ä»¥æŒ‡å®šåˆ†åŒº Partition å’Œé”®å€¼ Keyï¼ˆæ¶ˆæ¯çš„é™„åŠ ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥å†³å®šæ¶ˆæ¯è¢«å†™å…¥å“ªä¸ªåˆ†åŒºï¼Œç›¸åŒ Key çš„æ¶ˆæ¯ä¼šå†™å…¥åŒä¸€ä¸ªåˆ†åŒºï¼‰</li><li>ğŸ§© å‘é€æ¶ˆæ¯æ—¶ï¼Œç”Ÿäº§è€…éœ€è¦å°† <code>ProducerRecord</code> å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œåœ¨ç½‘ç»œä¸Šä¼ è¾“</li><li>ğŸ§© æ•°æ®è¢«ä¼ é€ç»™åˆ†åŒºå™¨ <code>Partitioner</code>ï¼Œå¦‚æœæŒ‡å®šäº†åˆ†åŒºï¼Œä¼šç›´æ¥è¿”å›ï¼›æ²¡æœ‰æŒ‡å®šï¼Œæ ¹æ® Key é€‰æ‹©ä¸€ä¸ªåˆ†åŒºï¼›æ²¡æœ‰æŒ‡å®š Keyï¼Œä¼šæ ¹æ® Value è¿›è¡Œæ•£åˆ—ï¼Œæ ¹æ®æ•£åˆ—å€¼æŠŠæ¶ˆæ¯æ˜ å°„åˆ°ç›¸åº”çš„åˆ†åŒº</li><li>ğŸ§© è¿™æ¡è®°å½•é€‰å¥½åˆ†åŒºåï¼Œä¼šè¢«æ·»åŠ åˆ°ä¸€ä¸ªè®°å½•æ‰¹æ¬¡ä¸­ï¼Œè¿™ä¸ªæ‰¹æ¬¡çš„æ‰€æœ‰æ¶ˆæ¯ä¼šè¢«å‘é€åˆ°ç›¸åŒçš„ä¸»é¢˜å’Œåˆ†åŒºä¸Šï¼ˆæ‰¹å¤„ç†ï¼‰ï¼Œç‹¬ç«‹çš„ <code>Processer</code> çº¿ç¨‹ä¼šè´Ÿè´£æŠŠè¿™äº›æ•°æ®å‘é€åˆ°å¯¹åº”çš„ broker ä¸Š</li><li>ğŸ§© Broker æ”¶åˆ°æ¶ˆæ¯æ—¶ä¼šè¿”å›ä¸€ä¸ªå“åº”<ul><li>æ¶ˆæ¯æˆåŠŸå†™å…¥ Kafkaï¼Œè¿”å›ä¸€ä¸ª <code>RecordMetaData</code> å¯¹è±¡ï¼ŒåŒ…å«ä¸»é¢˜å’Œåˆ†åŒºçš„ä¿¡æ¯</li><li>å†™å…¥å¤±è´¥ï¼Œä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œç”Ÿäº§è€…æ”¶åˆ°é”™è¯¯ä¹‹åä¼šå°è¯•é‡æ–°å‘é€ï¼Œå¤šæ¬¡å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯</li></ul></li></ul><p><img src=/blog/p/kafka/operation/producer.webp width=780 height=678 srcset="/blog/p/kafka/operation/producer_huebfba9d061e763283d9c37fc8487b94d_24528_480x0_resize_q75_h2_box_2.webp 480w, /blog/p/kafka/operation/producer_huebfba9d061e763283d9c37fc8487b94d_24528_1024x0_resize_q75_h2_box_2.webp 1024w" loading=lazy class=gallery-image data-flex-grow=115 data-flex-basis=276px></p><h4 id=é‡è¦é…ç½®>é‡è¦é…ç½®</h4><ul><li><p><code>acks</code></p><p>æŒ‡å®šäº†å¿…é¡»è¦æœ‰å¤šå°‘ä¸ªåˆ†åŒºå‰¯æœ¬æ”¶åˆ°æ¶ˆæ¯ï¼Œç”Ÿäº§è€…æ‰ä¼šä»»åŠ¡æ¶ˆæ¯å†™å…¥æ—¶æˆåŠŸçš„</p><ul><li><code>acks=0</code> ä¸ä¼šç­‰å¾…ä»»åŠ¡æ¥è‡ªæœåŠ¡å™¨çš„å“åº”ã€‚è¾¾åˆ°æœ€é«˜çš„ååé‡ï¼Œæ— æ³•å¾—çŸ¥æ¶ˆæ¯çŠ¶æ€ã€‚</li><li><code>acks=1</code> åªè¦ Partition Leader æ”¶åˆ°å“åº”ã€‚æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ï¼ŒLeaderå®•æœºåï¼Œä¸€ä¸ªæœªåŒæ­¥çš„Flloweræˆä¸ºæ–°çš„Leaderã€‚</li><li><code>acks=all</code> æ¶ˆæ¯è¦å…¨éƒ¨åŒæ­¥åˆ°æ‰€æœ‰çš„ Leader&amp;Fllowerã€‚</li></ul></li><li><p><code>retries</code></p><p>ç”Ÿäº§è€…å¯ä»¥é‡å‘æ¶ˆæ¯çš„æ¬¡æ•°</p></li><li><p><code>max.in.flight.requests.per.connection</code></p><p>ç”Ÿäº§è€…åœ¨æ”¶åˆ°æœåŠ¡å™¨å“åº”å‰å¯ä»¥å‘é€å¤šå°‘ä¸ªæ¶ˆæ¯ã€‚</p><p>Kafka å¯ä»¥ä¿è¯åŒä¸€ä¸ªåˆ†åŒºé‡Œçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼Œ<code>max.in.flight.requests.per.connection=1</code>ï¼Œå³ä½¿å‘é€äº†é‡è¯•ï¼Œæ¶ˆæ¯ä¾æ—§æœ‰åºï¼Œä½†æ˜¯ä¼šä¸¥é‡å½±å“ç”Ÿäº§è€…çš„ååé‡ã€‚</p></li></ul><h3 id=-åŒæ­¥å‘é€>ğŸˆâ€â¬› åŒæ­¥å‘é€</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Future</span><span class=o>&lt;</span><span class=n>RecordMetadata</span><span class=o>&gt;</span> <span class=nf>send</span><span class=o>(</span><span class=n>ProducerRecord</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span> <span class=n>V</span><span class=o>&gt;</span> <span class=n>record</span><span class=o>)</span> <span class=o>{</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨ <code>send()</code> æ–¹æ³•å‘é€æ¶ˆæ¯ï¼Œä¼šè¿”å›ä¸€ä¸ª Future å¯¹è±¡ï¼Œè°ƒç”¨ <code>get()</code> æ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œå°±å¯ä»¥çŸ¥é“æ¶ˆæ¯æ˜¯å¦å‘é€æˆåŠŸã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ç›¸å…³é…ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>String</span> <span class=n>bootstrapServers</span> <span class=o>=</span> <span class=s>&#34;127.0.0.1:9092&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>Properties</span> <span class=n>properties</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ProducerConfig</span><span class=o>.</span><span class=na>BOOTSTRAP_SERVERS_CONFIG</span><span class=o>,</span> <span class=n>bootstrapServers</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ProducerConfig</span><span class=o>.</span><span class=na>KEY_SERIALIZER_CLASS_CONFIG</span><span class=o>,</span> <span class=n>StringSerializer</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>  <span class=c1>// åºåˆ—åŒ–æ–¹å¼
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ProducerConfig</span><span class=o>.</span><span class=na>VALUE_SERIALIZER_CLASS_CONFIG</span><span class=o>,</span> <span class=n>StringSerializer</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åˆ›å»º Producer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>KafkaProducer</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>producer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>KafkaProducer</span><span class=o>&lt;&gt;(</span><span class=n>properties</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åˆ›å»ºæ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ProducerRecord</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>producerRecord</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ProducerRecord</span><span class=o>&lt;&gt;(</span><span class=s>&#34;demo_topic&#34;</span><span class=o>,</span> <span class=s>&#34;hello world!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å‘é€æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>producer</span><span class=o>.</span><span class=na>send</span><span class=o>(</span><span class=n>record</span><span class=o>).</span><span class=na>get</span><span class=o>();</span>  <span class=c1>// get() åŒæ­¥
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>  <span class=c1>// å‘ç”Ÿäº†æ— æ³•è§£å†³çš„é”™è¯¯ æˆ– é‡è¯•è¶…è¿‡æœ€å¤§æ¬¡æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=-å¼‚æ­¥å‘é€>ğŸ… å¼‚æ­¥å‘é€</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Future</span><span class=o>&lt;</span><span class=n>RecordMetadata</span><span class=o>&gt;</span> <span class=nf>send</span><span class=o>(</span><span class=n>ProducerRecord</span><span class=o>&lt;</span><span class=n>K</span><span class=o>,</span> <span class=n>V</span><span class=o>&gt;</span> <span class=n>record</span><span class=o>,</span> <span class=n>Callback</span> <span class=n>callback</span><span class=o>)</span> <span class=o>{</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è°ƒç”¨ <code>send()</code> æ–¹æ³•ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ŒæœåŠ¡å™¨åœ¨è¿”å›å“åº”æ—¶è°ƒç”¨è¯¥å‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>producer</span><span class=o>.</span><span class=na>send</span><span class=o>(</span><span class=n>producerRecord</span><span class=o>,</span> <span class=k>new</span> <span class=n>Callback</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onCompletion</span><span class=o>(</span><span class=n>RecordMetadata</span> <span class=n>recordMetadata</span><span class=o>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// å‘é€å¤±è´¥
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// å¯¹åº”çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>});</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=-åºåˆ—åŒ–å™¨>ğŸ† åºåˆ—åŒ–å™¨</h3><p>å¸¸è§çš„åºåˆ—åŒ–&ååºåˆ—åŒ–å™¨æœ‰ Avroã€Thriftã€Protobuf ç­‰ã€‚</p><p>Apache <a class=link href=https://zhuanlan.zhihu.com/p/370519371 target=_blank rel=noopener>Avro</a> æ˜¯ä¸€ç§ä¸ç¼–ç¨‹è¯­è¨€æ— å…³çš„åºåˆ—åŒ–æ ¼å¼ã€‚</p><p>Avro é€šè¿‡ä¸è¯­è¨€æ— å…³çš„ schema æ¥å®šä¹‰ï¼Œä½¿ç”¨ JSON æ¥æè¿°ï¼Œæ•°æ®ä¼šè¢«åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶æˆ– JSON æ–‡ä»¶ã€‚</p><p>æ»¡è¶³ Avro å…¼å®¹åŸåˆ™ä¸‹ï¼Œå†™å…¥çš„æ¶ˆæ¯æ”¹åŠ¨ schema å†™å…¥äº†æ–°çš„æ•°æ®ï¼Œè´Ÿè´£è¯»æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºå¯ä»¥ç»§ç»­å¤„ç†è€Œæ— éœ€åšä»»ä½•æ›´æ”¹ã€‚</p><h3 id=-åˆ†åŒº>ğŸ• åˆ†åŒº</h3><p><code>ProducerRecord</code> å¯¹è±¡å¯ä»¥åŒ…å« topicã€partitionã€keyã€value ç­‰ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šæŒ‡å®š keyï¼Œä½œä¸ºé™„åŠ æ¶ˆæ¯ï¼Œå†³å®šæ¶ˆæ¯è¯¥è¢«å†™å…¥å“ªä¸ªåˆ†åŒºï¼Œæ‹¥æœ‰ç›¸åŒ key çš„æ¶ˆæ¯ä¼šè¢«å†™å…¥åŒä¸€ä¸ªåˆ†åŒºã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// topic: CustomerCountry
</span></span></span><span class=line><span class=cl><span class=c1>// key: Laboratory Equipment
</span></span></span><span class=line><span class=cl><span class=c1>// value: USA
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ProducerRecord</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>record</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ProducerRecord</span><span class=o>&lt;&gt;(</span><span class=s>&#34;CustomerConuntry&#34;</span><span class=o>,</span> <span class=s>&#34;Laboratory Equipment&#34;</span><span class=o>,</span> <span class=s>&#34;USA&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åˆ›å»º key-&gt;null çš„æ¶ˆæ¯
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ProducerRecord</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>record</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ProducerRecord</span><span class=o>&lt;&gt;(</span><span class=s>&#34;CustomerCountry&#34;</span><span class=o>,</span> <span class=s>&#34;USA&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“ key ä¸º null æ—¶ï¼ŒKafka ä¼šå¯¹é”®è¿›è¡Œæ•£åˆ—ï¼ˆKafka è‡ªå·±çš„æ•£åˆ—ç®—æ³•ï¼‰ï¼Œç„¶åæ ¹æ®æ•£åˆ—å€¼æ˜ å°„åˆ°ç‰¹æ®Šçš„åˆ†åŒºã€‚</p><h4 id=è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥</h4><p>é€šè¿‡å®ç° <code>interface Partitioner</code> å®ç°è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼Œä¸»è¦åŒ…å«ï¼š</p><ul><li><code>void configure(Map&lt;String, ?> configs)</code><ul><li>å®é™…åº”ç”¨ä¸­ï¼Œåº”é€šè¿‡è¯¥æ–¹æ³•ä¼ å…¥ç›¸å…³ä¿¡æ¯</li></ul></li><li><code>void partition(String topic, Object key, byte[] keyBytes, Object value, byte[] valueBytes, Cluster cluster)</code></li><li><code>void close()</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BananaPartitioner</span> <span class=kd>implements</span> <span class=n>Partitioner</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=o>?&gt;</span> <span class=n>configs</span><span class=o>)</span> <span class=o>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=nf>partition</span><span class=o>(</span><span class=n>String</span> <span class=n>topic</span><span class=o>,</span> <span class=n>Object</span> <span class=n>key</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>keyBytes</span><span class=o>,</span> <span class=n>Object</span> <span class=n>value</span><span class=o>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>valueBytes</span><span class=o>,</span> <span class=n>Cluster</span> <span class=n>cluster</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>PartitionInfo</span><span class=o>&gt;</span> <span class=n>partitions</span> <span class=o>=</span> <span class=n>cluster</span><span class=o>.</span><span class=na>partitionsForTopic</span><span class=o>(</span><span class=n>topic</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>numPartitions</span> <span class=o>=</span> <span class=n>partition</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>((</span><span class=n>keyBytes</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>||</span> <span class=o>(!(</span><span class=n>key</span> <span class=n>instanceOf</span> <span class=n>String</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidRecordException</span><span class=o>(</span><span class=s>&#34;We expect all messages to have customer name as key&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(((</span><span class=n>String</span><span class=o>)</span> <span class=n>key</span><span class=o>).</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;Banana&#34;</span><span class=o>))</span> <span class=o>{</span>  <span class=c1>// Banana æ€»æ˜¯è¢«åˆ†é…åˆ°æœ€åä¸€ä¸ªåˆ†åŒº
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=n>numPartitions</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å…¶å®ƒè®°å½•è¢«æ•£åˆ—åˆ°å…¶ä»–åˆ†åŒº
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>((</span><span class=n>Math</span><span class=o>.</span><span class=na>abs</span><span class=o>(</span><span class=n>Utils</span><span class=o>.</span><span class=na>murmur2</span><span class=o>(</span><span class=n>keyBytes</span><span class=o>)))</span> <span class=o>%</span> <span class=o>(</span><span class=n>numPartitions</span> <span class=o>-</span> <span class=n>1</span><span class=o>));</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>close</span><span class=o>()</span> <span class=o>{</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=-consumer>ğŸ‘Œ Consumer</h2><h3 id=-æ¶ˆè´¹è€…ç»„>ğŸ¦œ æ¶ˆè´¹è€…ç»„</h3><h3 id=-æ¶ˆæ¯è½®è¯¢>ğŸ¦š æ¶ˆæ¯è½®è¯¢</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// é…ç½®
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>String</span> <span class=n>bootstrapServers</span> <span class=o>=</span> <span class=s>&#34;127.0.0.1:9092&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>groupId</span> <span class=o>=</span> <span class=s>&#34;demo_groupId&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>topic</span> <span class=o>=</span> <span class=s>&#34;demo_topic&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>Properties</span> <span class=n>properties</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ConsumerConfig</span><span class=o>.</span><span class=na>BOOTSTRAP_SERVERS_CONFIG</span><span class=o>,</span> <span class=n>bootstrapServers</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ConsumerConfig</span><span class=o>.</span><span class=na>KEY_DESERIALIZER_CLASS_CONFIG</span><span class=o>,</span> <span class=n>StringDeserializer</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ConsumerConfig</span><span class=o>.</span><span class=na>VALUE_DESERIALIZER_CLASS_CONFIG</span><span class=o>,</span> <span class=n>StringDeserializer</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ConsumerConfig</span><span class=o>.</span><span class=na>GROUP_ID_CONFIG</span><span class=o>,</span> <span class=n>groupId</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>properties</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=n>ConsumerConfig</span><span class=o>.</span><span class=na>AUTO_OFFSET_RESET_CONFIG</span><span class=o>,</span> <span class=s>&#34;earliest&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åˆ›å»ºæ¶ˆè´¹è€…
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>KafkaConsumer</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>consumer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>KafkaConsumer</span><span class=o>&lt;&gt;(</span><span class=n>properties</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è®¢é˜…ä¸»é¢˜
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>consumer</span><span class=o>.</span><span class=na>subscribe</span><span class=o>(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=n>topic</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è½®è¯¢ 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>while</span><span class=o>(</span><span class=kc>true</span><span class=o>){</span>
</span></span><span class=line><span class=cl>  <span class=n>ConsumerRecords</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>records</span> <span class=o>=</span> <span class=n>consumer</span><span class=o>.</span><span class=na>poll</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=n>100</span><span class=o>));</span>  <span class=c1>// 100 -&gt; è¶…æ—¶æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=n>ConsumerRecord</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>record</span> <span class=o>:</span> <span class=n>records</span><span class=o>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸šåŠ¡å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Key: &#34;</span> <span class=o>+</span> <span class=n>record</span><span class=o>.</span><span class=na>key</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;, Value: &#34;</span> <span class=o>+</span> <span class=n>record</span><span class=o>.</span><span class=na>value</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Partition: &#34;</span> <span class=o>+</span> <span class=n>record</span><span class=o>.</span><span class=na>partition</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;, Offset:&#34;</span> <span class=o>+</span> <span class=n>record</span><span class=o>.</span><span class=na>offset</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¶ˆæ¯è½®è¯¢æ˜¯æ¶ˆè´¹è€… API çš„æ ¸å¿ƒï¼Œä¸€æ—¦æ¶ˆè´¹è€…è®¢é˜…çš„ä¸»é¢˜ï¼Œè½®è¯¢ä¼šå¤„ç†æ‰€æœ‰çš„ç»†èŠ‚ã€‚
<code>poll()</code> ä¼šè´Ÿè´£æŸ¥æ‰¾ GroupCordinatorï¼ŒåŠ å…¥ç¾¤ç»„ï¼Œæ¥å—åˆ†é…çš„åˆ†åŒºï¼Œå‘é€å¿ƒè·³å’Œè·å–æ•°æ®ã€‚å¦‚æœå‘ç”Ÿäº†å†å‡è¡¡ï¼Œä¹Ÿæ˜¯è¿™ä¸ªè½®è¯¢æœŸé—´è¿›è¡Œçš„ã€‚</p><p>âš ï¸ æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…åªèƒ½è¿è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚å¦‚æœéœ€è¦å¤šä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ª Patition ä¸­çš„æ¶ˆæ¯ï¼Œå¯ä»¥å°†è¿™ä¸ªæ¶ˆè´¹è€…è·å–çš„ä¸€æ‰¹æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ ExecutorService å¯åŠ¨å¤šä¸ªçº¿ç¨‹å¤„ç†ã€‚</p><h3 id=-åç§»é‡>ğŸ¦‰ åç§»é‡</h3><p>Kafka ä½¿ç”¨åç§»é‡ offset è¿½è¸ªæ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„ä½ç½®ã€‚</p><p>Consumer å‘ä¸€ä¸ªç‰¹æ®Šçš„ä¸»é¢˜ <code>_consumer_offset</code> å‘é€æ¶ˆæ¯ï¼Œæ›´æ–°åˆ†åŒºå½“å‰çš„ä½ç½®ã€‚</p><ul><li>å¦‚æœæäº¤çš„ offsetã€Œå°äºã€å®¢æˆ·ç«¯å¤„ç†çš„æœ€åä¸€ä¸ªæ¶ˆæ¯åç§»é‡ï¼Œé‚£ä¹ˆã€Œä¸¤ä¸ªåç§»é‡ä¹‹é—´çš„æ¶ˆæ¯ä¼šè¢«é‡å¤å¤„ç†ã€</li></ul><p><img src=/blog/p/kafka/operation/offset1.png width=978 height=422 srcset="/blog/p/kafka/operation/offset1_hu7de55e7adbd4de02cc42f3a04ca7fa88_35082_480x0_resize_box_3.png 480w, /blog/p/kafka/operation/offset1_hu7de55e7adbd4de02cc42f3a04ca7fa88_35082_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=231 data-flex-basis=556px></p><ul><li>å¦‚æœæäº¤çš„ offsetã€Œå¤§äºã€å®¢æˆ·ç«¯å¤„ç†çš„æœ€åä¸€ä¸ªæ¶ˆæ¯åç§»é‡ï¼Œé‚£ä¹ˆã€Œä¸¤ä¸ªåç§»é‡ä¹‹é—´çš„æ¶ˆæ¯ä¼šä¸¢å¤±ã€</li></ul><p><img src=/blog/p/kafka/operation/offset2.png width=979 height=485 srcset="/blog/p/kafka/operation/offset2_hu389bebeaa08efdc7ddfc7a71cffd3a76_34010_480x0_resize_box_3.png 480w, /blog/p/kafka/operation/offset2_hu389bebeaa08efdc7ddfc7a71cffd3a76_34010_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=201 data-flex-basis=484px></p><h4 id=è‡ªåŠ¨æäº¤>è‡ªåŠ¨æäº¤</h4><p>å¦‚æœ <code>enable.auto.commit = true</code>ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æŠŠä» <code>poll()</code> æ–¹æ³•æ¥æ”¶åˆ°çš„æœ€å¤§åç§»é‡æäº¤ä¸Šå»ã€‚æäº¤çš„æ—¶é—´é—´éš”ç”± <code>auto.commit.interval.ms</code> æ§åˆ¶ï¼Œé»˜è®¤ä¸º 5sã€‚</p><p>è‡ªåŠ¨æäº¤å‘ç”Ÿåœ¨æ¯æ¬¡è½®è¯¢æ—¶ï¼Œå¦‚æœæ²¡æœ‰æäº¤åç§»é‡ï¼Œä¼šæŠŠä¸Šä¸€æ¬¡è°ƒç”¨è¿”å›çš„åç§»é‡æäº¤ä¸Šå»ï¼Œã€Œä¸èƒ½ä¿è¯è¿™äº›æ¶ˆæ¯å·²ç»è¢«ä¸šåŠ¡å¤„ç†äº†ã€ã€‚</p><p>âš ï¸ å¦‚æœè®¾ç½®é»˜è®¤æäº¤æ—¶é—´ä¸º 5sï¼Œåœ¨æäº¤å 3s å‘ç”Ÿäº†å†å‡è¡¡ï¼Œä¹‹åçš„æ¶ˆè´¹è€…ä¼šå†æ¬¡è·å–åˆ° 3s å‰æäº¤çš„åç§»é‡ï¼Œè¿™äº›æ¶ˆæ¯ä¼šè¢«é‡å¤å¤„ç†ï¼Œã€Œæ— æ³•é¿å…è¿™ç§æƒ…å†µã€ï¼Œåªèƒ½ç¼©å°æäº¤çš„æ—¶é—´é—´éš”æ›´é¢‘ç¹åœ°æäº¤ offsetï¼Œã€ŒKafka ä¹Ÿæ²¡æœ‰ä¸ºè‡ªåŠ¨æäº¤é¢„ç•™é¿å…é‡å¤å¤„ç†æ¶ˆæ¯çš„æ–¹æ³•ã€ã€‚</p><p>é€‚åˆäºä¸é‡è¦çš„æ¶ˆæ¯åœºæ™¯ï¼Œå¦‚æ—¥å¿—é‡‡é›†ã€‚</p><h4 id=åŒæ­¥æäº¤>åŒæ­¥æäº¤</h4><p>è®¾ç½® <code>auto.commit.offset = false</code>ï¼Œå¯ä»¥è®©åº”ç”¨ç¨‹åºå†³å®šåœ¨ä»€ä¹ˆæ—¶å€™æäº¤åç§»é‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ConsumerRecords</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>records</span> <span class=o>=</span> <span class=n>consumer</span><span class=o>.</span><span class=na>poll</span><span class=o>(</span><span class=n>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=o>(</span><span class=n>ConsumerRecord</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>record</span> <span class=o>:</span> <span class=n>records</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å¤„ç†ä¸šåŠ¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>consumer</span><span class=o>.</span><span class=na>commitSync</span><span class=o>();</span>  <span class=c1>// æ‰‹åŠ¨æäº¤
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>CommitFailedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;commit failed&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åªè¦æ²¡æœ‰å‘ç”Ÿä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œ<code>commitSync()</code> æ–¹æ³•ä¼šã€Œä¸€ç›´å°è¯•ç›´åˆ°æäº¤æˆåŠŸä¸ºæ­¢ã€ã€‚å¦‚æœæäº¤å¤±è´¥ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><h4 id=å¼‚æ­¥æäº¤>å¼‚æ­¥æäº¤</h4><p>ä½¿ç”¨å¼‚æ­¥æäº¤ APIï¼Œåªç®¡å‘é€æäº¤è¯·æ±‚ï¼Œæ— éœ€ç­‰å¾… Broker çš„å“åº”ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>consumer</span><span class=o>.</span><span class=na>commitAsync</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>åŒæ­¥æäº¤ <code>commitSync()</code> ä¼šä¸€ç›´é‡è¯•ï¼Œä½†æ˜¯å¼‚æ­¥æäº¤ <code>commitAsync()</code>ã€Œä¸ä¼šé‡è¯•ã€ã€‚ä¸è¿›è¡Œé‡è¯•ï¼Œæ˜¯å› ä¸ºåœ¨æ”¶åˆ°æœåŠ¡å™¨å“åº”çš„æ—¶å€™ï¼Œå¯èƒ½æœ‰ä¸€ä¸ªæ›´å¤§çš„ offset å·²ç»æäº¤æˆåŠŸã€‚</p><p>å¼‚æ­¥æäº¤åŒæ ·æ”¯æŒå›è°ƒã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>consumer</span><span class=o>.</span><span class=na>commitAsync</span><span class=o>(</span><span class=k>new</span> <span class=n>OffsetCommitCallback</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onComplete</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>TopicPartition</span><span class=o>,</span> <span class=n>OffsetAndMetadata</span><span class=o>&gt;</span> <span class=n>offsets</span><span class=o>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// å¼‚æ­¥æäº¤å¤±è´¥
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// ... ä¸šåŠ¡å¤„ç† / é‡è¯•
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¼‚æ­¥æäº¤é‡è¯•ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå•è°ƒé€’å¢çš„åºåˆ—å·ç»´æŠ¤å¼‚æ­¥æäº¤çš„é¡ºåºã€‚åœ¨è¿›è¡Œé‡è¯•å‰ï¼Œå…ˆæ£€æŸ¥å›è°ƒåºåˆ—å·ä¸ç»´æŠ¤çš„åºåˆ—å·çš„å¤§å°ï¼Œå¦‚æœå›è°ƒåºåˆ—å·è¾ƒå¤§ï¼Œè¯´æ˜æœ‰ä¸€ä¸ªæ–°çš„æäº¤å·²ç»å‘é€ï¼Œä¸åº”è¯¥é‡è¯•ã€‚</p><h4 id=ç»„åˆæäº¤>ç»„åˆæäº¤</h4><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¶å°”çš„æäº¤å¤±è´¥ä¸è¿›è¡Œé‡è¯•æ²¡æœ‰å¤ªå¤§é—®é¢˜ï¼Œåªè¦åç»­æœ‰æ›´å¤§çš„ offset æˆåŠŸæäº¤ï¼Œå°±ä¸ä¼šæœ‰é—®é¢˜ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨æ¶ˆè´¹è€…å…³é—­å‰ï¼Œå¯ä»¥ç»„åˆä½¿ç”¨ä¸¤ç§æäº¤æ–¹å¼ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// æ¶ˆè´¹æ¶ˆæ¯ä¸šåŠ¡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>comsumer</span><span class=o>.</span><span class=na>commitAsync</span><span class=o>();</span>  <span class=c1>// å¼‚æ­¥æäº¤
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;Unexpected error&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span><span class=o>.</span><span class=na>commitSync</span><span class=o>();</span>  <span class=c1>// åŒæ­¥ï¼Œä¼šä¸æ–­é‡è¯•
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>consumer</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=æäº¤ç‰¹å®šåç§»é‡>æäº¤ç‰¹å®šåç§»é‡</h4><p>æ¯æ¬¡æ¶ˆè´¹è€… <code>poll()</code> çš„éƒ½æ˜¯ä¸€æ‰¹æ•°æ®ï¼Œ<code>commitSync() / commitAsync()</code> æ¯æ¬¡æäº¤éƒ½æ˜¯è¿™ä¸ªæ‰¹æ¬¡æœ€åçš„ offsetï¼Œå¦‚æœæƒ³è¦åœ¨æ‰¹æ¬¡ä¸­é—´æäº¤åç§»é‡ï¼Œå¯ä»¥ä¼ å…¥ã€Œå¸Œæœ›æäº¤çš„åˆ†åŒºå’Œåç§»é‡çš„ mapã€ã€‚</p><p>ä½†æ˜¯ï¼Œæ¶ˆè´¹è€…å¯èƒ½ä¸çŸ¥è¯»å–ä¸€ä¸ªåˆ†åŒºï¼Œè¿™æ ·åšéœ€è¦ã€Œè·Ÿè¸ªæ‰€æœ‰åˆ†åŒºçš„åç§»é‡ã€ï¼Œé€šå¸¸ä¼šä½¿ä»£ç å˜å¾—å¾ˆå¤æ‚ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>TopicPartition</span><span class=o>,</span> <span class=n>OffsetAndMetadata</span><span class=o>&gt;</span> <span class=n>currentOffsets</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ConsumerRecords</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>records</span> <span class=o>=</span> <span class=n>consumer</span><span class=o>.</span><span class=na>poll</span><span class=o>(</span><span class=n>100</span><span class=o>);</span>  <span class=c1>// å‡è®¾æ¯ä¸ªæ‰¹æ¬¡ 10000 æ¡æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=o>(</span><span class=n>ConsumerRecord</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>record</span> <span class=o>:</span> <span class=n>records</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸šåŠ¡å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>currentOffsets</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=k>new</span> <span class=n>TopicPartition</span><span class=o>(</span><span class=n>record</span><span class=o>.</span><span class=na>topic</span><span class=o>(),</span> <span class=n>record</span><span class=o>.</span><span class=na>partition</span><span class=o>()),</span> <span class=k>new</span> <span class=n>OffsetAndMetadata</span><span class=o>(</span><span class=n>record</span><span class=o>.</span><span class=na>offset</span><span class=o>()</span> <span class=o>+</span> <span class=n>1</span><span class=o>,</span>  <span class=s>&#34;no metadata&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>count</span> <span class=o>%</span> <span class=n>1000</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  <span class=c1>// åœ¨æ¯ä¸ªæ‰¹æ¬¡ä¸­ï¼Œæ²¡å¤„ç† 1000 æ¡æ•°æ®æäº¤ä¸€æ¬¡ offset
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>consumer</span><span class=o>.</span><span class=na>commitAsync</span><span class=o>(</span><span class=n>currentOffsets</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=-ç‰¹å®šoffsetå¼€å§‹å¤„ç†>ğŸ¦© ç‰¹å®šoffsetå¼€å§‹å¤„ç†</h3><p>å¦‚æœæƒ³è¦ä»åˆ†åŒºçš„èµ·å§‹/æœ«å°¾ä½ç½®è¯»å–æ¶ˆæ¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>seekToBeginning(Collection&lt;TopicPartition> tp)</code> å’Œ <code>seekToEnd(Collection&lt;TopicPartition>)</code></p><p>æœ‰æ—¶ï¼Œåœ¨ä¸šåŠ¡ä¸Šéœ€è¦ä»ç‰¹å®šçš„ offset å¼€å§‹è¯»å–æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>seek()</code> è¿›è¡ŒæŸ¥æ‰¾ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// class KafkaConsumer
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>seek</span><span class=o>(</span><span class=n>TopicPartition</span> <span class=n>partition</span><span class=o>,</span> <span class=kt>long</span> <span class=n>offset</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>seek</span><span class=o>(</span><span class=n>TopicPartition</span> <span class=n>partition</span><span class=o>,</span> <span class=n>OffsetAndMetadata</span> <span class=n>offsetAndMetadata</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¯”å¦‚åœ¨ä¸€äº›ä¸šåŠ¡ä¸­ï¼Œå¯¹æ‰€æœ‰çš„æ“ä½œéƒ½è¦è¿›è¡Œå¤„ç†ï¼Œä¸èƒ½ä¸¢å¤±æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆå¤±åè¦å°†ç»“æœè®°å½•åˆ°æ•°æ®åº“ã€NoSQL å­˜å‚¨å¼•æ“ç­‰åœ°æ–¹ï¼Œéœ€è¦å°†ã€Œä¿å­˜è®°å½•ã€ã€Œåç§»é‡ã€æ”¾åœ¨ä¸€ä¸ªåŸå­æ“ä½œé‡Œå®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚å¯ä»¥å°†è®°å½•å’Œåç§»é‡éƒ½ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œç”¨ä¸€ä¸ªäº‹åŠ¡æ“ä½œï¼Œä¿è¯åŸå­æ€§ã€‚å½“æ¶ˆè´¹è€…åˆ†é…æ–°åˆ†åŒºæ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>seek()</code> æŸ¥æ‰¾ä¿å­˜åœ¨æ•°æ®åº“ä¸­çš„æŒ‡å®šoffetäº†ï¼Œä¸ä¼šä¸¢å¤±æ•°æ®å’Œé‡å¤å¤„ç†ã€‚</p><h2 id=-connect>ğŸ–‡ï¸ Connect</h2><h2 id=-stream>ğŸ’¦ Stream</h2></section><footer class=article-footer><section class=article-tags><a href=/blog/tags/kafka/>Kafka</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/blog/p/kafka/more/><div class=article-image><img src=/blog/p/kafka/more/kafka.f51d5a89c2c23ba1c64e202666f73591_hua49c73262baf26feb83224ca97767fc9_25104_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy alt="Featured image of post æ·±å…¥ Kafka" data-key=/kafka/more data-hash="md5-9R1aicLCO6HGTiAmZvc1kQ=="></div><div class=article-details><h2 class=article-title>æ·±å…¥ Kafka</h2></div></a></article><article class=has-image><a href=/blog/p/kafka/><div class=article-image><img src=/blog/p/kafka/kafka.db4908225078178f01f03b9a6e00091d_hu0e688a86da638634e8e15b21ceb1a2b6_8026_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy alt="Featured image of post Kafka" data-key=/Kafka data-hash="md5-20kIIlB4F48B8DuabgAJHQ=="></div><div class=article-details><h2 class=article-title>Kafka</h2></div></a></article><article class=has-image><a href=/blog/p/mysql/innodb/buffer-pool/><div class=article-image><img src=/blog/p/mysql/innodb/buffer-pool/bufferpool.afc31921376eaf2e2d6bba9b82da6f9b_hu9753cf048aa8ef6ecf388c9b29af095f_8518_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy alt="Featured image of post InnoDB ç¼“å†²æ±  Buffer Pool" data-key=/mysql/innodb/buffer-pool data-hash="md5-r8MZITdury4ta7qbgtpvmw=="></div><div class=article-details><h2 class=article-title>InnoDB ç¼“å†²æ±  Buffer Pool</h2></div></a></article><article class=has-image><a href=/blog/p/design-pattern/observer/><div class=article-image><img src=/blog/p/design-pattern/observer/observer.d66f5921d7d3ecf6b53b22504fe1af1d_hua5fe444eaf0979d6378130641051be73_47507_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post è§‚å¯Ÿè€…æ¨¡å¼" data-key=/design-pattern/observer data-hash="md5-1m9ZIdfT7Pa1OyJQT+GvHQ=="></div><div class=article-details><h2 class=article-title>è§‚å¯Ÿè€…æ¨¡å¼</h2></div></a></article><article class=has-image><a href=/blog/p/distributed/transaction/><div class=article-image><img src=/blog/p/distributed/transaction/cap.656dd86f9115f93b7182f059d2fa5f8e_hu553ea908437f51f5f9df5986bc7065cb_18394_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy alt="Featured image of post åˆ†å¸ƒå¼äº‹åŠ¡" data-key=/distributed/transaction data-hash="md5-ZW3Yb5EV+TtxgvBZ0vpfjg=="></div><div class=article-details><h2 class=article-title>åˆ†å¸ƒå¼äº‹åŠ¡</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 ä¸€å±‚</section><section class=powerby><b><a href=http://beian.miit.gov.cn/ target=_blank rel="nofollow noopener">èµ£ICPå¤‡19004365å·-3</a></b><br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=%s>Stack</a></b> by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a><br></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#å‘½ä»¤è¡Œå·¥å…·>å‘½ä»¤è¡Œå·¥å…·</a><ol><li><a href=#topic-æ“ä½œ>Topic æ“ä½œ</a></li><li><a href=#ç”Ÿäº§--æ¶ˆè´¹>ç”Ÿäº§ & æ¶ˆè´¹</a></li></ol></li><li><a href=#-producer>ğŸ¤² Producer</a><ol><li><a href=#-ç”Ÿäº§è€…>ğŸˆ ç”Ÿäº§è€…</a><ol><li><a href=#é‡è¦é…ç½®>é‡è¦é…ç½®</a></li></ol></li><li><a href=#-åŒæ­¥å‘é€>ğŸˆâ€â¬› åŒæ­¥å‘é€</a></li><li><a href=#-å¼‚æ­¥å‘é€>ğŸ… å¼‚æ­¥å‘é€</a></li><li><a href=#-åºåˆ—åŒ–å™¨>ğŸ† åºåˆ—åŒ–å™¨</a></li><li><a href=#-åˆ†åŒº>ğŸ• åˆ†åŒº</a><ol><li><a href=#è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥</a></li></ol></li></ol></li><li><a href=#-consumer>ğŸ‘Œ Consumer</a><ol><li><a href=#-æ¶ˆè´¹è€…ç»„>ğŸ¦œ æ¶ˆè´¹è€…ç»„</a></li><li><a href=#-æ¶ˆæ¯è½®è¯¢>ğŸ¦š æ¶ˆæ¯è½®è¯¢</a></li><li><a href=#-åç§»é‡>ğŸ¦‰ åç§»é‡</a><ol><li><a href=#è‡ªåŠ¨æäº¤>è‡ªåŠ¨æäº¤</a></li><li><a href=#åŒæ­¥æäº¤>åŒæ­¥æäº¤</a></li><li><a href=#å¼‚æ­¥æäº¤>å¼‚æ­¥æäº¤</a></li><li><a href=#ç»„åˆæäº¤>ç»„åˆæäº¤</a></li><li><a href=#æäº¤ç‰¹å®šåç§»é‡>æäº¤ç‰¹å®šåç§»é‡</a></li></ol></li><li><a href=#-ç‰¹å®šoffsetå¼€å§‹å¤„ç†>ğŸ¦© ç‰¹å®šoffsetå¼€å§‹å¤„ç†</a></li></ol></li><li><a href=#-connect>ğŸ–‡ï¸ Connect</a></li><li><a href=#-stream>ğŸ’¦ Stream</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script></script></body></html>