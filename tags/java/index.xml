<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Java on ä¸€å±‚</title><link>https://emerywan.github.io/blog/tags/java/</link><description>Recent content in Java on ä¸€å±‚</description><generator>Hugo -- gohugo.io</generator><lastBuildDate>Fri, 02 Sep 2022 16:02:02 +0800</lastBuildDate><atom:link href="https://emerywan.github.io/blog/tags/java/index.xml" rel="self" type="application/rss+xml"/><item><title>ThreadLocal</title><link>https://emerywan.github.io/blog/p/thread/threadlocal/</link><pubDate>Fri, 02 Sep 2022 16:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/threadlocal/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/19.jpeg" alt="Featured image of post ThreadLocal" />&lt;h2 id="javalangthreadlocal">java.lang.ThreadLocal&lt;/h2>
&lt;p>ThreadLocal æ˜¯ä¸€ä¸ªåˆ›å»ºçº¿ç¨‹å±€éƒ¨å˜é‡çš„ç±»ã€‚&lt;/p>
&lt;p>é€šå¸¸åˆ›å»ºçš„å…±äº«å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ï¼Œå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªæœ‰å½“å‰çº¿ç¨‹æ‰å¯è®¿é—®ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•ä¿®æ”¹å’Œè®¿é—®ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DateUtils&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">ThreadLocal&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">DateFormat&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ThreadLocal&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é‡å†™ initialValue å¯è®¾ç½®åˆå§‹å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">protected&lt;/span> &lt;span class="n">DateFormat&lt;/span> &lt;span class="nf">initialValue&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SimpleDateFormat&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;yyyy-MM-dd&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">DateUtils&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Date&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åŽŸç†">åŽŸç†&lt;/h2>
&lt;p>æ¯ä¸€ä¸ªçº¿ç¨‹çš„ Thread å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ª &lt;code>ThreadLocal.ThreadLocalMap&lt;/code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å­˜å‚¨äº†ä¸€ç»„ä»¥ &lt;code>ThreadLocal.threadLocalHashCode&lt;/code> ä¸ºé”®ï¼Œä»¥æœ¬åœ°çº¿ç¨‹å˜é‡ä¸ºå€¼çš„ &lt;code>Key-Value&lt;/code> å¯¹ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/threadlocal/threadlocalmap.png"
width="561"
height="327"
srcset="https://emerywan.github.io/blog/blog/p/thread/threadlocal/threadlocalmap_hu2f3b0d366a0f121060908fa4912e4768_16111_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/threadlocal/threadlocalmap_hu2f3b0d366a0f121060908fa4912e4768_16111_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="threadlocalmap"
class="gallery-image"
data-flex-grow="171"
data-flex-basis="411px"
>&lt;/p>
&lt;p>&lt;code>ThreadLocal&lt;/code> å¯¹è±¡å°±æ˜¯å½“å‰çº¿ç¨‹çš„ &lt;code>ThreadLocalMap&lt;/code> çš„è®¿é—®å…¥å£ï¼Œæ¯ä¸€ä¸ª &lt;code>ThreadLocal&lt;/code> å¯¹è±¡éƒ½åŒ…å«äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ &lt;code>threadLocalHashCode&lt;/code> å€¼ï¼Œä½¿ç”¨è¿™ä¸ªå€¼ï¼Œå°±å¯ä»¥åœ¨çº¿ç¨‹ &lt;code>K-V&lt;/code> å€¼å¯¹ä¸­æ‰¾åˆ°å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹å˜é‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Thread&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">ThreadLocal&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ThreadLocalMap&lt;/span> &lt;span class="n">threadLocals&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ThreadLocal&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ThreadLocalMap&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Entry&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">WeakReference&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ThreadLocal&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Object&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Enrty&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ThreadLocal&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">super&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">Enrty&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="set">set()&lt;/h3>
&lt;ul>
&lt;li>èŽ·å–å½“å‰çº¿ç¨‹&lt;/li>
&lt;li>åˆ©ç”¨å½“å‰çº¿ç¨‹ä½œä¸ºå¥æŸ„ï¼ŒèŽ·å–ä¸€ä¸ª ThreadLocalMap å¯¹è±¡&lt;/li>
&lt;li>å¦‚æžœ ThreadLocalMap å¯¹è±¡ä¸ä¸ºç©ºï¼Œåˆ™è®¾ç½®å€¼ï¼Œå¦åˆ™åˆ›å»ºè¿™ä¸ª ThreadLocalMap å¯¹è±¡å¹¶è®¾ç½®å€¼&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">T&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ThreadLocalMap&lt;/span> &lt;span class="n">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">createMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">ThreadLocalMap&lt;/span> &lt;span class="nf">getMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">threadLocals&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">createMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">T&lt;/span> &lt;span class="n">firstValue&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">threadLocals&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ThreadLocalMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">firstValue&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="get">get()&lt;/h3>
&lt;ul>
&lt;li>èŽ·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶èŽ·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡&lt;/li>
&lt;li>å¦‚æžœå½“å‰çº¿ç¨‹çš„ ThreadLocalMap å·²ç»åˆå§‹åŒ–ï¼Œè¿”å›žå½“å‰ ThreadLocal ä¸º Key çš„å€¼&lt;/li>
&lt;li>å¦‚æžœ ThreadLocalMap æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œæˆ–è€…ä¸å­˜åœ¨ä»¥ ThreadLocal ä¸º Key çš„å€¼ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„ Valueï¼Œå¹¶è¿”å›ž&lt;/li>
&lt;li>initialValue é»˜è®¤ä¸º nullï¼Œå¯è¿›è¡Œé‡å†™&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ThreadLocal#get
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">public&lt;/span> &lt;span class="n">T&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ThreadLocalMap&lt;/span> &lt;span class="n">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ThreadLocalMap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getEntry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@SuppressWarnings&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;unchecked&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">T&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">setInitialValue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ThreadLocal#setInitialValue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">private&lt;/span> &lt;span class="n">T&lt;/span> &lt;span class="nf">setInitialValue&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">T&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">initialValue&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// èŽ·å¾—ä¸€ä¸ªåˆå§‹å€¼ï¼Œæœªé‡å†™é»˜è®¤ä¸º null
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">Thread&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ThreadLocalMap&lt;/span> &lt;span class="n">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">createMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ThreadLocal#initialValue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">protected&lt;/span> &lt;span class="n">T&lt;/span> &lt;span class="nf">initialValue&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// é»˜è®¤ä¸º nullï¼Œå¯è¢«é‡å†™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ThreadLocalMap#createMap
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">createMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">T&lt;/span> &lt;span class="n">firstValue&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">threadLocals&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ThreadLocalMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">firstValue&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="remove">remove()&lt;/h3>
&lt;ul>
&lt;li>é€šè¿‡è°ƒç”¨ ThreadLocalMap çš„ remove() æ–¹æ³•å®Œæˆç§»é™¤æ“ä½œ&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">remove&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ThreadLocalMap&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">m&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ThreadLocalMap remove()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ThreadLocal&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Entry&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">tab&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">threadLocalHashCode&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Entry&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nextIndex&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="o">)])&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">clear&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expungeStaleEntry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å†…å­˜æ³„éœ²">å†…å­˜æ³„éœ²&lt;/h2>
&lt;p>æŒ‡ç¨‹åºç”³è¯·å†…å­˜åŽï¼Œä¸€ç›´æ— æ³•é‡Šæ”¾å·²ç»ç”³è¯·çš„å†…å­˜ã€‚&lt;/p>
&lt;p>ThreadLocalMap ä½¿ç”¨ ThreadLocal çš„å¼±å¼•ç”¨ä½œä¸º keyï¼Œå¦‚æžœä¸€ä¸ª ThreadLocal ä¸å­˜åœ¨å¤–éƒ¨çš„å¼ºå¼•ç”¨æ—¶ï¼Œä¸‹æ¬¡ GC æ—¶ï¼Œè¯¥ key å°±ä¼šè¢«å›žæ”¶ï¼Œä½†æ˜¯ value è¿˜å­˜åœ¨ç€å¼ºå¼•ç”¨ï¼Œå¦‚æžœæ²¡æœ‰æ‰‹åŠ¨åœ° remove() æˆ–è€…çº¿ç¨‹ä¸€ç›´æ²¡æœ‰ç»“æŸï¼ˆä¾‹å¦‚ä½¿ç”¨çº¿ç¨‹æ± ï¼‰ï¼Œvalue å°±ä¼šä¸€ç›´å­˜åœ¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/threadlocal/threadlocal.png"
width="691"
height="425"
srcset="https://emerywan.github.io/blog/blog/p/thread/threadlocal/threadlocal_hu332fd7c00cd887225a3bcbd94cc1cc52_26526_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/threadlocal/threadlocal_hu332fd7c00cd887225a3bcbd94cc1cc52_26526_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="threadlocal"
class="gallery-image"
data-flex-grow="162"
data-flex-basis="390px"
>&lt;/p>
&lt;p>è§£å†³åŠžæ³•ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ¯æ¬¡ä½¿ç”¨å®ŒåŽè¿›è¡Œ remove()&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨ set()ã€get() æ—¶ï¼ˆéƒ¨åˆ†ï¼‰ï¼Œæ‰©å®¹ rehash() æ—¶ï¼ˆå…¨é‡ï¼‰ï¼Œä¼šåˆ¤æ–­å¯¹ key=null çš„è¿›è¡Œæ¸…ç†&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯ä»¥å°† ThreadLocal è®¾ç½®ä¸º staic final&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">rehash&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿›è¡Œå…¨é‡æ¸…ç†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">expungeStaleEntries&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">threshold&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">threshold&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">4&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">resize&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">expungeStaleEntries&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Entry&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">tab&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Entry&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="o">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">expungeStaleEntry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>çº¿ç¨‹èµ„æºæŒæœ‰ï¼Œä»£æ›¿å‚æ•°æ˜¾ç¤ºä¼ é€’&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å…¨å±€å­˜å‚¨ä¿¡æ¯ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹ç›´æŽ¥èŽ·å–&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè¾¾åˆ°çº¿ç¨‹éš”ç¦»&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>ðŸ”— &lt;a class="link" href="https://www.cnblogs.com/crazymakercircle/p/14491965.html#autoid-h2-2-0-0" target="_blank" rel="noopener"
>https://www.cnblogs.com/crazymakercircle/p/14491965.html#autoid-h2-2-0-0&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>JVM å†…å­˜åŒºåŸŸ</title><link>https://emerywan.github.io/blog/p/java/jvm/memory-area/</link><pubDate>Mon, 08 Aug 2022 15:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/java/jvm/memory-area/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/27.jpeg" alt="Featured image of post JVM å†…å­˜åŒºåŸŸ" />&lt;ul>
&lt;li>
&lt;p>çº¿ç¨‹éš”ç¦»&lt;/p>
&lt;ul>
&lt;li>ç¨‹åºè®¡æ•°å™¨&lt;/li>
&lt;li>è™šæ‹Ÿæœºæ ˆ&lt;/li>
&lt;li>æœ¬åœ°æ–¹æ³•æ ˆ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>çº¿ç¨‹å…±äº«&lt;/p>
&lt;ul>
&lt;li>æ–¹æ³•åŒº&lt;/li>
&lt;li>å †&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/area.png"
width="875"
height="550"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/area_hu77c5f146be5bf31c819ffe7a07cc3500_205102_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/area_hu77c5f146be5bf31c819ffe7a07cc3500_205102_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="area"
class="gallery-image"
data-flex-grow="159"
data-flex-basis="381px"
>&lt;/p>
&lt;h2 id="-ç¨‹åºè®¡æ•°å™¨">ðŸŽ‹ ç¨‹åºè®¡æ•°å™¨&lt;/h2>
&lt;p>å½“å‰çº¿ç¨‹æ‰§è¡Œå­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚&lt;/p>
&lt;p>å”¯ä¸€ä¸€ä¸ªä¸ä¼šå‡ºçŽ° &lt;code>OutOfMemoryError&lt;/code> çš„å†…å­˜åŒºåŸŸï¼Œéšçº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšçº¿ç¨‹çš„ç»“æŸè€Œæ­»äº¡ã€‚&lt;/p>
&lt;h2 id="-è™šæ‹Ÿæœºæ ˆ">ðŸŽ‹ è™šæ‹Ÿæœºæ ˆ&lt;/h2>
&lt;p>æ¯ä¸€æ¬¡æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„æ ˆå¸§è¢«åŽ‹å…¥æ ˆä¸­ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ç»“æŸåŽï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ ˆå¸§è¢«å¼¹å‡ºã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/stack.png"
width="302"
height="551"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/stack_hu387fe9e9614436cd46058aff5c85565a_61440_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/stack_hu387fe9e9614436cd46058aff5c85565a_61440_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="stack"
class="gallery-image"
data-flex-grow="54"
data-flex-basis="131px"
>&lt;/p>
&lt;p>å½“çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰ Java è™šæ‹Ÿæœºæœ€å¤§æ·±åº¦æ—¶ï¼Œä¼šæŠ›å‡º &lt;code>StackOverFlowError&lt;/code>ã€‚&lt;/p>
&lt;ul>
&lt;li>å±€éƒ¨å˜é‡è¡¨&lt;/li>
&lt;/ul>
&lt;p>å­˜æ”¾ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§æ•°æ®ç±»åž‹ï¼Œå¯¹è±¡å¼•ç”¨åœ°å€ã€‚&lt;/p>
&lt;ul>
&lt;li>æ“ä½œæ•°æ ˆ&lt;/li>
&lt;/ul>
&lt;p>æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è®¡ç®—ç»“æžœï¼Œè®¡ç®—è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶å˜é‡ã€‚&lt;/p>
&lt;ul>
&lt;li>åŠ¨æ€é“¾æŽ¥&lt;/li>
&lt;/ul>
&lt;p>æœåŠ¡äºŽä¸€ä¸ªæ–¹æ³•éœ€è¦è°ƒç”¨å…¶ä»–æ–¹æ³•çš„åœºæ™¯ã€‚&lt;/p>
&lt;ul>
&lt;li>æ–¹æ³•è¿”å›žåœ°å€
&lt;ul>
&lt;li>æ­£å¸¸è¿”å›ž&lt;/li>
&lt;li>å¼‚å¸¸è¿”å›ž&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="-æœ¬åœ°æ–¹æ³•æ ˆ">ðŸŽ‹ æœ¬åœ°æ–¹æ³•æ ˆ&lt;/h2>
&lt;p>æœ¬åœ°æ–¹æ³•æ ˆæ˜¯è™šæ‹Ÿä¸ºæ‰§è¡Œ Native æ–¹æ³•æœåŠ¡ã€‚&lt;/p>
&lt;h2 id="-æ–¹æ³•åŒº">ðŸŽ æ–¹æ³•åŒº&lt;/h2>
&lt;p>æ–¹æ³•åŒºæ˜¯ Java è™šæ‹Ÿæœºçš„æŠ½è±¡æ¦‚å¿µã€‚å®žçŽ°æ–¹å¼åœ¨ä¸åŒè™šæ‹Ÿæœºä¸­å¯èƒ½ä¸åŒã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>JDK 8 ä¹‹å‰ï¼ŒHotSpot è™šæ‹Ÿæœºä½¿ç”¨æ°¸ä¹…å¸¦å®žçŽ°æ–¹æ³•åŒº&lt;/p>
&lt;/li>
&lt;li>
&lt;p>JDK 8 åŠä¹‹åŽï¼Œä½¿ç”¨å…ƒç©ºé—´ï¼ˆç›´æŽ¥å†…å­˜ï¼‰å®žçŽ°&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/function-before.png"
width="382"
height="436"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/function-before_hu5ba856b5fa83b596c5da12a50d62fcb1_75748_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/function-before_hu5ba856b5fa83b596c5da12a50d62fcb1_75748_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="before"
class="gallery-image"
data-flex-grow="87"
data-flex-basis="210px"
>&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/function-after.png"
width="484"
height="433"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/function-after_hue0bd0747c11f9c8962eb0e412965ba30_84329_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/memory-area/function-after_hue0bd0747c11f9c8962eb0e412965ba30_84329_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="after"
class="gallery-image"
data-flex-grow="111"
data-flex-basis="268px"
>&lt;/p>
&lt;ul>
&lt;li>ç±»çš„å…ƒä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;p>ç±»åï¼Œè®¿é—®ä¿®é¥°ç¬¦ï¼Œå­—æ®µæè¿°ï¼Œæ–¹æ³•æè¿°ç­‰&lt;/p>
&lt;ul>
&lt;li>è¿è¡Œæ—¶å¸¸é‡æ± &lt;/li>
&lt;/ul>
&lt;p>å­˜æ”¾ç¼–è¯‘åŽçš„å„ç§å­—é¢é‡ï¼Œç¬¦å·å¼•ç”¨ï¼Œå¸¸é‡ï¼ˆfinalï¼‰æ± è¡¨ç­‰&lt;/p>
&lt;ul>
&lt;li>å­—ç¬¦ä¸²å¸¸é‡æ± &lt;/li>
&lt;/ul>
&lt;p>JVM ä¸ºäº†å‡å°‘å­—ç¬¦ä¸²å¯¹å†…å­˜çš„æ¶ˆè€—ï¼Œå¹¶æå‡æ€§èƒ½ï¼Œä¸“é—¨å¼€è¾Ÿçš„åŒºåŸŸ&lt;/p>
&lt;ul>
&lt;li>é™æ€å˜é‡&lt;/li>
&lt;/ul>
&lt;p>ç±»å˜é‡ï¼ˆstaticï¼‰&lt;/p>
&lt;h2 id="-å †">ðŸŽ å †&lt;/h2>
&lt;p>ç”¨æ¥å­˜æ”¾å’Œç®¡ç†å¯¹è±¡å®žä¾‹ï¼Œå‡ ä¹Žæ‰€æœ‰çš„å¯¹è±¡å®žä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…ï¼ˆé€ƒé€¸åˆ†æžï¼Œæ ˆä¸Šåˆ†é…ï¼‰ã€‚&lt;/p>
&lt;p>Java å †æ˜¯åžƒåœ¾å›žæ”¶çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸º GC å †ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>JDK 8 ä¹‹å‰ï¼Œå †è¢«åˆ†ä¸º&lt;/p>
&lt;ul>
&lt;li>æ–°ç”Ÿä»£ï¼ˆEdenã€Survivor1ã€Survivor2ï¼‰&lt;/li>
&lt;li>è€å¹´ä»£&lt;/li>
&lt;li>æ°¸ä¹…ä»£&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>JDK 8 ä¹‹åŽï¼Œæ°¸ä¹…ä»£è¢«å–æ¶ˆ&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯¹è±¡é¦–å…ˆä¼šåœ¨ Eden åŒºè¿›è¡Œåˆ†é…ï¼›åœ¨ä¸€æ¬¡åžƒåœ¾å›žæ”¶åŽï¼Œå¦‚æžœå¯¹è±¡è¿˜å­˜æ´»ï¼Œä¼šè¿›å…¥ S0 æˆ– S1ï¼›å½“å¯¹è±¡å¹´é¾„å¢žé•¿åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ 15ï¼‰ï¼Œæˆ–ç´¯ç§¯çš„å¹´é¾„è¶…è¿‡äº† Survivor çš„ä¸€åŠï¼Œä¼šæ™‹å‡åˆ°è€å¹´ä»£ã€‚&lt;/p></description></item><item><title>JVM åžƒåœ¾å›žæ”¶</title><link>https://emerywan.github.io/blog/p/java/jvm/garbage-collection/</link><pubDate>Sun, 07 Aug 2022 12:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/java/jvm/garbage-collection/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/26.jpeg" alt="Featured image of post JVM åžƒåœ¾å›žæ”¶" />&lt;h2 id="-å¯¹è±¡å­˜æ´»åˆ¤å®š">ðŸŒ´ å¯¹è±¡å­˜æ´»åˆ¤å®š&lt;/h2>
&lt;h3 id="-å¼•ç”¨è®¡æ•°æ³•">ðŸª¨ å¼•ç”¨è®¡æ•°æ³•&lt;/h3>
&lt;p>ç»™æ¯ä¸ªå¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼š&lt;/p>
&lt;ul>
&lt;li>å½“æœ‰åœ°æ–¹å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè®¡æ•°å™¨ &lt;code>+1&lt;/code>&lt;/li>
&lt;li>å½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨ &lt;code>-1&lt;/code>&lt;/li>
&lt;li>å½“è®¡æ•°å™¨ä¸º &lt;code>0&lt;/code> æ—¶ï¼Œè¡¨ç¤ºå¯¹è±¡ä¸å¯ç”¨&lt;/li>
&lt;/ul>
&lt;p>è¯¥æ–¹æ³•ç®€å•é«˜æ•ˆï¼Œä½†ä¸»æµçš„è™šæ‹Ÿæœºéƒ½æ²¡æœ‰é€‰æ‹©è¯¥æ–¹æ³•ç®¡ç†å†…å­˜ï¼Œéš¾ä»¥è§£å†³å¯¹è±¡ä¹‹é—´å¾ªçŽ¯å¼•ç”¨çš„é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="-å¯è¾¾æ€§åˆ†æžæ³•">ðŸª¨ å¯è¾¾æ€§åˆ†æžæ³•&lt;/h3>
&lt;p>é€šè¿‡ä¸€ç³»åˆ—ç§°ä¸º &lt;code>GC Root&lt;/code> çš„å¯¹è±¡ä½œä¸ºèµ·ç‚¹ï¼Œä»Žè¿™äº›èµ·ç‚¹å‘ä¸‹æœç´¢ï¼ŒèŠ‚ç‚¹èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡ä¸Ž &lt;code>GC Root&lt;/code> ä¹‹é—´æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿žçš„è¯ï¼Œè¯´æ˜Žå¯¹è±¡ä¸å¯ç”¨ï¼Œéœ€è¦è¢«å›žæ”¶ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/gcroot.png"
width="935"
height="581"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/gcroot_hud8e4c62b0ef63778b91f8329965428a2_102739_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/gcroot_hud8e4c62b0ef63778b91f8329965428a2_102739_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="gcroot"
class="gallery-image"
data-flex-grow="160"
data-flex-basis="386px"
>&lt;/p>
&lt;p>å¯ä»¥ä½œä¸º &lt;code>GC Root&lt;/code> çš„å¯¹è±¡ï¼š&lt;/p>
&lt;ul>
&lt;li>è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­å±€éƒ¨å˜é‡è¡¨ï¼‰å¼•ç”¨çš„å¯¹è±¡&lt;/li>
&lt;li>æœ¬åœ°æ–¹æ³•æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡&lt;/li>
&lt;li>ç±»é™æ€å±žæ€§å¼•ç”¨çš„å¯¹è±¡&lt;/li>
&lt;li>æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡&lt;/li>
&lt;li>æ‰€æœ‰è¢«åŒæ­¥é”ï¼ˆsynchronizedï¼‰æŒæœ‰çš„å¯¹è±¡&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h2 id="-åžƒåœ¾å›žæ”¶ç®—æ³•">ðŸŒ´ åžƒåœ¾å›žæ”¶ç®—æ³•&lt;/h2>
&lt;h3 id="-æ ‡è®°-æ¸…é™¤">ðŸªµ æ ‡è®°-æ¸…é™¤&lt;/h3>
&lt;ul>
&lt;li>æ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›žæ”¶çš„å¯¹è±¡&lt;/li>
&lt;li>æ ‡è®°ç»“æŸåŽï¼Œç»Ÿä¸€å›žæ”¶æŽ‰æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/clear.png"
width="962"
height="488"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/clear_hu3ebff86a38831b55ce513a2b74335841_65435_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/clear_hu3ebff86a38831b55ce513a2b74335841_65435_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="clear"
class="gallery-image"
data-flex-grow="197"
data-flex-basis="473px"
>&lt;/p>
&lt;ul>
&lt;li>æ‰§è¡Œæ•ˆçŽ‡ä¸ç¨³å®šï¼Œå¤§éƒ¨åˆ†å¯¹è±¡éœ€è¦å›žæ”¶æ—¶ï¼Œéœ€è¦å¤§é‡æ ‡è®°å’Œæ¸…é™¤æ“ä½œ&lt;/li>
&lt;li>å†…å­˜ç©ºé—´ç¢Žç‰‡åŒ–é—®é¢˜&lt;/li>
&lt;/ul>
&lt;h3 id="-æ ‡è®°-å¤åˆ¶">ðŸªµ æ ‡è®°-å¤åˆ¶&lt;/h3>
&lt;ul>
&lt;li>å°†å†…å­˜åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—&lt;/li>
&lt;li>å½“ä¸€å—å†…å­˜ä½¿ç”¨å®ŒåŽï¼Œå°†å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—åŽ»&lt;/li>
&lt;li>å°†ä»¥ä½¿ç”¨çš„ç©ºé—´ä¸€æ¬¡æ€§æ¸…é™¤æŽ‰&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/copy.png"
width="955"
height="495"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/copy_hu6b5a3b19d23e61d87d481fdc4629a5cf_68281_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/copy_hu6b5a3b19d23e61d87d481fdc4629a5cf_68281_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="copy"
class="gallery-image"
data-flex-grow="192"
data-flex-basis="463px"
>&lt;/p>
&lt;ul>
&lt;li>å¯ç”¨å†…å­˜å˜å°‘ï¼Œæœ‰ç©ºé—´æµªè´¹é—®é¢˜&lt;/li>
&lt;/ul>
&lt;h3 id="-æ ‡è®°-æ•´ç†">ðŸªµ æ ‡è®°-æ•´ç†&lt;/h3>
&lt;ul>
&lt;li>æ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›žæ”¶çš„å¯¹è±¡&lt;/li>
&lt;li>è®©è¿™äº›å­˜æ´»å¯¹è±¡å‘å†…å­˜çš„ä¸€ç«¯ç§»åŠ¨&lt;/li>
&lt;li>ç›´æŽ¥æ¸…é™¤æŽ‰è¾¹ç•Œä»¥å¤–çš„å†…å­˜&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/move.png"
width="944"
height="480"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/move_hu0eec74bf9ebb0cbf4f6fd4cbe2be3a39_63153_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/move_hu0eec74bf9ebb0cbf4f6fd4cbe2be3a39_63153_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="move"
class="gallery-image"
data-flex-grow="196"
data-flex-basis="472px"
>&lt;/p>
&lt;h3 id="-åˆ†ä»£æ”¶é›†">ðŸªµ åˆ†ä»£æ”¶é›†&lt;/h3>
&lt;p>æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒï¼Œå°† Java å †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œä¾æ®å„ä¸ªåŒºåŸŸçš„ç‰¹ç‚¹ï¼Œé€‰æ‹©å›žæ”¶ç®—æ³•ã€‚&lt;/p>
&lt;ul>
&lt;li>åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡æ”¶é›†éƒ½ä¼šæœ‰å¤§é‡çš„å¯¹è±¡æ­»åŽ»ï¼Œé€‰æ‹© &lt;code>æ ‡è®°-å¤åˆ¶&lt;/code> ç®—æ³•&lt;/li>
&lt;li>åœ¨è€å¹´ä»£ä¸­ï¼Œå­˜æ´»å¯¹è±¡çš„å‡ çŽ‡è¾ƒé«˜ï¼Œæ²¡æœ‰é¢å¤–çš„ç©ºé—´è¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œé€‰æ‹© &lt;code>æ ‡è®°-æ¸…é™¤&lt;/code> æˆ– &lt;code>æ ‡è®°-æ•´ç†&lt;/code> ç®—æ³•&lt;/li>
&lt;/ul>
&lt;h2 id="-åžƒåœ¾æ”¶é›†æ–¹å¼">ðŸŒ´ åžƒåœ¾æ”¶é›†æ–¹å¼&lt;/h2>
&lt;h3 id="-éƒ¨åˆ†æ”¶é›†">ðŸª¨ éƒ¨åˆ†æ”¶é›†&lt;/h3>
&lt;p>æ”¶é›†å †éƒ¨åˆ†åŒºåŸŸã€‚&lt;code>Partial GC&lt;/code>&lt;/p>
&lt;ul>
&lt;li>æ–°ç”Ÿä»£æ”¶é›† &lt;code>Minor GC / Young GC&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç›®æ ‡åªæ˜¯æ–°ç”Ÿä»£çš„åžƒåœ¾æ”¶é›†ã€‚&lt;/p>
&lt;ul>
&lt;li>è€å¹´ä»£æ”¶é›† &lt;code>Major GC / Old GC&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç›®æ ‡åªæ˜¯è€å¹´ä»£çš„åžƒåœ¾æ”¶é›†ï¼Œç›®å‰åªæœ‰ CMS æ”¶é›†å™¨ä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸ºã€‚&lt;/p>
&lt;ul>
&lt;li>æ··åˆæ”¶é›† &lt;code>Mixed GC&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç›®æ ‡æ˜¯æ•´ä¸ªæ–°ç”Ÿä»£å’Œéƒ¨åˆ†è€å¹´ä»£çš„åžƒåœ¾æ”¶é›†ï¼Œç›®å‰åªæœ‰ G1 æ”¶é›†å™¨ä¼šæœ‰è¿™ç§è¡Œä¸ºã€‚&lt;/p>
&lt;h3 id="-æ•´å †æ”¶é›†">ðŸª¨ æ•´å †æ”¶é›†&lt;/h3>
&lt;p>æ”¶é›†æ•´ä¸ªå †å’Œæ–¹æ³•åŒºã€‚&lt;code>Full GC&lt;/code>&lt;/p>
&lt;ul>
&lt;li>æ™‹å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡å¤§äºŽè€å¹´ä»£çš„å‰©ä½™ç©ºé—´&lt;/li>
&lt;li>Minor GC åŽï¼Œæ–°ç”Ÿä»£å­˜æ´»å¯¹è±¡è¶…è¿‡äº†è€å¹´ä»£çš„ç©ºé—´ï¼ˆåˆ†é…æ‹…ä¿ï¼‰&lt;/li>
&lt;li>æ‰‹åŠ¨ System.gc()&lt;/li>
&lt;li>(Java8ä¹‹å‰) æ°¸ä¹…ä»£ç©ºé—´ä¸è¶³&lt;/li>
&lt;/ul>
&lt;h2 id="-åžƒåœ¾æ”¶é›†å™¨">ðŸŒ´ åžƒåœ¾æ”¶é›†å™¨&lt;/h2>
&lt;h3 id="-serial--serial-old">ðŸªµ Serial / Serial Old&lt;/h3>
&lt;p>â€œå•çº¿ç¨‹â€çš„åžƒåœ¾æ”¶é›†å™¨ï¼Œåœ¨è¿›è¡Œåžƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰å·¥ä½œçº¿ç¨‹&lt;code>stop the world&lt;/code>ï¼Œç›´åˆ°æ”¶é›†ä»‹ç»ã€‚&lt;/p>
&lt;ul>
&lt;li>æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/serial.png"
width="953"
height="209"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/serial_hu902bd566aebd83355bfe0e2769bbc345_79667_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/serial_hu902bd566aebd83355bfe0e2769bbc345_79667_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="serial"
class="gallery-image"
data-flex-grow="455"
data-flex-basis="1094px"
>&lt;/p>
&lt;ul>
&lt;li>ç®€å•é«˜æ•ˆ&lt;/li>
&lt;li>ä¾æ—§æ˜¯çŽ°åœ¨ HotSpot è™šæ‹Ÿæœºè¿è¡Œåœ¨å®¢æˆ·ç«¯æ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£åžƒåœ¾å›žæ”¶æ–¹å¼&lt;/li>
&lt;/ul>
&lt;h3 id="-parnew">ðŸªµ ParNew&lt;/h3>
&lt;p>Serial çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨å¤šæ¡çº¿ç¨‹è¿›è¡Œåžƒåœ¾å›žæ”¶ï¼ˆæ–°ç”Ÿä»£ï¼‰ã€‚&lt;/p>
&lt;ul>
&lt;li>é‡‡ç”¨æ ‡è®°å¤åˆ¶ç®—æ³•&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/parnew.png"
width="960"
height="202"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/parnew_hub4e3375e7b496e8b6ebc251ec3bf2f26_87679_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/parnew_hub4e3375e7b496e8b6ebc251ec3bf2f26_87679_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="parnew"
class="gallery-image"
data-flex-grow="475"
data-flex-basis="1140px"
>&lt;/p>
&lt;h3 id="-parallel-scavenge--parallel-old">ðŸªµ Parallel Scavenge / Parallel Old&lt;/h3>
&lt;ul>
&lt;li>åŸºäºŽ æ ‡è®°-å¤åˆ¶ ç®—æ³•å®žçŽ°çš„æ–°ç”Ÿä»£åžƒåœ¾æ”¶é›†å™¨ï¼Œèƒ½å¤Ÿå¹¶è¡Œæ”¶é›†çš„å¤šçº¿ç¨‹æ”¶é›†å™¨ï¼Œç›®æ ‡æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æŽ§åˆ¶çš„â€œåžåé‡â€&lt;/li>
&lt;li>åŸºäºŽ æ ‡è®°-æ•´ç† ç®—æ³•å®žçŽ°çš„è€å¹´ä»£å¤šçº¿ç¨‹æ”¶é›†å™¨ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/parallel.png"
width="934"
height="199"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/parallel_hu519cfc57a4a5c97f5f81fc0feaeb8730_92362_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/parallel_hu519cfc57a4a5c97f5f81fc0feaeb8730_92362_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="parallel"
class="gallery-image"
data-flex-grow="469"
data-flex-basis="1126px"
>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Java 8 é»˜è®¤çš„æ”¶é›†å™¨ä¸º Parallel Sacvenge + Parallel Old&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åžåé‡ TPS ï¼šç³»ç»Ÿåœ¨å•ä½æ—¶é—´å†…å¤„ç†è¯·æ±‚çš„æ•°é‡&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="-cms">ðŸªµ CMS&lt;/h3>
&lt;p>&lt;code>Concurrent Mark Swap&lt;/code> èŽ·å–æœ€çŸ­åœé¡¿æ—¶é—´çš„æ”¶é›†å™¨ã€‚&lt;/p>
&lt;p>æ˜¯ HotSpot è™šæ‹Ÿæœºç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„åžƒåœ¾æ”¶é›†å™¨ï¼Œå®žçŽ°äº†ç”¨æˆ·çº¿ç¨‹å’Œåžƒåœ¾å›žæ”¶çº¿ç¨‹åŒæ—¶å·¥ä½œã€‚åŸºäºŽ æ ‡è®°-æ¸…é™¤ ç®—æ³•çš„ &lt;strong>è€å¹´ä»£&lt;/strong> æ”¶é›†å™¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/CMS.png"
width="1121"
height="230"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/CMS_hu7a65fd9981325c5387fcf294cec67078_167761_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/CMS_hu7a65fd9981325c5387fcf294cec67078_167761_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="CMS"
class="gallery-image"
data-flex-grow="487"
data-flex-basis="1169px"
>&lt;/p>
&lt;p>CMS æ”¶é›†å™¨æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ åˆå§‹æ ‡è®°&lt;/li>
&lt;/ul>
&lt;p>æ ‡è®°ä¸Ž GC Root ç›´æŽ¥å…³è”çš„å¯¹è±¡ã€‚ï¼ˆstop the worldï¼‰æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œä½†é€Ÿåº¦è¾ƒå¿«ã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ å¹¶å‘æ ‡è®°&lt;/li>
&lt;/ul>
&lt;p>ç”¨æˆ·çº¿ç¨‹å’Œåžƒåœ¾å›žæ”¶çº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œä»Ž GC Root ç›´æŽ¥å…³è”çš„å¯¹è±¡å¼€å§‹éåŽ†ï¼Œæ ¹æ®å¯è¾¾æ€§åˆ†æžï¼Œæ‰¾å‡ºå­˜æ´»å¯¹è±¡ã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ é‡æ–°æ ‡è®°&lt;/li>
&lt;/ul>
&lt;p>ä¿®æ­£å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œç”±äºŽç¨‹åºç»§ç»­è¿è¡Œï¼Œå¯¼è‡´çš„æ ‡è®°é”™è¯¯ã€‚æš‚åœç”¨æˆ·çº¿ç¨‹ã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ å¹¶å‘æ¸…é™¤&lt;/li>
&lt;/ul>
&lt;p>å¹¶å‘åœ°æ¸…ç†æœªè¢«æ ‡è®°çš„åŒºåŸŸã€‚&lt;/p>
&lt;p>ç¼ºç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹ CPU èµ„æºæ•æ„Ÿ&lt;/li>
&lt;li>æ— æ³•å¤„ç†æµ®åŠ¨åžƒåœ¾ï¼šè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€äº›åžƒåœ¾åœ¨å½“æ¬¡æ— æ³•å¤„ç†ï¼Œéœ€è¦ç­‰å¾…ä¸‹æ¬¡åžƒåœ¾å›žæ”¶&lt;/li>
&lt;li>ä¼šäº§ç”Ÿå†…å­˜ç¢Žç‰‡ï¼Œè¿žç»­ç©ºé—´å‡å°‘ï¼Œå¯¼è‡´ Full GC&lt;/li>
&lt;/ul>
&lt;h3 id="-g1">ðŸªµ G1&lt;/h3>
&lt;p>G1 å¼€åˆ›äº†æ”¶é›†å™¨é¢å‘å±€éƒ¨æ”¶é›†çš„è®¾è®¡æ€è·¯å’ŒåŸºäºŽ Region çš„å†…å­˜å¸ƒå±€å½¢å¼ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/g1heap.png"
width="902"
height="676"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/g1heap_huc8187154c5204389b583a76e76e7dffa_88685_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/g1heap_huc8187154c5204389b583a76e76e7dffa_88685_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="g1heap"
class="gallery-image"
data-flex-grow="133"
data-flex-basis="320px"
>&lt;/p>
&lt;p>å°† Java å †åˆ†ä¸º 2048 ä¸ªå¤§å°ç›¸åŒçš„ç‹¬ç«‹ Regionï¼Œæ¯ä¸ª Region çš„å¤§å°ä¾æ®å †ç©ºé—´çš„å¤§å°è€Œå®šï¼Œåœ¨ JVM ç”Ÿå‘½å‘¨æœŸä¸­ä¸ä¼šæ”¹å˜ã€‚&lt;/p>
&lt;p>æ¯ä¸ª Region éƒ½å¯ä»¥æ›´æ–°éœ€è¦ï¼Œä½œä¸ºæ–°ç”Ÿä»£çš„ Eden åŒºï¼ŒSurvivor åŒºï¼Œæˆ–è€…æ˜¯è€å¹´ä»£ï¼›æ–°ç”Ÿä»£å’Œè€å¹´ä»£åœ¨å†…å­˜ä¸­ä¸æ˜¯è¿žç»­çš„ç©ºé—´ï¼Œæ”¶é›†å™¨ä¼šæ ¹æ®åŒºåŸŸçš„ä¸åŒé‡‡å–ä¸åŒçš„ç­–ç•¥ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/g1.png"
width="941"
height="209"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/g1_hu2c13cc7a5d500b4a818a8d3a4dfa26ed_139186_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/garbage-collection/g1_hu2c13cc7a5d500b4a818a8d3a4dfa26ed_139186_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="g1"
class="gallery-image"
data-flex-grow="450"
data-flex-basis="1080px"
>&lt;/p>
&lt;p>Region ä¸­è¿˜ä¼šæœ‰ä¸€ç±»ç‰¹æ®Šçš„å·¨å¤§åŒºåŸŸ Humongousï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨å¤§å¯¹è±¡ã€‚å½“å¯¹è±¡çš„å¤§å°è¶…è¿‡äº†ä¸€ä¸ª Region çš„ä¸€åŠï¼Œå°±è¢«åˆ¤å®šä¸ºå¤§å¯¹è±¡ã€‚&lt;/p>
&lt;p>G1 æ”¶é›†å™¨å›žæ”¶çš„æ­¥éª¤ï¼š&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ åˆå§‹æ ‡è®°&lt;/li>
&lt;/ul>
&lt;p>æ ‡è®° GC Root èƒ½å¤Ÿç›´æŽ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œéœ€è¦åœé¡¿çº¿ç¨‹ï¼Œè€—æ—¶è¾ƒçŸ­ã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ å¹¶å‘æ ‡è®°&lt;/li>
&lt;/ul>
&lt;p>ä»Ž GC Root å¼€å§‹å¯¹å †ä¸­çš„å¯¹è±¡è¿›è¡Œå¯è¾¾æ€§åˆ†æžï¼Œæ‰¾å‡ºéœ€è¦å›žæ”¶çš„å¯¹è±¡ï¼Œä¸Žç”¨æˆ·çº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ æœ€ç»ˆæ ‡è®°&lt;/li>
&lt;/ul>
&lt;p>ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨ã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸ¾ ç­›é€‰å›žæ”¶&lt;/li>
&lt;/ul>
&lt;p>å¯¹å„ä¸ª Region çš„å›žæ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡ŒæŽ’åºï¼Œé€‰æ‹©ä¼šåŽä»·å€¼æœ€å¤§çš„åŒºåŸŸè¿›è¡Œå›žæ”¶ã€‚&lt;/p>
&lt;p>å°†å›žæ”¶çš„ Region ä¸­çš„å­˜æ´»å¯¹è±¡ï¼Œå¤åˆ¶åˆ°ç©ºçš„ Region ä¸­ï¼Œå†æ¸…ç†æŽ‰æ•´ä¸ªæ—§çš„ Region åŒºåŸŸã€‚&lt;/p>
&lt;p>æ¶‰åŠå¯¹è±¡çš„ç§»åŠ¨ï¼Œå¿…é¡»æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œæœ‰å¤šæ¡åžƒåœ¾æ”¶é›†å™¨å¹¶å‘æ‰§è¡Œã€‚ä½†æ˜¯åªå›žæ”¶ä¸€éƒ¨åˆ†Regionï¼Œæ—¶é—´æ˜¯ç”¨æˆ·å¯æŽ§åˆ¶çš„ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2 id="-å¯¹è±¡åˆ†é…å’Œå›žæ”¶åŽŸåˆ™">ðŸŒ´ å¯¹è±¡åˆ†é…å’Œå›žæ”¶åŽŸåˆ™&lt;/h2>
&lt;ul>
&lt;li>ðŸª¨ å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åŒºåˆ†é…&lt;/li>
&lt;/ul>
&lt;p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ Eden åŒºåˆ†é…ï¼Œå½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´æ—¶ï¼Œè™šæ‹Ÿæœºä¼šå‘èµ·ä¸€æ¬¡ Minor GCã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸª¨ å¤§å¯¹è±¡ç›´æŽ¥è¿›å…¥è€å¹´ä»£&lt;/li>
&lt;/ul>
&lt;p>éœ€è¦å¤§é‡è¿žç»­å†…å­˜ç©ºé—´çš„ Java å¯¹è±¡ï¼ˆæ•°ç»„ï¼Œå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼‰ï¼Œç›´æŽ¥åœ¨è€å¹´ä»£åˆ†é…ï¼Œé¿å…åœ¨ Eden åŒºå’Œä¸¤ä¸ª Survivor åŒºä¹‹é—´æ¥å›žå¤åˆ¶ï¼Œäº§ç”Ÿå¤§é‡çš„å†…å­˜å¤åˆ¶æ“ä½œã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸª¨ é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£&lt;/li>
&lt;/ul>
&lt;p>è™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡ä¸€ä¸ªå¯¹è±¡å¹´é¾„è®¡æ•°å™¨ï¼Œæ¯ç»è¿‡ä¸€æ¬¡ MinorGCï¼Œå¹´é¾„å°±ä¼š +1ï¼Œ&lt;/p>
&lt;p>å½“å¹´é¾„å¢žåŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ 15ï¼‰ï¼Œæˆ–æŸä¸ªå¹´é¾„è¶…è¿‡äº† Survivor åŒºçš„ä¸€åŠæ—¶ï¼Œä¼šæ™‹å‡åˆ°è€å¹´ä»£ã€‚&lt;/p>
&lt;ul>
&lt;li>ðŸª¨ ç©ºé—´åˆ†é…æ‹…ä¿&lt;/li>
&lt;/ul>
&lt;p>ç¡®ä¿åœ¨ Minor GC ä¹‹å‰ï¼Œè€å¹´ä»£è¿˜æœ‰å®¹çº³æ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„å‰©ä½™ç©ºé—´ã€‚&lt;/p>
&lt;p>è¿›è¡Œä¸€æ¬¡ Minor GC ä¹‹åŽï¼ŒEden åŒºä¸­ä»»ç„¶å­˜åœ¨å¤§é‡å¯¹è±¡ï¼ŒSurvivor ä¸­æ— æ³•å®¹çº³ï¼Œç›´æŽ¥é€åˆ°è€å¹´ä»£ï¼Œè®©è€å¹´ä»£è¿›è¡Œç©ºé—´åˆ†é…æ‹…ä¿ã€‚&lt;/p></description></item><item><title>JVM å†…å­˜æ¨¡åž‹</title><link>https://emerywan.github.io/blog/p/java/jvm/memory-model/</link><pubDate>Sun, 07 Aug 2022 06:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/java/jvm/memory-model/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/28.jpeg" alt="Featured image of post JVM å†…å­˜æ¨¡åž‹" />&lt;h2 id="jmm">JMM&lt;/h2>
&lt;p>Java å†…å­˜æ¨¡åž‹ï¼ˆJava Memory Modelï¼‰å±è”½äº†ä¸åŒæ“ä½œç³»ç»Ÿå’Œå„ç§ç¡¬ä»¶çš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œå®žçŽ°äº† Java ç¨‹åºåœ¨å„ç§å¹³å°ä¸‹ï¼Œéƒ½èƒ½è¾¾åˆ°ä¸€è‡´æ€§çš„è®¿é—®æ•ˆæžœã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/memory-model/JMM.png"
width="613"
height="530"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/memory-model/JMM_hu7e11e9092393e4f5c6cb98b7857d5889_99528_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/memory-model/JMM_hu7e11e9092393e4f5c6cb98b7857d5889_99528_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="JMM"
class="gallery-image"
data-flex-grow="115"
data-flex-basis="277px"
>&lt;/p>
&lt;p>JMM è§„å®šäº†ï¼š&lt;/p>
&lt;ul>
&lt;li>æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å­˜ä¸­&lt;/li>
&lt;li>æ¯æ¡çº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜&lt;/li>
&lt;li>çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œï¼ˆè¯»å–ã€èµ‹å€¼ç­‰ï¼‰ï¼Œä¸èƒ½ç›´æŽ¥è¯»å†™ä¸»å­˜ä¸­çš„æ•°æ®ï¼Œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œ&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/memory-model/memory.png"
width="942"
height="383"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/memory-model/memory_hue7fb17d3eb7c4a77bd28c7215dc28c3d_104935_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/memory-model/memory_hue7fb17d3eb7c4a77bd28c7215dc28c3d_104935_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="memory"
class="gallery-image"
data-flex-grow="245"
data-flex-basis="590px"
>&lt;/p>
&lt;h2 id="åŽŸå­æ€§å¯è§æ€§æœ‰åºæ€§">åŽŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§&lt;/h2>
&lt;p>Java å†…å­˜æ¨¡åž‹æ˜¯å›´ç»•ç€åœ¨å¹¶å‘è¿‡ç¨‹ä¸­å¦‚ä½•å¤„ç†åŽŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ä¸‰ä¸ªç‰¹å¾æ¥å»ºç«‹çš„ã€‚&lt;/p>
&lt;h3 id="åŽŸå­æ€§">åŽŸå­æ€§&lt;/h3>
&lt;p>ä¸€æ¬¡æˆ–å¤šæ¬¡æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œä¸”ä¸å—åˆ°ä»»ä½•å¹²æ‰°ï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚&lt;/p>
&lt;ul>
&lt;li>åˆ©ç”¨é”ï¼Œä»»ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä»£ç å—ã€‚&lt;code>synchronized&lt;/code> &lt;code>Lock&lt;/code>&lt;/li>
&lt;li>åˆ©ç”¨ &lt;code>CAS&lt;/code> åŽŸå­ç±» ä¿è¯åŽŸå­æ“ä½œ&lt;/li>
&lt;/ul>
&lt;h3 id="å¯è§æ€§">å¯è§æ€§&lt;/h3>
&lt;p>ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>volatile&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>è§„å®šæ¯æ¬¡å†™æ“ä½œï¼Œéƒ½ç«‹å³åŒæ­¥åˆ°ä¸»å­˜ï¼›æ¯æ¬¡è¯»æ“ä½œï¼Œéƒ½ä»Žä¸»å­˜ä¸­è¯»å–ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>synchronized&lt;/code> &lt;code>lock&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œæ‰§è¡Œ unlock ä¹‹å‰ï¼Œå¿…é¡»æŠŠå˜é‡åŒæ­¥å›žä¸»å­˜ä¸­ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>final&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="æœ‰åºæ€§">æœ‰åºæ€§&lt;/h3>
&lt;p>æŒ‡ä»¤é‡æŽ’é—®é¢˜ï¼Œä»£ç çš„æ‰§è¡Œé¡ºåºä¸ä¸€å®šã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>volatile&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åŒ…å«ç¦æ­¢æŒ‡ä»¤é‡æŽ’åºçš„è¯­ä¹‰ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>synchronized&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åªæœ‰ä¸€æ¡çº¿ç¨‹èƒ½å¤Ÿè¿›å…¥ä¸´ç•ŒåŒºã€‚&lt;/p>
&lt;h2 id="volatile">volatile&lt;/h2>
&lt;p>Java è™šæ‹Ÿæœºæä¾›çš„è½»é‡çº§å†…å­˜åŒæ­¥æœºåˆ¶ã€‚&lt;/p>
&lt;p>ä½œç”¨ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¿éšœäº†æ­¤å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§&lt;/li>
&lt;/ul>
&lt;p>volatile çš„å†™æ“ä½œï¼Œéƒ½ä¼šåˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œå¹¶ä½¿å…¶ä»–çº¿ç¨‹ä¸­çš„ volatile å˜é‡å¤±æ•ˆï¼›volatile çš„è¯»æ“ä½œï¼Œéƒ½ä¼šä»Žä¸»å­˜ä¸­è¯»å–ã€‚&lt;/p>
&lt;ul>
&lt;li>ç¦æ­¢æŒ‡ä»¤é‡æŽ’ä¼˜åŒ–ï¼ˆæœ‰åºæ€§ï¼‰&lt;/li>
&lt;/ul>
&lt;p>é˜²æ­¢å†™æ“ä½œä¹‹å‰çš„ä»£ç ï¼Œé‡æŽ’åˆ°å†™æ“ä½œä¹‹åŽï¼›é˜²æ­¢è¯»æ“ä½œä¹‹åŽçš„ä»£ç ï¼Œé‡æŽ’åˆ°è¯»æ“ä½œä¹‹å‰ã€‚&lt;/p>
&lt;ul>
&lt;li>â—ï¸æ— æ³•ä¿éšœåŽŸå­æ€§&lt;/li>
&lt;/ul>
&lt;p>ä¸€æ¡å­—èŠ‚ç åœ¨æ‰§è¡Œæ—¶ï¼Œéœ€è¦è¿è¡Œå¤šæ¡æŒ‡ä»¤æ‰èƒ½å®žçŽ°ã€‚&lt;/p>
&lt;p>å®žçŽ°æ–¹å¼ï¼šå†…å­˜å±éšœ&lt;/p>
&lt;p>ä¿è¯ï¼šä¹‹å‰çš„æŒ‡ä»¤ä¸€å®šå…¨éƒ¨æ‰§è¡Œï¼Œä¹‹åŽçš„æŒ‡ä»¤ä¸€å®šéƒ½æ²¡æœ‰æ‰§è¡Œï¼Œå¹¶ä¸”å‰é¢è¯­å¥çš„ç»“æžœå¯¹åŽé¢çš„è¯­å¥å¯è§ã€‚&lt;/p>
&lt;h2 id="happens-before">happens-before&lt;/h2>
&lt;p>å¯¹äºŽä¸¤ä¸ªæ“ä½œ A å’Œ Bï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æžœ A happens-before Bï¼ˆA ä¼˜å…ˆäºŽ B æ‰§è¡Œï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä¿è¯ï¼Œå½“ A æ“ä½œå®ŒåŽï¼ŒA çš„æ“ä½œå¯¹äºŽ B æ“ä½œæ˜¯å¯è§çš„ã€‚&lt;/p>
&lt;p>æŒ‡ä»¤é‡æŽ’æé«˜äº†å¹¶å‘æ€§èƒ½ï¼Œä½†æ˜¯ Java è™šæ‹Ÿæœºä¼šå¯¹æŒ‡ä»¤é‡æŽ’åšä¸€äº›è§„åˆ™é™åˆ¶ï¼Œå¹¶ä¸èƒ½è®©æ‰€æœ‰çš„æŒ‡ä»¤éƒ½éšæ„æ”¹å˜æ‰§è¡Œä½ç½®ã€‚&lt;/p>
&lt;p>Java å†…å­˜æ¨¡åž‹å¤©ç„¶çš„å…ˆè¡Œå‘ç”Ÿå…³ç³»ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ç¨‹åºé¡ºåºè§„åˆ™&lt;/p>
&lt;p>åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼Œå‰é¢çš„ä»£ç æ“ä½œä¼˜äºŽåŽé¢çš„ä»£ç æ“ä½œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é”å®šè§„åˆ™&lt;/p>
&lt;p>ä¸€ä¸ª unlock æ“ä½œä¼˜äºŽåŽé¢å¯¹äºŽåŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>volatile è§„åˆ™&lt;/p>
&lt;p>ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œï¼Œä¼˜äºŽåŽé¢è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¼ é€’è§„åˆ™&lt;/p>
&lt;p>å¦‚æžœ A happens-before Bï¼Œä¸” B happens-before Cï¼Œé‚£ä¹ˆ A happens-before Cã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>çº¿ç¨‹å¯åŠ¨è§„åˆ™&lt;/p>
&lt;p>Thread å¯¹è±¡çš„ start() æ–¹æ³• happens-before çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>ç±»åŠ è½½å™¨</title><link>https://emerywan.github.io/blog/p/java/jvm/classloader/</link><pubDate>Sat, 06 Aug 2022 16:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/java/jvm/classloader/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/25.jpeg" alt="Featured image of post ç±»åŠ è½½å™¨" />&lt;h2 id="ç±»åŠ è½½å™¨">ç±»åŠ è½½å™¨&lt;/h2>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/classloader/menu.png"
width="1707"
height="638"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/classloader/menu_hu8b8ca38d973bcbde05d207eb8795320e_321907_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/classloader/menu_hu8b8ca38d973bcbde05d207eb8795320e_321907_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="menu"
class="gallery-image"
data-flex-grow="267"
data-flex-basis="642px"
>&lt;/p>
&lt;h3 id="bootstrapclassloader">BootstrapClassLoader&lt;/h3>
&lt;p>å¯åŠ¨ç±»åŠ è½½å™¨&lt;/p>
&lt;p>æœ€é¡¶å±‚çš„åŠ è½½ç±»ï¼Œç”± C++ å®žçŽ°ï¼Œè´Ÿè´£åŠ è½½ &lt;code>%JAVA_HOME%/lib&lt;/code> ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»æˆ–è€…è¢« &lt;code>-Xbootclasspath&lt;/code> å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»ã€‚&lt;/p>
&lt;h3 id="extensionclassloader">ExtensionClassLoader&lt;/h3>
&lt;p>æ‰©å±•ç±»åŠ è½½å™¨ã€‚Java ç³»ç»Ÿç±»åº“çš„æ‰©å±•æœºåˆ¶ã€‚&lt;/p>
&lt;p>è´Ÿè´£åŠ è½½ &lt;code>%JRE_HOME%/lib/ext&lt;/code> ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»ï¼Œæˆ–è¢« &lt;code>java.ext.dirs&lt;/code> ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸‹çš„ jar åŒ…ã€‚&lt;/p>
&lt;h3 id="applicationclassloader">ApplicationClassLoader&lt;/h3>
&lt;p>é¢å‘ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å½“å‰åº”ç”¨ &lt;code>classpath&lt;/code> ä¸‹çš„æ‰€æœ‰ jar åŒ…å’Œç±»ã€‚&lt;/p>
&lt;h2 id="åŒäº²å§”æ´¾æ¨¡åž‹">åŒäº²å§”æ´¾æ¨¡åž‹&lt;/h2>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/classloader/classloader.png"
width="1279"
height="699"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/classloader/classloader_hu2885d6b96687a867396da9eda76d4bf0_289144_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/classloader/classloader_hu2885d6b96687a867396da9eda76d4bf0_289144_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="classloader"
class="gallery-image"
data-flex-grow="182"
data-flex-basis="439px"
>&lt;/p>
&lt;p>æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œç”¨ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½äº†åŒä¸€ä¸ªé™å®šåçš„ç±»ï¼ŒJVM ä¹Ÿä¼šè®¤ä¸ºæ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">protected&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">loadClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">resolve&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">throws&lt;/span> &lt;span class="n">ClassNotFoundException&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">synchronized&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">getClassLoadingLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// (1) åˆ¤æ–­æ˜¯å¦åŠ è½½è¿‡è¯¥ç±»
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">findLoadedClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">long&lt;/span> &lt;span class="n">t0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">nanoTime&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">loadClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// (2) parent == null çº¦å®šä¸ºï¼šparnet ä¸º Bootstracp ClassLoader
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">findBootstrapClassOrNull&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ClassNotFoundException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ClassNotFoundException thrown if class not found
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// from the non-null parent class loader
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// (3) è¯´æ˜Ž parent åŠ è½½ä¸äº†ï¼Œå½“å‰ loader å°è¯•åŠ è½½ class
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">t1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">nanoTime&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">findClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// this is the defining class loader; record the stats
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">sun&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">misc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">PerfCounter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getParentDelegationTime&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">addTime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">t0&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sun&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">misc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">PerfCounter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getFindClassTime&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">addElapsedTimeFrom&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sun&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">misc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">PerfCounter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getFindClasses&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">increment&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">resolve&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">resolveClass&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªé™å®šåçš„ç±»åªä¼šè¢«ä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½å¹¶è§£æžä½¿ç”¨ï¼Œåœ¨ç¨‹åºä¸­æ˜¯å”¯ä¸€çš„ï¼Œä¸ä¼šäº§ç”Ÿæ­§ä¹‰ã€‚&lt;/p>
&lt;p>åœ¨åŠ è½½æ—¶ï¼Œé¦–å…ˆä¼šåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ï¼Œå¦‚æžœå·²ç»åŠ è½½ï¼Œä¼šç›´æŽ¥è¿”å›žï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ã€‚&lt;/p>
&lt;p>å°è¯•åŠ è½½æ—¶ï¼Œä¸ä¼šè‡ªå·±è¿›è¡ŒåŠ è½½ï¼Œè€Œæ˜¯å°†è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œå½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½æ—¶ï¼Œæ‰ä¼šç”±è‡ªå·±å¤„ç†ã€‚&lt;/p></description></item><item><title>ç±»åŠ è½½æœºåˆ¶</title><link>https://emerywan.github.io/blog/p/java/jvm/class-loading/</link><pubDate>Sat, 06 Aug 2022 13:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/java/jvm/class-loading/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/24.jpeg" alt="Featured image of post ç±»åŠ è½½æœºåˆ¶" />&lt;h2 id="java-ç±»ç”Ÿå‘½å‘¨æœŸ">Java ç±»ç”Ÿå‘½å‘¨æœŸ&lt;/h2>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/life.png"
width="973"
height="331"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/life_hue0715323a61c74c3a1d0de4b0a99146c_113100_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/life_hue0715323a61c74c3a1d0de4b0a99146c_113100_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="java-class-life"
class="gallery-image"
data-flex-grow="293"
data-flex-basis="705px"
>&lt;/p>
&lt;h2 id="ç±»åŠ è½½è¿‡ç¨‹">ç±»åŠ è½½è¿‡ç¨‹&lt;/h2>
&lt;p>ç±»åŠ è½½ä¸»è¦æœ‰ä¸‰æ­¥ï¼š&lt;code>åŠ è½½ - é“¾æŽ¥ - åˆå§‹åŒ–&lt;/code>ã€‚&lt;/p>
&lt;h3 id="-åŠ è½½">ðŸ¥Ž åŠ è½½&lt;/h3>
&lt;p>åŠ è½½æ˜¯ä¸€ä¸ªè¯»å– Class æ–‡ä»¶ï¼Œå°†å…¶è½¬åŒ–ä¸ºæŸç§é™æ€æ•°æ®ç»“æž„å­˜å‚¨åœ¨æ–¹æ³•åŒºå†…ï¼Œå¹¶åœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªä¾¿äºŽè°ƒç”¨çš„ java.lang.Class ç±»åž‹çš„å¯¹è±¡çš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/loading.png"
width="707"
height="335"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/loading_hu8b469e8111e2814cd40ca0f04de26462_22328_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/loading_hu8b469e8111e2814cd40ca0f04de26462_22328_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="loading"
class="gallery-image"
data-flex-grow="211"
data-flex-basis="506px"
>&lt;/p>
&lt;p>åˆ†ä¸ºä¸‰æ­¥è¿›è¡Œï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>èŽ·å–å®šä¹‰ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼ˆä¸é™åˆ¶ä»Žå“ªé‡ŒèŽ·å–ï¼Œæ–‡ä»¶ã€ç½‘ç»œã€å³æ—¶ç”Ÿæˆï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å°†å­—èŠ‚æµä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æž„ï¼Œè½¬æ¢æˆæ–¹æ³•åŒºä¸­è¿è¡Œæ—¶æ•°æ®ç»“æž„&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ java.lang.Class å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®è®¿é—®å…¥å£&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="-é“¾æŽ¥">ðŸ¥Ž é“¾æŽ¥&lt;/h3>
&lt;h4 id="-éªŒè¯">âš¾ï¸ éªŒè¯&lt;/h4>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/verify.png"
width="915"
height="390"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/verify_hu8c1a3959f1e343b5f02da51e1aaf01f3_138925_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/verify_hu8c1a3959f1e343b5f02da51e1aaf01f3_138925_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="verify"
class="gallery-image"
data-flex-grow="234"
data-flex-basis="563px"
>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ–‡ä»¶æ ¼å¼éªŒè¯&lt;/p>
&lt;p>éªŒè¯å­—èŠ‚æµæ˜¯å¦ç¬¦åˆ Class æ–‡ä»¶æ ¼å¼çš„è§„èŒƒï¼Œèƒ½è¢«å½“å‰ç‰ˆæœ¬çš„è™šæ‹Ÿæœºå¤„ç†ã€‚&lt;strong>å‘ç”Ÿåœ¨åŠ è½½é˜¶æ®µ&lt;/strong>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å…ƒæ•°æ®ã€å­—èŠ‚ç éªŒè¯&lt;/p>
&lt;p>å¯¹å­—èŠ‚ç è¿›è¡Œè¯­æ³•ã€è¯­ä¹‰çš„åˆ†æžï¼Œä¿è¯å…¶ç¬¦åˆ Java è™šæ‹Ÿæœºçš„è§„èŒƒï¼Œä¸ä¼šæœ‰å±å®³è™šæ‹Ÿæœºçš„è¡Œä¸ºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç¬¦å·å¼•ç”¨éªŒè¯&lt;/p>
&lt;p>ç¡®ä¿è§£æžè¡Œä¸ºèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œã€‚&lt;strong>å‘ç”Ÿåœ¨è§£æžé˜¶æ®µ&lt;/strong>ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="-å‡†å¤‡">âš¾ï¸ å‡†å¤‡&lt;/h4>
&lt;p>ä¸ºç±»ä¸­å®šä¹‰çš„å˜é‡ï¼ˆé™æ€å˜é‡ &lt;code>static&lt;/code>ï¼‰åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡é›¶å€¼çš„é˜¶æ®µã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/prepare.png"
width="482"
height="260"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/prepare_hu58a397643ad84aca2032de9a3ac6155c_29464_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/prepare_hu58a397643ad84aca2032de9a3ac6155c_29464_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="prepare"
class="gallery-image"
data-flex-grow="185"
data-flex-basis="444px"
>&lt;/p>
&lt;ul>
&lt;li>&lt;code>static&lt;/code> -&amp;gt; èµ‹é›¶å€¼&lt;/li>
&lt;li>&lt;code>static final&lt;/code> -&amp;gt; èµ‹å®šä¹‰çš„å¸¸é‡å€¼&lt;/li>
&lt;/ul>
&lt;h4 id="-è§£æž">âš¾ï¸ è§£æž&lt;/h4>
&lt;p>è§£æžæ˜¯å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æŽ¥å¼•ç”¨ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ç¬¦å·å¼•ç”¨ï¼šæè¿°å¼•ç”¨å¯¹è±¡çš„ç¬¦å·&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç›´æŽ¥å¼•ç”¨ï¼šæŒ‡å‘ç›®æ ‡å®žé™…åœ°å€çš„æŒ‡é’ˆ&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ðŸŽ¾ è§£æžéƒ¨åˆ†æ˜¯çµæ´»çš„ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–çŽ¯èŠ‚åŽå†è¿›è¡Œï¼Œå®žçŽ°æ‰€è°“çš„â€œåŽæœŸç»‘å®šâ€ã€‚ï¼ˆæ–¹æ³•è°ƒç”¨ç›´åˆ°è¿è¡Œæ—¶æ‰ä¼šè§£æžï¼Œå› ä¸ºæ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šæ–¹æ³•è°ƒç”¨æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ‰€ä»¥æ–¹æ³•å®šä¹‰å’Œæ–¹æ³•è°ƒç”¨ç›´åˆ°è¿è¡Œæ—¶æ‰ç»‘å®šã€‚ï¼‰&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/resolve_1.png"
width="163"
height="370"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/resolve_1_hua9ef48196efa3564a4ef1eaa93606c3a_10102_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/resolve_1_hua9ef48196efa3564a4ef1eaa93606c3a_10102_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="resolve"
class="gallery-image"
data-flex-grow="44"
data-flex-basis="105px"
>&lt;/p>
&lt;p>å½“ä¸€ä¸ªç±»è¢«ç¼–è¯‘æˆ Class ä¹‹åŽï¼Œå‡è®¾è¿™ä¸ªç±»ç§°ä¸º &lt;code>A&lt;/code>ï¼Œå¹¶ä¸”åœ¨ &lt;code>A&lt;/code> ä¸­å¼•ç”¨äº†ç±» &lt;code>B&lt;/code>ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œ&lt;code>A&lt;/code> æ— æ³•ç¡®å®š &lt;code>B&lt;/code> æ˜¯å¦è¢«ç¼–è¯‘ï¼ˆçŽ°åœ¨ &lt;code>B&lt;/code> ä¸€å®šæœªåŠ è½½ï¼‰ï¼Œæ­¤æ—¶ &lt;code>A&lt;/code> æ— æ³•çŸ¥é“ &lt;code>B&lt;/code> çš„å®žé™…åœ°å€ï¼Œæ‰€æœ‰åœ¨ &lt;code>A.Class&lt;/code> ä¸­ï¼Œä¼šä½¿ç”¨ä¸€ä¸ª&lt;code>å­—ç¬¦ä¸²&lt;/code>ä»£è¡¨ &lt;code>B&lt;/code>ã€‚è¿™ä¸ªå­—ç¬¦ä¸²è¢«ç§°ä¸º&lt;strong>ç¬¦å·å¼•ç”¨&lt;/strong>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨è¿è¡Œé˜¶æ®µï¼Œ&lt;code>A&lt;/code> å‘ç”Ÿäº†åŠ è½½ï¼Œåœ¨è§£æžæ—¶ï¼Œå‘çŽ°å…¶ä¸­çš„ &lt;code>B&lt;/code> è¿˜æœªè¢«åŠ è½½ï¼Œå°±ä¼šè§¦å‘ç±» &lt;code>B&lt;/code> çš„åŠ è½½ï¼Œå°† &lt;code>B&lt;/code> åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚æ­¤æ—¶ï¼Œ&lt;code>A&lt;/code> ä¸­çš„ç¬¦å·å¼•ç”¨ä¼šè¢«æ›¿æ¢ä¸º &lt;code>B&lt;/code> ä¸­çš„å®žé™…åœ°å€ï¼ˆç›´æŽ¥å¼•ç”¨ï¼‰ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/resolve.png"
width="922"
height="538"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/resolve_hu45e5622ef4d0eaddcde37871cfee2a7a_117190_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/resolve_hu45e5622ef4d0eaddcde37871cfee2a7a_117190_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="resolve"
class="gallery-image"
data-flex-grow="171"
data-flex-basis="411px"
>&lt;/p>
&lt;ul>
&lt;li>é™æ€è§£æž&lt;/li>
&lt;/ul>
&lt;p>ç±» &lt;code>B&lt;/code> æ˜¯å…·ä½“çš„å®žçŽ°ç±»ï¼Œè§£æžçš„å¯¹è±¡ååˆ†æ˜Žç¡®ï¼Œå³ä¼šè¿›è¡Œé™æ€è§£æžã€‚&lt;/p>
&lt;ul>
&lt;li>åŠ¨æ€è§£æž&lt;/li>
&lt;/ul>
&lt;p>Java é€šè¿‡åŽæœŸç»‘å®šçš„æ–¹å¼å®žçŽ°å¤šæ€ï¼Œé€šè¿‡åŠ¨æ€è§£æžå®žçŽ°ã€‚&lt;/p>
&lt;p>å¦‚æžœç±» &lt;code>B&lt;/code> æ˜¯æŠ½è±¡ç±»æˆ–è€…æŽ¥å£ï¼Œæœ‰å…·ä½“çš„å®žçŽ°ç±» &lt;code>C&lt;/code>ã€&lt;code>D&lt;/code>ï¼Œå½“å‰å…·ä½“çš„å®žçŽ°æ–¹å¼å¹¶ä¸æ˜Žç¡®ï¼Œæ— æ³•ç¡®å®šä½¿ç”¨å“ªä¸ªå…·ä½“å®žçŽ°ã€‚&lt;/p>
&lt;p>ç›´åˆ°è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†è°ƒç”¨ï¼Œè™šæ‹Ÿæœºè°ƒç”¨æ ˆä¸­ä¼šå¾—åˆ°å…·ä½“ç±»çš„ä¿¡æ¯ï¼Œå†è¿›è¡Œè§£æžï¼Œå°±æœ‰æ˜Žç¡®çš„ç›´æŽ¥å¼•ç”¨ä»£æ›¿ç¬¦å·å¼•ç”¨ã€‚&lt;/p>
&lt;h3 id="-åˆå§‹åŒ–">ðŸ¥Ž åˆå§‹åŒ–&lt;/h3>
&lt;p>è™šæ‹ŸæœºçœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­ç¼–å†™çš„ä»£ç ï¼Œå®Œæˆä¸€äº›ä¸»åŠ¨çš„èµ„æºåˆå§‹åŒ–åŠ¨ä½œã€‚&lt;/p>
&lt;p>&lt;strong>æ‰§è¡Œçš„æ˜¯ç±»å±‚é¢çš„åˆå§‹åŒ–ã€‚&lt;/strong> åªæœ‰æ˜¾å¼è°ƒç”¨ new æ‰ä¼šæ‰§è¡Œæž„é€ å‡½æ•°çš„åˆå§‹åŒ–ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/init.png"
width="533"
height="388"
srcset="https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/init_hud5162327100fcc16da85dffebeccc0e0_46268_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/java/jvm/class-loading/init_hud5162327100fcc16da85dffebeccc0e0_46268_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="init"
class="gallery-image"
data-flex-grow="137"
data-flex-basis="329px"
>&lt;/p>
&lt;ul>
&lt;li>æˆå‘˜å˜é‡çš„ç›´æŽ¥èµ‹å€¼&lt;/li>
&lt;li>é™æ€å˜é‡çš„èµ‹å€¼&lt;/li>
&lt;li>é™æ€ä»£ç å—&lt;/li>
&lt;/ul>
&lt;h2 id="åˆ¤æ–­æ— ç”¨ç±»">åˆ¤æ–­æ— ç”¨ç±»&lt;/h2>
&lt;ul>
&lt;li>è¯¥ç±»çš„æ‰€æœ‰å®žä¾‹å¯¹è±¡å…¨éƒ¨è¢« GCï¼Œåœ¨å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®žä¾‹å¯¹è±¡&lt;/li>
&lt;li>è¯¥ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡ï¼Œåœ¨ä»»ä½•åœ°æ–¹éƒ½æ²¡æœ‰è¢«å¼•ç”¨&lt;/li>
&lt;li>è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›žæ”¶&lt;/li>
&lt;/ul>
&lt;p>æ»¡è¶³ä»¥ä¸Šä¸‰ä¸ªæ¡ä»¶ï¼Œè¯´æ˜Žè¯¥ç±»å¯ä»¥è¢«å›žæ”¶ï¼Œä½†æ˜¯ä¸Žå¯¹è±¡ä¸åŒï¼Œæ— ç”¨ç±»ä¸ä¸€å®šä¼šè¢«å›žæ”¶ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://javaguide.cn/java/jvm/class-loading-process.html" target="_blank" rel="noopener"
>https://javaguide.cn/java/jvm/class-loading-process.html&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://www.bilibili.com/video/BV14U4y1L75q/?spm_id_from=333.788" target="_blank" rel="noopener"
>https://www.bilibili.com/video/BV14U4y1L75q/?spm_id_from=333.788&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœº&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>ä½¿ç”¨ ZooKeeper å®žçŽ°åˆ†å¸ƒå¼é”</title><link>https://emerywan.github.io/blog/p/distributed-lock/zookeeper/</link><pubDate>Wed, 11 May 2022 21:14:45 +0800</pubDate><guid>https://emerywan.github.io/blog/p/distributed-lock/zookeeper/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/2.jpeg" alt="Featured image of post ä½¿ç”¨ ZooKeeper å®žçŽ°åˆ†å¸ƒå¼é”" />&lt;h2 id="ä½¿ç”¨-zookeeper-å®žçŽ°">ä½¿ç”¨ ZooKeeper å®žçŽ°&lt;/h2>
&lt;h3 id="åŽŸç†">åŽŸç†&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>æŒä¹…èŠ‚ç‚¹ï¼ˆçº¢è‰²ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>çž¬æ—¶èŠ‚ç‚¹ï¼ˆé»„è‰²ï¼‰ï¼šä¸å¯å†æœ‰å­èŠ‚ç‚¹ï¼Œä¼šè¯ç»“æŸåŽçž¬æ—¶èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ¶ˆå¤±&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/node.png"
width="542"
height="618"
srcset="https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/node_hubb94f897927986ed284f5e5898a8688d_78967_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/node_hubb94f897927986ed284f5e5898a8688d_78967_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="node"
class="gallery-image"
data-flex-grow="87"
data-flex-basis="210px"
>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>åˆ©ç”¨ Zookeeper çš„çž¬æ—¶æœ‰åºèŠ‚ç‚¹çš„ç‰¹æ€§ï¼Œå¤šçº¿ç¨‹å¹¶å‘åˆ›å»ºçž¬æ—¶èŠ‚ç‚¹æ—¶ï¼Œå¾—åˆ°æœ‰åºçš„åºåˆ—&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åºå·æœ€å°çš„çº¿ç¨‹èŽ·å¾—é”ï¼Œå…¶ä»–çš„çº¿ç¨‹åˆ™ç›‘å¬è‡ªå·±åºå·çš„å‰ä¸€ä¸ªåºå·ï¼›å½“å‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œåˆ é™¤è‡ªå·±åºå·çš„èŠ‚ç‚¹ï¼›ä¸‹ä¸€ä¸ªåºå·çš„çº¿ç¨‹å¾—åˆ°é€šçŸ¥ï¼Œå°†ç»§ç»­æ‰§è¡Œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆ›å»ºèŠ‚ç‚¹æ—¶ï¼Œå·²ç»ç¡®å®šäº†çº¿ç¨‹çš„æ‰§è¡Œé¡ºåº&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/thread.png"
width="485"
height="297"
srcset="https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/thread_hu0d11f519269d68572311b436f0d9b410_73659_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/thread_hu0d11f519269d68572311b436f0d9b410_73659_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="thread"
class="gallery-image"
data-flex-grow="163"
data-flex-basis="391px"
>&lt;/p>
&lt;h3 id="å®žçŽ°">å®žçŽ°&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;span class="lnt">94
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZkLock&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">AutoCloseable&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Watcher&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">ZooKeeper&lt;/span> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">znode&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// å½“å‰çº¿ç¨‹åˆ›å»ºçš„è·¯å¾„
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">ZkLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">connectString&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">sessionTimeout&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">IOException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">zooKeeper&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZooKeeper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">connectString&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">sessionTimeout&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * try-catch-with-resource
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">clode&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">delete&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">znode&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;é‡Šæ”¾é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * è§‚å¯Ÿå™¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">process&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">WatchedEvent&lt;/span> &lt;span class="n">watchedEvent&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å½“å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤æ—¶ï¼Œå¯å”¤é†’èŽ·å–é”çš„ç­‰å¾…ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹èŽ·å–äº†é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">watchedEvent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getType&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Event&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">EventType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">NodeDeleted&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">synchronized&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">notify&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * èŽ·å–é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">getLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">businessCode&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">businessCode&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Stat&lt;/span> &lt;span class="n">stat&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">exists&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">stat&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// å½“å‰ä¸šåŠ¡è‹¥æ²¡æœ‰æŒä¹…èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// å…ˆåˆ›å»ºä¸€ä¸ªæŒä¹…èŠ‚ç‚¹ï¼Œåœ¨æŒä¹…èŠ‚ç‚¹é‡Œåˆ›å»ºçž¬æ—¶èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">businessCode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBytes&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">StandardCharsets&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">UTF_8&lt;/span>&lt;span class="o">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ZooDefs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Ids&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">OPEN_ACL_UNSAFE&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="c1">// å…¬å¼€æƒé™ï¼Œä¸ä½¿ç”¨ç”¨æˆ·åå¯†ç å°±èƒ½è®¿é—®è¿™ä¸ªèŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">CreateMode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">PERSISTENT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºçž¬æ—¶æœ‰åºèŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">subPath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">businessCode&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">businessCode&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;_&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">znode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">subPath&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">businessCode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBytes&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">StandardCharsets&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">UTF_8&lt;/span>&lt;span class="o">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ZooDefs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Ids&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">OPEN_ACL_UNSAFE&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">CreateMode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">EPHEMERAL_SEQUENTIAL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// èŽ·å–è¯¥ä¸šåŠ¡ä¸‹çš„æ‰€æœ‰çž¬æ—¶èŠ‚ç‚¹ï¼Œè¿›è¡Œæ¯”è¾ƒæŽ’åº
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">childrenNodes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getChildren&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Collections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sort&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">childrenNodes&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æžœåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ˜¯å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹ï¼Œç›´æŽ¥èŽ·å–é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">firstNode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">childrenNodes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">znode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">endsWith&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">firstNode&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç­‰å¾…èŽ·å–é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">lastNode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">firstNode&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">node&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">childrenNode&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ‰¾åˆ°å½“å‰èŠ‚ç‚¹ï¼Œç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">znode&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">endWith&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">zooKeeper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">exists&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">businessCode&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lastNode&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lastNode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">synchronized&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®©å½“å‰çº¿ç¨‹é˜»å¡žï¼Œå¹¶ä¸”ä¼šé‡Šæ”¾é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸Šé¢çš„åŒæ­¥ä»£ç å—æ‰ä¼šèŽ·å¾—é”å¹¶æ‰§è¡Œ notify()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">wait&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">KeeperException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æµ‹è¯•">æµ‹è¯•&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Slf4j&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RestController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ZkLockController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@GetMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/zkLock&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">zkLock&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;è¿›å…¥æ–¹æ³•&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">ZkLock&lt;/span> &lt;span class="n">zklock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ZkLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;127.0.0.1:2181&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">10000&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">zkLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;order&amp;#34;&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;èŽ·å–äº†é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeUtil&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// æ¨¡æ‹Ÿä¸šåŠ¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;å®Œæˆä¸šåŠ¡&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;success&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="curator">Curator&lt;/h2>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/curator.png"
width="537"
height="87"
srcset="https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/curator_hu690a82169c4c3fdc258308de88a2c62f_35331_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/distributed-lock/zookeeper/curator_hu690a82169c4c3fdc258308de88a2c62f_35331_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="curator"
class="gallery-image"
data-flex-grow="617"
data-flex-basis="1481px"
>&lt;/p>
&lt;h3 id="ä¾èµ–é…ç½®">ä¾èµ–é…ç½®&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.apache.curator&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>curator-recipes&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>4.2.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å®žçŽ°-1">å®žçŽ°&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Slf4j&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DemoTest&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">test&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">zookeeperConnectionString&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;127.0.0.1:2181&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RetryPolicy&lt;/span> &lt;span class="n">retryPolicy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ExponentialBackoffRetry&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">CuratorFramework&lt;/span> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CuratorFrameworkFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newClient&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">zookeeperConnectionString&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">retryPolicy&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">lockPath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;/order&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">InterProcessMutex&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">InterProcessMutex&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">lockPath&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// èŽ·å–äº’æ–¥é”ï¼Œé˜»å¡žç›´åˆ°å¯ç”¨ï¼Œæˆ–ç»™å®šæ—¶é—´åˆ°æœŸ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// åŒä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ acquire() å¯é‡å…¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">acquire&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">30&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;èŽ·å–é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¿…é¡»é€šè¿‡ release() é‡Šæ”¾é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">release&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>ä½¿ç”¨ Redis å®žçŽ°åˆ†å¸ƒå¼é”</title><link>https://emerywan.github.io/blog/p/distributed-lock/redis/</link><pubDate>Wed, 11 May 2022 12:14:45 +0800</pubDate><guid>https://emerywan.github.io/blog/p/distributed-lock/redis/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/1.jpeg" alt="Featured image of post ä½¿ç”¨ Redis å®žçŽ°åˆ†å¸ƒå¼é”" />&lt;h2 id="redis-nx-å®žçŽ°">Redis NX å®žçŽ°&lt;/h2>
&lt;p>åˆ©ç”¨ NX çš„&lt;strong>åŽŸå­æ€§&lt;/strong>ï¼Œå¤šä¸ªçº¿ç¨‹å¹¶å‘æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¾ç½®æˆåŠŸï¼Œè®¾ç½®æˆåŠŸå³èŽ·å–äº†é”ã€‚&lt;/p>
&lt;p>&lt;strong>å¦‚æžœæ²¡æœ‰èŽ·å–é”ï¼Œä¸ä¼šé˜»å¡žå½“å‰æ–¹æ³•ï¼Œç›´æŽ¥è·³è¿‡ä»»åŠ¡ã€‚&lt;/strong>&lt;/p>
&lt;h3 id="èŽ·å–é”">èŽ·å–é”&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># set key unique_value NX PX 30000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> product:stock:clothes UUID NX PX &lt;span class="m">30000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>key
&lt;ul>
&lt;li>æ ¹æ®ä¸åŒçš„ä¸šåŠ¡ï¼ŒåŒºåˆ†ä¸åŒçš„é”&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>unique_value
&lt;ul>
&lt;li>ä¿è¯æ¯ä¸ªçº¿ç¨‹çš„éšæœºå€¼éƒ½ä¸åŒï¼Œç”¨äºŽé‡Šæ”¾é”æ—¶çš„æ ¡éªŒ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>NX
&lt;ul>
&lt;li>key ä¸å­˜åœ¨æ—¶è®¾ç½®æˆåŠŸï¼Œkey å­˜åœ¨åˆ™ä¸æˆåŠŸ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>PX
&lt;ul>
&lt;li>è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ã€‚è‹¥å‡ºçŽ°å¼‚å¸¸ï¼Œæ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”ï¼Œå¯ä»¥ä¿è¯è¶…æ—¶åŽï¼Œé”å¯ä»¥è¿‡æœŸå¤±æ•ˆï¼ˆæ¯«ç§’ï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="é‡Šæ”¾é”">é‡Šæ”¾é”&lt;/h3>
&lt;p>é‡Šæ”¾é”å°†è¯¥ key åˆ é™¤ï¼Œåœ¨é‡Šæ”¾é”ä¹‹å‰éœ€è¦æ ¡éªŒè®¾ç½®çš„éšæœºæ•°ï¼Œç›¸åŒæ‰è¡¨ç¤ºæ˜¯è¯¥çº¿ç¨‹åŠ çš„é”ï¼Œèƒ½é‡Šæ”¾ã€‚&lt;/p>
&lt;p>éœ€è¦é‡‡ç”¨ LUA è„šæœ¬ï¼Œdel å‘½ä»¤æ²¡æœ‰æä¾›æ ¡éªŒå€¼çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>redis æ‰§è¡Œå‘½ä»¤æ˜¯æŒ‰ç…§ä¸€æ¡æŒ‡ä»¤å®Œæˆä¹‹åŽï¼Œå†æ‰§è¡Œä¸‹ä¸€æ¡ï¼Œç”¨ lua è„šæœ¬ï¼Œèƒ½ä¿è¯ redis æ‰§è¡Œå®Œè¿™ä¸ªè„šæœ¬æ‰æ‰§è¡Œä¸‹ä¸€æ¡ï¼Œæ‰€ä»¥èƒ½ä¿è¯åˆ¤æ–­ å’Œ åˆ é™¤æ˜¯åŽŸå­æ€§çš„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;del&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å®žçŽ°">å®žçŽ°&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Slf4j&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RestController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">RedisLockController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Autowired&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">RedisTemplate&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@GetMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/redisLock&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">redisLock&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// èŽ·å–åˆ†å¸ƒå¼é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">Boolean&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">RedisCallback&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">redisConnection&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Expiration&lt;/span> &lt;span class="n">expiration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Expiration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">seconds&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">30&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// NX
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">RedisStringCommands&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SetOption&lt;/span> &lt;span class="n">setOption&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RedisStringCommands&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SetOption&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ifAbsent&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// éœ€è¦ä½¿ç”¨ redisTemplate ä¸­çš„åºåˆ—åŒ–å™¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">redisKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKeySerializer&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">serialize&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">redisValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValueSerializer&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">serialize&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">redisConnection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">redisKey&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">redisValue&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">expiration&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// èŽ·å–åˆ°äº†é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;èŽ·å–åˆ°äº†é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">15&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">script&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;if redis.call(\&amp;#34;get\&amp;#34;,KEYS[1])==ARGV[1] then\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;\treturn redis.call(\&amp;#34;del\&amp;#34;,KEYS[1])\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;else\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;\treturn 0\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;end&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RedisScript&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">redisScript&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RedisScript&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">of&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">script&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Boolean&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">redisScript&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">),&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;é‡Šæ”¾é” {}&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ä¸šåŠ¡å®Œæˆ&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;success&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Slf4j&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RestController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">RedisLock&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">RedisTemplate&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é”åç§°ï¼Œä¸åŒä¸šåŠ¡å¯èƒ½é”ä¸åŒ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é”è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">expireTime&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">RedisLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">RedisTemplate&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">expireTime&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">redisTemplate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">expireTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">expireTime&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// value å¯ä»¥ä¸æš´éœ²å‡ºåŽ»ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯ä¸ä¸€æ ·çš„
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">UUID&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">randomUUID&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * èŽ·å–é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">getLock&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// èŽ·å–åˆ†å¸ƒå¼é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">Boolean&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">RedisCallback&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">redisConnection&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Expiration&lt;/span> &lt;span class="n">expiration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Expiration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">seconds&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">expireTime&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// NX
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">RedisStringCommands&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SetOption&lt;/span> &lt;span class="n">setOption&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RedisStringCommands&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SetOption&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ifAbsent&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç”±äºŽè¿™é‡Œéœ€è¦æŽ¥å— byte, ä¸èƒ½æš´åŠ›çš„ä½¿ç”¨ string.getBytes()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¦ä½¿ç”¨æ¨¡æ¿é‡Œé¢çš„ key\value åºåˆ—åŒ–å™¨æ¥å®žçŽ°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">redisKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKeySerializer&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">serialize&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">redisValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValueSerializer&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">serialize&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Boolean&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redisConnection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">redisKey&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">redisValue&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">expiration&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">setOption&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * é‡Šæ”¾é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">unLock&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// lua è„šæœ¬
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">script&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;if redis.call(\&amp;#34;get\&amp;#34;,KEYS[1])==ARGV[1] then\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;\treturn redis.call(\&amp;#34;del\&amp;#34;,KEYS[1])\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;else\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;\treturn 0\n&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;end&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RedisScript&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">redisScript&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RedisScript&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">of&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">script&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Boolean&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Boolean&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">redisTemplate&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">redisScript&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">),&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="redisson">Redisson&lt;/h2>
&lt;h3 id="ä¾èµ–é…ç½®">ä¾èµ–é…ç½®&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.redisson&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>redisson-spring-boot-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>3.16.7&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å®žçŽ°-1">å®žçŽ°&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Slf4j&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RestController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">RedissonLockController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Autowired&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">RedissonClient&lt;/span> &lt;span class="n">redissonClient&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@GetMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/redissonLock&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">redissonLock&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;æ‰§è¡Œæ–¹æ³•&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;redisson&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redissonClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é”è¶…æ—¶æ—¶é—´ï¼Œå¦‚æžœæœªèŽ·å¾—é”ï¼Œä¼šé˜»å¡žç­‰å¾…èŽ·å–åˆ°é”ï¼ˆ-1 è¡¨ç¤ºæ²¡æœ‰è¶…æ—¶æ—¶é—´ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">30&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;èŽ·å–é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;é‡Šæ”¾é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;å®Œæˆä¸šåŠ¡&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;success&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Java å¹¶å‘ - CyclicBarrier å®žçŽ°åŽŸç†</title><link>https://emerywan.github.io/blog/p/thread/cyclicbarrier/</link><pubDate>Tue, 03 May 2022 23:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/cyclicbarrier/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/14.jpeg" alt="Featured image of post Java å¹¶å‘ - CyclicBarrier å®žçŽ°åŽŸç†" />&lt;h2 id="åŽŸç†">åŽŸç†&lt;/h2>
&lt;p>&lt;code>CyclicBarrier&lt;/code> é€šè¿‡å¯é‡å…¥é” &lt;code>CyclicBarrier&lt;/code> å®žçŽ°ï¼Œå†…éƒ¨ä½¿ç”¨é™æ€å†…éƒ¨ç±» &lt;code>Generation&lt;/code> ç»´æŠ¤ &lt;code>broken&lt;/code> æ ‡è®°ï¼Œè¡¨ç¤ºå±éšœæ˜¯å¦å¯ç”¨ã€‚&lt;/p>
&lt;p>é€šè¿‡æž„é€ æ–¹æ³•ä¼ å…¥ç­‰å¾…çº¿ç¨‹æ•° &lt;code>parties&lt;/code>ã€‚&lt;/p>
&lt;p>æ¯æ¬¡æœ‰ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœï¼Œ &lt;code>count - 1&lt;/code>ï¼Œç›´åˆ° &lt;code>count = 0&lt;/code>ï¼Œä¼šé‡Šæ”¾å±éšœï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œå¹¶ä½¿ç”¨ &lt;code>nextGeneration()&lt;/code> å¯¹ &lt;code>count&lt;/code> å’Œ &lt;code>generation&lt;/code> è¿›è¡Œé‡ç½®ï¼Œè¿›è¡Œä¸‹ä¸€è½®å¾ªçŽ¯ã€‚&lt;/p>
&lt;p>æœ‰ä¸‰ç§æƒ…å†µä¼šé€ æˆå±éšœç ´åï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>CyclicBarrier Runnable command æ–¹æ³•æŠ›å‡ºå¼‚å¸¸&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨é‡Šæ”¾æ¡ä»¶è¿˜æœªè¾¾åˆ°æ—¶ï¼ŒæŸä¸ªçº¿ç¨‹æŠ›å‡ºäº†å¼‚å¸¸&lt;/p>
&lt;/li>
&lt;li>
&lt;p>await() ç­‰å¾…è¶…æ—¶&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="æºç ">æºç &lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">CyclicBarrier&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å†…éƒ¨ç±»ï¼Œå­˜æ”¾ broken æ ‡è®°ï¼Œè¡¨ç¤ºå±éšœæ˜¯å¦è¢«æŸåï¼ŒæŸååŽæ— æ³•æ­£å¸¸å·¥ä½œ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Generation&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">broken&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¯é‡å…¥é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReentrantLock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Condition&lt;/span> &lt;span class="n">trip&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newCondition&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å±éšœé˜»æŒ¡çš„çº¿ç¨‹æ•°ï¼Œæž„é€ æ–¹æ³•ä¼ å…¥çš„åˆå§‹åŒ–å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å±éšœé‡Šæ”¾æ—¶æ‰§è¡Œçš„æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="n">barrierCommand&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å½“å‰çš„ Generation å¯¹è±¡ï¼Œæ¯ä¸€è½®éƒ½ä¼šæœ‰ä¸€ä¸ªæ–°çš„ Generation å¯¹è±¡ï¼Œå­˜æ”¾ broken æ ‡è®°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="n">Generation&lt;/span> &lt;span class="n">generation&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Generation&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å½“å‰è¿˜éœ€è¦é˜»æŒ¡å‡ ä¸ªçº¿ç¨‹ï¼Œæ¯æ¬¡ -1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¼€å¯ä¸‹ä¸€è½®å±éšœï¼ˆcount==0 æˆ– resetï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">nextGeneration&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">trip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">signalAll&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é‡ç½® count
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">generation&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Generation&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç ´åå½“å‰å±éšœï¼Œå˜ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨ reset æ¢å¤
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">breakBarrier&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">generation&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">broken&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">signalAll&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">dowait&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">boolean&lt;/span> &lt;span class="n">timed&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">nanos&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">BrokenBarrierException&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeoutException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åŠ é”ï¼Œæœ‰å¤šä¸ªçº¿ç¨‹ä¼šè°ƒç”¨ await() åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¿›å…¥åŒæ­¥æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">Generation&lt;/span> &lt;span class="n">g&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">generation&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">g&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">broken&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="c1">// å±éšœæ˜¯å¦æŸå
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BrokenBarrierException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">interrupted&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">breakBarrier&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">InterruptedException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">index&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// è¾¾åˆ°æ¡ä»¶ï¼Œå¯æ‰“ç ´å±éšœ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">ranAction&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="n">command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">barrierCommand&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="c1">// æ‰§è¡Œæ‰“ç ´å±éšœçš„å‘½ä»¤
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ranAction&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nextGeneration&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// å¼€å¯ä¸‹ä¸€è½®å¾ªçŽ¯ï¼Œé‡Œé¢ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">ranAction&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="c1">// (1) å‡å¦‚ command å‡ºçŽ°å¼‚å¸¸ï¼Œç ´åå±éšœ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">breakBarrier&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å½“å‰è¿˜æœªè¾¾åˆ°å†²ç ´å±éšœçš„çš„æ¡ä»¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸€ç›´å¾ªçŽ¯ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æ‰“ç ´å±éšœçš„æ¡ä»¶ï¼Œä¸­æ–­ï¼Œæˆ–è¶…æ—¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="o">(;;)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">timed&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// æœªè¾¾åˆ°è¶…æ—¶æ—¶é—´ï¼Œè¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">nanos&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">0L&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nanos&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">trip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">awaitNanos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">nanos&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">ie&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// (2) ç­‰å¾…åˆ°è¾¾æ¡ä»¶æ—¶ï¼Œçº¿ç¨‹è¢«ä¸­æ–­ï¼Œç ´åå±éšœ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">g&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">generation&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span> &lt;span class="n">g&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">broken&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">breakBarrier&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="n">ie&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// We&amp;#39;re about to finish waiting even if we had not
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// been interrupted, so this interrupt is deemed to
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// &amp;#34;belong&amp;#34; to subsequent execution.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">interrupt&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">g&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">broken&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="c1">// çº¿ç¨‹è¢«å”¤é†’ä¹‹åŽï¼Œå±éšœè¢«ç ´åï¼Œç›´æŽ¥æŠ›å‡ºå¼‚å¸¸
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BrokenBarrierException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">g&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">generation&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="c1">// è¿”å›žå½“å‰çº¿ç¨‹æ˜¯ç¬¬å‡ ä¸ªåˆ°è¾¾çš„çº¿ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">timed&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">nanos&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">0L&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// (3) ç­‰å¾…è¶…æ—¶ï¼Œç ´åå±éšœ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">breakBarrier&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">TimeoutException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">CyclicBarrier&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="n">barrierAction&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">parties&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalArgumentException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">parties&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">barrierCommand&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">barrierAction&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">CyclicBarrier&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">parties&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">getParties&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">parties&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¼€å§‹ç­‰å¾… è¿”å›žå½“å‰çº¿ç¨‹æ˜¯ç¬¬å‡ ä¸ªåˆ°è¾¾çš„çº¿ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">await&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">BrokenBarrierException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">dowait&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">0L&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">TimeoutException&lt;/span> &lt;span class="n">toe&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">toe&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// cannot happen
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">await&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">long&lt;/span> &lt;span class="n">timeout&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BrokenBarrierException&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeoutException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">dowait&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toNanos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">timeout&lt;/span>&lt;span class="o">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ¤æ–­å±éšœæ˜¯å¦è¢«ç ´å
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">isBroken&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// éœ€åŠ é”è®¿é—®ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½åœ¨æ‰§è¡Œ dowait()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">generation&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">broken&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é‡ç½®æ“ä½œ å…ˆç ´åå±éšœï¼Œå†è¿›è¡Œä¸‹ä¸€è½®å¾ªçŽ¯å±éšœ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">reset&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">breakBarrier&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// break the current generation
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">nextGeneration&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// start a new generation
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// èŽ·å–ç­‰å¾…çº¿ç¨‹æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">getNumberWaiting&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">parties&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Java å¹¶å‘ - CountDownLatch å®žçŽ°åŽŸç†</title><link>https://emerywan.github.io/blog/p/thread/countdownlatch/</link><pubDate>Tue, 03 May 2022 14:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/countdownlatch/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/6.jpeg" alt="Featured image of post Java å¹¶å‘ - CountDownLatch å®žçŽ°åŽŸç†" />&lt;h2 id="åŸºæœ¬å®žçŽ°æ€è·¯">åŸºæœ¬å®žçŽ°æ€è·¯ï¼š&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>åˆ©ç”¨ &lt;strong>å…±äº«é”&lt;/strong> å®žçŽ°&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆå§‹åŒ–æ—¶ï¼Œ&lt;code>state=count&lt;/code> å³å·²ç»ä¸Šäº† &lt;code>count&lt;/code> æ¬¡å…±äº«é”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>await()&lt;/code> å³åŠ å…±äº«é”ï¼Œå¿…é¡» &lt;code>state=0&lt;/code> æ—¶æ‰èƒ½åŠ é”æˆåŠŸï¼Œå¦åˆ™æŒ‰ç…§ AQS æœºåˆ¶ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—é˜»å¡ž&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>countDown()&lt;/code> è§£ä¸€æ¬¡é”ï¼Œç›´åˆ°ä¸º &lt;code>0&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="æºç ">æºç &lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">CountDownLatch&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å†…éƒ¨ç±»å®žçŽ° AQS
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Sync&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">AbstractQueuedSynchronizer&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">serialVersionUID&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">4982264981922014374L&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Sync&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// ä½¿ç”¨ AQS çš„ state ä½œä¸ºè®¡æ•°å™¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">setState&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="nf">getCount&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">getState&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é‡‡ç”¨ **å…±äº«é”** æœºåˆ¶ï¼Œå› ä¸ºå¯ä»¥è¢«ä¸åŒçš„çº¿ç¨‹ countdown
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">protected&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">tryAcquireShared&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">acquires&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">getState&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="n">1&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">protected&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">tryReleaseShared&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">releases&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ¯æ¬¡æ‰§è¡Œå°† state-1ï¼Œç›´åˆ° state=0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="o">(;;)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getState&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">nextc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">compareAndSetState&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">nextc&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="c1">// é€šè¿‡ CAS æ”¹å˜ state çš„å€¼ï¼Œå¤±è´¥ä¼šè¿›è¡Œä¸‹ä¸€è½®å¾ªçŽ¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">nextc&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Sync&lt;/span> &lt;span class="n">sync&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">CountDownLatch&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">IllegalArgumentException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;count &amp;lt; 0&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sync&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Sync&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€šè¿‡ acquireSharedInterruptibly èŽ·å–å…±äº«é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// è‹¥ state!=0 ä¼šè¢«æŒç»­é˜»å¡ž
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">await&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sync&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">acquireSharedInterruptibly&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// 1 è¿™é‡Œæ˜¯éšæ„çš„å‚æ•°ï¼Œåœ¨ coutdownlatch ä¸­æ— æ„ä¹‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">await&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">long&lt;/span> &lt;span class="n">timeout&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">sync&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">tryAcquireSharedNanos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toNanos&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">timeout&lt;/span>&lt;span class="o">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è§£é”ä¸€æ¬¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">countDown&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sync&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">releaseShared&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// èŽ·å–å½“å‰è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="nf">getCount&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">sync&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getCount&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">toString&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kd">super&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;[Count = &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sync&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getCount&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;]&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Java å¹¶å‘ - å¹¶å‘å®‰å…¨çš„å®¹å™¨</title><link>https://emerywan.github.io/blog/p/thread/collection/</link><pubDate>Fri, 29 Apr 2022 14:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/collection/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/16.jpeg" alt="Featured image of post Java å¹¶å‘ - å¹¶å‘å®‰å…¨çš„å®¹å™¨" />&lt;h2 id="-é—ç•™çš„å®‰å…¨é›†åˆ">ðŸš§ é—ç•™çš„å®‰å…¨é›†åˆ&lt;/h2>
&lt;p>å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>Hashtable&lt;/li>
&lt;li>Vector&lt;/li>
&lt;/ul>
&lt;p>è¿™äº›é›†åˆçš„å®žçŽ°æ–¹å¼ç®€å•ç²—æš´ï¼Œåœ¨æ–¹æ³•ä¸Šç›´æŽ¥ä½¿ç”¨ &lt;code>synchronized&lt;/code> è¿›è¡Œä¿®é¥°ï¼Œåœ¨è¿›è¡Œè¯»å†™ç­‰æ“ä½œæ—¶ï¼Œä¼šé”ä½æ•´ä¸ªå¯¹è±¡ï¼Œå¹¶å‘æ€§èƒ½ä¸å¤ªå¥½ã€‚&lt;/p>
&lt;h2 id="-collections-å®‰å…¨é›†åˆ">ðŸ“¦ Collections å®‰å…¨é›†åˆ&lt;/h2>
&lt;p>å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>Collections.synchronizedCollection(Collection&lt;!-- raw HTML omitted --> c)&lt;/li>
&lt;li>Collections.synchronizedList(List&lt;!-- raw HTML omitted --> list)&lt;/li>
&lt;li>Collections.synchronizedMap(Map&amp;lt;K,V&amp;gt; m)&lt;/li>
&lt;li>Collections.synchronizedSet(Set&lt;!-- raw HTML omitted --> s)&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„é›†åˆï¼Œè¿”å›žä¸€ä¸ª Collections å†…éƒ¨çš„é™æ€ç±»å¯¹è±¡ï¼Œç”¨äºŽå°†ä¸€ä¸ªä¸å®‰å…¨çš„é›†åˆå˜æˆä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é›†åˆã€‚&lt;/p>
&lt;p>è¯¥æ–¹æ³•ä¼šå°†ä¼ å…¥çš„é›†åˆä½œä¸ºæˆå‘˜å˜é‡ï¼Œæ¯æ¬¡æ“ä½œæ—¶ï¼Œéƒ½ä½¿ç”¨ &lt;code>synchronized&lt;/code> åŠ é”ï¼Œé”ä½ &lt;code>mutex&lt;/code>ï¼ˆMap ä¸­ä¸ºå½“å‰å¯¹è±¡ thisï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SynchronizedMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">Serializable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">serialVersionUID&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">1978198479659022715L&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// Backing Map
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">mutex&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="c1">// Object on which to synchronize
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">SynchronizedMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Objects&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">requireNonNull&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mutex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">SynchronizedMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">mutex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">mutex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mutex&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">size&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">synchronized&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="k">return&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">();}&lt;/span> &lt;span class="c1">// æ“ä½œéƒ½ä¼šé”ä½ mutex
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ... å…¶ä»–æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="-juc-å®‰å…¨é›†åˆ">ðŸ›  JUC å®‰å…¨é›†åˆ&lt;/h2>
&lt;p>&lt;code>java.util.concurrent&lt;/code> ä¸‹æä¾›çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>Concurrent ç³»åˆ—ï¼ˆé€‚åˆå†™å¤šçš„åœºæ™¯ï¼Œå†…éƒ¨ä½¿ç”¨ CAS ä¼˜åŒ–ï¼‰&lt;/li>
&lt;li>CopyOnWrite ç³»åˆ—ï¼ˆé€‚åˆäºŽè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼‰&lt;/li>
&lt;li>Blocking ç³»åˆ—ï¼ˆé˜»å¡žé˜Ÿåˆ—ï¼‰&lt;/li>
&lt;/ul>
&lt;h3 id="concurrent">Concurrent&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ConcurrentHashMap&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ConcurrentLinkedQueue&lt;/code> / &lt;code>ConcurrentLinkedDeque&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ConcurrentSkipListMap&lt;/code> / &lt;code>ConcurrentSkipListSet&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="copyonwrite">CopyOnWrite&lt;/h3>
&lt;ul>
&lt;li>&lt;code>CopyOnWriteArrayList&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>é‡‡ç”¨äº†å†™å…¥æ—¶æ‹·è´çš„æ€æƒ³ï¼Œæ›´æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œæ›´æ”¹åœ¨æ–°çš„æ•°ç»„ä¸Šæ‰§è¡Œï¼Œå¹¶å‘æ—¶è¯»å†™æ“ä½œè¾¾åˆ°è¯»å†™åˆ†ç¦»ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">elements&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getArray&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">elements&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">newElements&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">copyOf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">elements&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">len&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">newElements&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">setArray&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">newElements&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// æ›¿æ¢æ•°ç»„
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯»æ“ä½œä¸è¿›è¡ŒåŠ é”ã€‚é€‚åˆäºŽè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@SuppressWarnings&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;unchecked&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="n">E&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="o">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="n">E&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">getArray&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>CopyOnWriteArraySet&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;code>CopyOnWriteArraySet&lt;/code> å†…éƒ¨ç”± &lt;code>CopyOnWriteArrayList&lt;/code> å®žçŽ°&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">CopyOnWriteArraySet&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">AbstractSet&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">implements&lt;/span> &lt;span class="n">java&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">io&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Serializable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">CopyOnWriteArraySet&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">al&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">CopyOnWriteArrayList&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="é˜»å¡žé˜Ÿåˆ—">é˜»å¡žé˜Ÿåˆ—&lt;/h3>
&lt;p>æœ‰ç•Œé˜Ÿåˆ—ï¼šæœ‰å›ºå®šå¤§å°çš„é˜Ÿåˆ—ã€‚&lt;/p>
&lt;p>æ— ç•Œé˜Ÿåˆ—ï¼šæ²¡æœ‰å›ºå®šå¤§å°çš„é˜Ÿåˆ—&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ArrayBlockingQueue&lt;/code>&lt;/p>
&lt;ul>
&lt;li>æœ‰ç•Œå¸¦ç¼“å†²é˜»å¡žé˜Ÿåˆ—ï¼Œæ•°ç»„å®žçŽ°&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>LinkedBlockingQueue&lt;/code>&lt;/p>
&lt;ul>
&lt;li>ç”±ç•Œå¸¦ç¼“å†²é˜»å¡žé˜Ÿåˆ— (Integer.MAX_VALUE)ï¼Œé“¾è¡¨å®žçŽ°ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸Šé™&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>LinkedBlockingDeque&lt;/code>&lt;/p>
&lt;ul>
&lt;li>åŒç«¯é˜Ÿåˆ—&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>DelayQueue&lt;/code>&lt;/p>
&lt;ul>
&lt;li>å»¶æ—¶æ— ç•Œé˜»å¡žé˜Ÿåˆ—ï¼Œåªå…è®¸å­˜æ”¾å¯ä»¥å»¶æ—¶çš„å…ƒç´ ï¼Œé˜Ÿåˆ— head æ˜¯æœ€å…ˆåˆ°æœŸçš„ï¼Œå¦‚æžœé˜Ÿåˆ—ä¸­å…ƒç´ æ²¡æœ‰åˆ°æœŸï¼Œå°±ç®—é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ä¹Ÿä¸èƒ½èŽ·å–åˆ°&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>SynchronousQueue&lt;/code>&lt;/p>
&lt;ul>
&lt;li>æ²¡æœ‰å®¹é‡çš„åŒæ­¥é˜Ÿåˆ—ï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸€ä¸ª put å¿…é¡»è¦ç­‰å¾…ä¸€ä¸ª take æ“ä½œ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>PriorityBlockingQueue&lt;/code>&lt;/p>
&lt;ul>
&lt;li>æ— ç•Œä¼˜å…ˆé˜»å¡žé˜Ÿåˆ—ï¼ŒPriorityQueue çš„çº¿ç¨‹å®‰å…¨ç‰ˆï¼Œä¸å…è®¸å­˜æ”¾ null&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="å¸¸ç”¨æ–¹æ³•">å¸¸ç”¨æ–¹æ³•&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="nc">BloockingQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">Queue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é˜Ÿåˆ—æ»¡æŠ›å‡ºå¼‚å¸¸
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">add&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ— å…ƒç´ æŠ›å‡ºå¼‚å¸¸
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">o&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// é˜Ÿåˆ—æ»¡è¿”å›ž false æˆåŠŸæ·»åŠ  true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">offer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é˜Ÿåˆ—ä¸ºç©ºè¿”å›ž null
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">E&lt;/span> &lt;span class="nf">poll&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é˜»å¡žæ—¶ç­‰å¾…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜»å¡žè¿›è¡Œç­‰å¾…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œé˜»å¡žè¿›è¡Œç­‰å¾…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">E&lt;/span> &lt;span class="nf">take&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="linkedblockingqueue">LinkedBlockingQueue&lt;/h4>
&lt;p>åœ¨ &lt;code>LinkedBlockingQeque&lt;/code> ä¸­ä½¿ç”¨äº† dummy èŠ‚ç‚¹å’Œä¸¤æŠŠé”ï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰§è¡Œ &lt;code>put&lt;/code> å’Œ &lt;code>take&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">putLock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReentrantLock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">takeLock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReentrantLock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>put&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">E&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">e&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NullPointerException&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Node&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">node&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Node&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">putLock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">putLock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicInteger&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">count&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">putLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lockInterruptibly&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æžœå®¹é‡å·²æ»¡ï¼Œè¿›è¡Œç­‰å¾…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">capacity&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">notFull&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å®¹é‡æœªæ»¡ï¼Œè¿›è¡Œå…¥é˜Ÿ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">enqueue&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAndIncrement&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å…¥é˜ŸåŽé˜Ÿåˆ—è¿˜æœ‰ç©ºä½, å”¤é†’å…¶ä»– put çº¿ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">capacity&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">notFull&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">signal&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// åªå”¤é†’ä¸€ä¸ªï¼Œå‡å°‘ç«žäº‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">putLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æžœé˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªå…ƒç´ , å”¤é†’ take çº¿ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// notEmpty.signal() è€Œä¸æ˜¯ notEmpty.signalAll()ï¼›å‡å°‘ç«žäº‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">signalNotEmpty&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>take&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="n">E&lt;/span> &lt;span class="nf">take&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">InterruptedException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">E&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">AtomicInteger&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">count&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">takeLock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">takeLock&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">takeLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lockInterruptibly&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">notEmpty&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dequeue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAndDecrement&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">notEmpty&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">signal&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">takeLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æžœé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªç©ºä½æ—¶, å«é†’ put çº¿ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¦‚æžœæœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œå‡ºé˜Ÿ, ç¬¬ä¸€ä¸ªçº¿ç¨‹ c == capacity, åŽç»­çº¿ç¨‹ c &amp;lt; capacity
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">capacity&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// notFull.signal() è€Œä¸æ˜¯ notFull.signalAll()ï¼Œå‡å°‘ç«žäº‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">signalNotFull&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Java å¹¶å‘ - AQS</title><link>https://emerywan.github.io/blog/p/thread/aqs/</link><pubDate>Wed, 13 Apr 2022 14:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/aqs/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/6.jpeg" alt="Featured image of post Java å¹¶å‘ - AQS" />&lt;h2 id="aqs">AQS&lt;/h2>
&lt;p>AQS &lt;code>AbstractQueuedSynchronized&lt;/code> æ˜¯ä¸€ä¸ªç”¨æ¥æž„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æž¶ï¼Œæ˜¯å¯¹ CAS çš„ä¸€ç§å°è£…å’Œä¸°å¯Œï¼ŒAQS å¼•å…¥äº†ç‹¬å é”ï¼Œå…±äº«é”ç­‰æ€§è´¨ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ AQS èƒ½å¤ŸåŸºäºŽ Java APIï¼Œç®€å•é«˜æ•ˆåœ°æž„å»ºå‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡åŒæ­¥å™¨ï¼Œç”¨äºŽ Java å¤šçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚&lt;/p>
&lt;h2 id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³&lt;/h2>
&lt;p>AQS ä½¿ç”¨ä¸€ä¸ª &lt;code>volatile int state&lt;/code> æˆå‘˜å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ CAS &lt;code>compareAndSetState&lt;/code> å¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŽŸå­æ“ä½œï¼Œå®žçŽ°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å…±äº«å˜é‡ï¼Œä½¿ç”¨ volatile ä¿éšœå¯è§æ€§
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">private&lt;/span> &lt;span class="kd">volatile&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>AQS é€šè¿‡å†…ç½®çš„ &lt;code>FIFO&lt;/code> åŒå‘é˜Ÿåˆ—æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼ŒèŽ·å–èµ„æºçº¿ç¨‹çš„æŽ’é˜Ÿå·¥ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">transient&lt;/span> &lt;span class="kd">volatile&lt;/span> &lt;span class="n">Node&lt;/span> &lt;span class="n">head&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">transient&lt;/span> &lt;span class="kd">volatile&lt;/span> &lt;span class="n">Node&lt;/span> &lt;span class="n">tail&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²æ—¶ï¼Œå°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚&lt;/p>
&lt;p>å¦‚æžœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œå°†æš‚æ—¶èŽ·å–ä¸åˆ°é”çš„çº¿ç¨‹æž„é€ æˆä¸€ä¸ª Node åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚&lt;/p>
&lt;h2 id="èµ„æºçš„å…±äº«æ–¹å¼">èµ„æºçš„å…±äº«æ–¹å¼&lt;/h2>
&lt;h3 id="ç‹¬å ">ç‹¬å &lt;/h3>
&lt;p>å½“ä¸€ä¸ªçº¿ç¨‹ä»¥ç‹¬å æ¨¡å¼èŽ·å–é”æ—¶ï¼Œå…¶ä»–ä»»ä½•çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚&lt;/p>
&lt;ul>
&lt;li>ReentrantLock&lt;/li>
&lt;/ul>
&lt;h3 id="å…±äº«">å…±äº«&lt;/h3>
&lt;p>å½“ä¸€ä¸ªçº¿ç¨‹ä»¥å…±äº«æ¨¡å¼èŽ·å–é”æ—¶ï¼Œå…¶ä»–ä¹Ÿæƒ³ä»¥å…±äº«æ¨¡å¼èŽ·å–é”çš„çº¿ç¨‹ä¹Ÿèƒ½å¤Ÿä¸€èµ·è®¿é—®å…±äº«èµ„æºï¼Œä½†å…¶ä»–æƒ³ä»¥ç‹¬å æ¨¡å¼èŽ·å–é”çš„çº¿ç¨‹éœ€è¦ç­‰å¾…ã€‚&lt;/p>
&lt;ul>
&lt;li>CountDownLatch&lt;/li>
&lt;li>CyclicBarrier&lt;/li>
&lt;li>Semaphore&lt;/li>
&lt;/ul>
&lt;h2 id="å®žçŽ°">å®žçŽ°&lt;/h2>
&lt;h3 id="countdownlatch">CountDownLatch&lt;/h3>
&lt;p>&lt;code>CountDownLatch&lt;/code> åŒæ­¥å·¥å…·å…è®¸ä¸€æ¡æˆ–å¤šæ¡çº¿ç¨‹ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹ä¸­çš„ä¸€ç»„æ“ä½œå®ŒæˆåŽï¼Œå†ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;code>CountDownLatch&lt;/code> ä»»åŠ¡åˆ†ä¸º &lt;code>n&lt;/code> ä¸ªå­çº¿ç¨‹æ‰§è¡Œï¼Œ&lt;code>state&lt;/code> å°†è¢«åˆå§‹åŒ–ä¸º &lt;code>n&lt;/code>ï¼Œè¿™ &lt;code>n&lt;/code> ä¸ªçº¿ç¨‹å°†ä¼šå¹¶å‘æ‰§è¡Œï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®ŒåŽè°ƒç”¨ &lt;code>countDown()&lt;/code> æ–¹æ³•ï¼Œ&lt;code>state&lt;/code> ä¼šé€šè¿‡ &lt;code>CAS - 1&lt;/code>ã€‚å½“æ‰€æœ‰çš„å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œä¹‹åŽï¼Œ&lt;code>state=0&lt;/code>ï¼Œä¼š unpack ä¸»çº¿ç¨‹ï¼Œç»§ç»­åŽç»­åŠ¨ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Demo&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SearchTask&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">Integer&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="n">CountDownLatch&lt;/span> &lt;span class="n">latch&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">SearchTask&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">CountDownLatch&lt;/span> &lt;span class="n">latch&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">latch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">latch&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// **å­çº¿ç¨‹**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// å„è‡ªå¯»æ‰¾ç›¸åº”ç›®æ ‡çš„é¾™ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ðŸƒâ€â™‚ï¸ å¼€å§‹å¯»æ‰¾&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;å·é¾™ç &amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">seconds&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ThreadLocalRandom&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">current&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">nextInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">20&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">seconds&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ðŸ‘ èŠ±äº†&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">seconds&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;ç§’ï¼Œæ‰¾åˆ°äº†&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;å·é¾™ç &amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ¯å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œå°±è°ƒç”¨ä¸€æ¬¡ countDown() æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">latch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">countDown&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// **ä¸»çº¿ç¨‹**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ç­‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•åŽï¼Œæ‰¾åˆ°æ‰€æœ‰é¾™ç ï¼Œå¬å”¤ç¥žé¾™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">idList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Arrays&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">4&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">5&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">6&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">7&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// state åˆå§‹åŒ–ä¸ºä»»åŠ¡çš„ä¸ªæ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">CountDownLatch&lt;/span> &lt;span class="n">latch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">CountDownLatch&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">idList&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">idList&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span> &lt;span class="n">thread&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">SearchTask&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">latch&lt;/span>&lt;span class="o">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">latch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;æ‰¾åˆ°æ‰€æœ‰é¾™ç äº†ï¼å¬å”¤ç¥žé¾™ ðŸ²&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/aqs/countdownlatch.png"
width="605"
height="416"
srcset="https://emerywan.github.io/blog/blog/p/thread/aqs/countdownlatch_hu76805997e75031fb962291546eee5c35_69221_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/aqs/countdownlatch_hu76805997e75031fb962291546eee5c35_69221_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="countdownlatch"
class="gallery-image"
data-flex-grow="145"
data-flex-basis="349px"
>&lt;/p>
&lt;p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä»»åŠ¡åˆ†ä¸º 7 ä¸ªå­çº¿ç¨‹æ‰§è¡Œï¼Œå°† &lt;code>CountDownLatch&lt;/code> çš„å€¼åˆå§‹åŒ–ä¸ºä¸Žçº¿ç¨‹ç›¸åŒçš„æ¬¡æ•°ã€‚ä¸»çº¿ç¨‹é€šè¿‡ &lt;code>await()&lt;/code> ç­‰å¾…å…¶ä»–ä»»åŠ¡å®Œæˆã€‚&lt;/p>
&lt;p>è¿™å‡ ä¸ªå­ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®ŒæˆåŽ &lt;code>countDown()&lt;/code> ä¸€æ¬¡ï¼Œ&lt;code>state&lt;/code> ä¼šé€šè¿‡ CAS æ“ä½œ &lt;code>-1&lt;/code>ã€‚&lt;/p>
&lt;p>ç›´åˆ°æ‰€æœ‰çš„å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åŽï¼Œ&lt;code>state=0&lt;/code>ï¼Œä¸»çº¿ç¨‹ä¼šç»“æŸç­‰å¾…ï¼Œç»§ç»­æ‰§è¡ŒåŽç»­ä»»åŠ¡ã€‚&lt;/p>
&lt;h3 id="cyclicbarrier">CyclicBarrier&lt;/h3>
&lt;p>&lt;code>CyclicBarrier&lt;/code> ç”¨äºŽå¤šä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…å¯¹æ–¹æ‰§è¡Œåˆ°æŸä¸ªçŠ¶æ€åŽï¼Œè¿™äº›çº¿ç¨‹å†ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier.jpg"
width="890"
height="282"
srcset="https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier_hu4bbc637d91d993b0f3842d2bee476984_33199_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier_hu4bbc637d91d993b0f3842d2bee476984_33199_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
alt="cyclicbarrier"
class="gallery-image"
data-flex-grow="315"
data-flex-basis="757px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Demo&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">5&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// CyclicBarrier å¯ä»¥è®¾ç½®å­çº¿ç¨‹å…¨éƒ¨åˆ°è¾¾ barrierï¼Œæ‰§è¡Œçš„ä»»åŠ¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">CyclicBarrier&lt;/span> &lt;span class="n">barrier&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">CyclicBarrier&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ðŸ‘Œ äººå‘˜åˆ°é½ï¼å‡†å¤‡çˆ¬å±±ï¼&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å­çº¿ç¨‹ï¼Œæ¨¡æ‹Ÿ 5 ä¸ªåŒå­¦ç›¸çº¦çˆ¬å±±
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">5&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">final&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;åŒå­¦&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ðŸ‘‹ &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;å‡†å¤‡å‡ºå‘åŽ»é›†åˆç‚¹äº†ã€‚&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ThreadLocalRandom&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">current&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">nextInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ðŸ¦¶ &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;èŠ±äº† &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">time&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; ç§’åˆ°è¾¾é›†åˆç‚¹ã€‚&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// ç­‰å¾…æ‰€æœ‰çš„åŒå­¦ï¼ˆå­çº¿ç¨‹ï¼‰è¿è¡Œåˆ°æ­¤å¤„
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">barrier&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// å½“ await çš„çº¿ç¨‹è¶³å¤Ÿï¼Œå†ç»§ç»­æ‰§è¡Œçº¿ç¨‹åŽç»­ä»»åŠ¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">BrokenBarrierException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;å’Œå¤§å®¶ä¸€èµ·çˆ¬å±±äº†ã€‚â›°&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">},&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;åŒå­¦&amp;#34;&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier-result.png"
width="576"
height="450"
srcset="https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier-result_huabd0a32719e9e0c5e0894dc282a3eb45_80712_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier-result_huabd0a32719e9e0c5e0894dc282a3eb45_80712_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="cyclicbarrier result"
class="gallery-image"
data-flex-grow="128"
data-flex-basis="307px"
>&lt;/p>
&lt;p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰ 5 ä¸ªå­çº¿ç¨‹åˆ†åˆ«å¼€å§‹æ‰§è¡Œï¼ˆ5 ä¸ªåŒå­¦ä»Žå®¶é‡Œå‡ºå‘ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ°è¾¾æŸä¸ªçŠ¶æ€åŽ &lt;code>await()&lt;/code> è¿›è¡Œç­‰å¾…ï¼ˆæ¯ä¸ªåŒå­¦åˆ°è¾¾é›†åˆç‚¹ä¼šç­‰å¾…å…¶ä»–åŒå­¦åˆ°è¾¾ï¼‰ï¼Œå½“çº¿ç¨‹å…¨éƒ¨è¾¾åˆ°ä¹‹åŽï¼Œâ€œå±éšœâ€ä¼šé‡Šæ”¾ï¼Œçº¿ç¨‹å°†ç»§ç»­æ‰§è¡Œï¼ˆäººå‘˜åˆ°é½åŽå¼€å§‹çˆ¬å±±ï¼‰ã€‚&lt;/p>
&lt;blockquote>
&lt;p>CyclicBarrier å¯ä»¥å¤šæ¬¡ä½¿ç”¨ï¼Œå¯ä»¥è‡ªåŠ¨æˆ–æ‰‹åŠ¨é‡ç½®è®¡æ•°ã€‚
ä½¿ç”¨ barrier.reset() ä¼šè¿›è¡Œé‡ç½®ï¼Œç­‰å¾…çš„çº¿ç¨‹ä¼šæŠ›å‡º BrokenBarrierException&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// CyclicBarrier çš„è®¡æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å­çº¿ç¨‹çš„æ•°é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">10&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°†å­çº¿ç¨‹çš„æ•°é‡è®¾ç½®ä¸º &lt;code>10&lt;/code>ï¼Œå¾ªçŽ¯å±éšœè®¾ç½®ä¸º &lt;code>5&lt;/code>ï¼Œå°†ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æžœï¼šæ¯æœ‰ &lt;code>5&lt;/code> ä¸ªï¼Œçº¿ç¨‹åˆ°è¾¾â€œå±éšœâ€ç‚¹ï¼Œå°±ä¼šé‡Šæ”¾ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier-result-2.png"
width="585"
height="811"
srcset="https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier-result-2_hu2373c7ae3a7710cd05edc6f1f466fc13_156183_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/aqs/cyclicbarrier-result-2_hu2373c7ae3a7710cd05edc6f1f466fc13_156183_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="cyclicbarrier result"
class="gallery-image"
data-flex-grow="72"
data-flex-basis="173px"
>&lt;/p>
&lt;h3 id="semaphore">Semaphore&lt;/h3>
&lt;p>é€šè¿‡ä½¿ç”¨ &lt;code>Semaphore&lt;/code>ï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šæŸä¸ªèµ„æºåŒä¸€æ—¶é—´èƒ½å¤Ÿè¢«è®¿é—®çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå®ƒç›¸å½“äºŽå¯¹æŸä¸ªèµ„æºçš„è®¿é—®è¿›è¡Œäº†æµé‡æŽ§åˆ¶ã€‚&lt;/p>
&lt;p>æ˜¯ä¸€ä¸ªå¯ä»¥è¢« n ä¸ªçº¿ç¨‹å ç”¨çš„æŽ’å®ƒé”ï¼Œå¯ä»¥åœ¨æœ€å¼€å§‹è®¾å®š &lt;code>Semaphore&lt;/code> è®¸å¯è¯æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥èŽ·å¾— 1 ä¸ªæˆ–å¤šä¸ªè®¸å¯è¯ï¼Œå½“è®¸å¯è¯è€—å°½æˆ–ä¸è¶³ä»¥ä¾›å…¶ä»–çº¿ç¨‹èŽ·å–æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å°†è¢«é˜»å¡žã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Semaphore&lt;/span> &lt;span class="n">semaphore&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Semaphore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// æœ‰ä¸‰ä¸ªè®¸å¯ï¼Œå‡è®¾æ¯ä¸ªçº¿ç¨‹åªèŽ·å–ä¸€ä¸ªè®¸å¯æ—¶ï¼Œæœ€å¤šä¸¤ä¸ªçº¿ç¨‹å¯è®¿é—®èµ„æº
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">semaphore&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">acquire&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// æ— å‚ä¸ºç”³è¯·ä¸€ä¸ªè®¸å¯è¯ï¼Œæ²¡æœ‰è®¸å¯çš„çº¿ç¨‹ä¼šè¿›è¡Œç­‰å¾…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ç”³è¯·è®¸å¯è¯æˆåŠŸ&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">5&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// æ¨¡æ‹Ÿä»»åŠ¡è€—æ—¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">semaphore&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">release&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="reentrantlock">ReentrantLock&lt;/h3>
&lt;p>ç›¸æ¯”äºŽ &lt;code>synchronized&lt;/code>ï¼Œéƒ½æ”¯æŒ âœ¨å¯é‡å…¥ï¼Œè¿˜å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>âœ¨ ç­‰å¾…å¯ä¸­æ–­&lt;/li>
&lt;li>âœ¨ å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´&lt;/li>
&lt;li>âœ¨ å…¬å¹³é”&lt;/li>
&lt;li>âœ¨ æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡&lt;/li>
&lt;/ul>
&lt;p>&lt;code>ReentrantLock&lt;/code> éœ€è¦ä½¿ç”¨ &lt;code>try-finally&lt;/code> æ‰‹åŠ¨åŠ é”å’Œè§£é”&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">reentrantLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ä¸´ç•ŒåŒº
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">reentrantLock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/aqs/ReentrantLock.png"
width="636"
height="318"
srcset="https://emerywan.github.io/blog/blog/p/thread/aqs/ReentrantLock_hub675906c100b4f2e2501a8eca65fd5f6_112932_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/aqs/ReentrantLock_hub675906c100b4f2e2501a8eca65fd5f6_112932_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ReentrantLock"
class="gallery-image"
data-flex-grow="200"
data-flex-basis="480px"
>&lt;/p>
&lt;p>ReentrantLock é»˜è®¤å®žçŽ°ä¸ºéžå…¬å¹³é”&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="nf">ReentrantLock&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sync&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NonfairSync&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å¯é‡å…¥">å¯é‡å…¥&lt;/h4>
&lt;p>ä¸€ä¸ªçº¿ç¨‹èŽ·å–äº†ðŸ”’ é”ä¹‹åŽï¼Œå¯ä»¥å¤šæ¬¡èŽ·å–åŒä¸€æŠŠé”ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œä¸€ä¸ªå¸¦é”çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­åˆè°ƒç”¨äº†å¦ä¸€ä¸ªéœ€è¦ç›¸åŒé”çš„æ–¹æ³•ï¼Œåˆ™æ”¹çº¿ç¨‹å¯ä»¥ç›´æŽ¥èŽ·å–é”ï¼Œå¹¶æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œå¯é‡å…¥é”å¯æœ‰æ•ˆåœ°é¿å…æ­»é”ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">method1&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReentrantLock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">method1&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// ç¬¬ä¸€æ¬¡èŽ·å–ðŸ”’ é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;do something in method 1&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">method2&lt;/span>&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">method2&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// ç¬¬äºŒæ¬¡èŽ·å–ðŸ”’ é”ï¼ˆé‡å…¥ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;do something in method 2&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="ç­‰å¾…å¯ä¸­æ–­">ç­‰å¾…å¯ä¸­æ–­&lt;/h4>
&lt;p>&lt;code>lock.lockInterruptibly()&lt;/code>&lt;/p>
&lt;ul>
&lt;li>æ²¡æœ‰ç«žäº‰å°±ä¼šèŽ·å–é”&lt;/li>
&lt;li>æœ‰ç«žäº‰è¿›å…¥é˜»å¡žé˜Ÿåˆ—ï¼Œä½†æ˜¯å¯ä»¥è¢«ä¸­æ–­ï¼ˆthrow InterruptedExceptionï¼‰&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨ &lt;code>lock.lock()&lt;/code>ï¼Œå³ä½¿è¿›è¡Œ &lt;code>interrupt()&lt;/code> ä¹Ÿä¸ä¼šè®©çº¿ç¨‹ç­‰å¾…ä¸­æ–­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReentrantLock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span> &lt;span class="n">thread&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lockInterruptibly&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="c1">// å°è¯•èŽ·å–å¯ä¸­æ–­é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;é”åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;æˆåŠŸèŽ·å¾—äº†é” ðŸ”’&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ä¸»çº¿ç¨‹èŽ·å–äº†é” ðŸ”’&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ä¸»çº¿ç¨‹æ‰“æ–­ thread&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">interrupt&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="n">finlaly&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è¶…æ—¶æ—¶é—´">è¶…æ—¶æ—¶é—´&lt;/h3>
&lt;ul>
&lt;li>&lt;code>boolean tryLock()&lt;/code>ï¼šèŽ·å–é”å¤±è´¥ï¼Œç«‹å³è¿”å›ž&lt;/li>
&lt;li>&lt;code>boolean tryLock(long timeout, TimeUnit unit)&lt;/code>ï¼šèŽ·å–é”å¤±è´¥ï¼Œç­‰å¾…è¶…æ—¶æ—¶é—´&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Thread&lt;/span> &lt;span class="n">thread&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">tryLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;ç­‰å¾… 2s åŽï¼ŒæˆåŠŸèŽ·å–äº†é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;æˆåŠŸèŽ·å–äº†é”&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å…¬å¹³é”">å…¬å¹³é”&lt;/h4>
&lt;p>&lt;code>ReentrantLock&lt;/code> é»˜è®¤æ˜¯éžå…¬å¹³é”&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="nf">ReentrantLock&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sync&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NonfairSync&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="nf">ReentrantLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">boolean&lt;/span> &lt;span class="n">fair&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sync&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fair&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">FairSync&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">NonfairSync&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>å…¬å¹³é”ï¼šèŽ·å–é”çš„çº¿ç¨‹æ ¹æ®è¿›å…¥ç­‰å¾…é˜Ÿåˆ—çš„é¡ºåºèŽ·å–é”&lt;/li>
&lt;li>éžå…¬å¹³é”ï¼šæ–°çº¿ç¨‹å…ˆå°è¯•æ’é˜ŸèŽ·å–é”ï¼Œæ’é˜Ÿå¤±è´¥å†è¿›å…¥ç­‰å¾…é˜Ÿåˆ—æŽ’åºç­‰å¾…&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// èŽ·å–å…¬å¹³é”
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReentrantLock&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å¤šä¸ªæ¡ä»¶å˜é‡">å¤šä¸ªæ¡ä»¶å˜é‡&lt;/h4>
&lt;p>&lt;code>ReentrantLock&lt;/code> æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œå¯ä»¥å¯¹ç­‰å¾…çš„çº¿ç¨‹è¿›è¡Œç²¾å‡†å”¤é†’ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>await()&lt;/code>ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾èŽ·å–çš„é”ï¼Œè¿›å…¥å¯¹åº”çš„ conditionObject è¿›è¡Œç­‰å¾…ï¼›è¢« &lt;code>singnal()&lt;/code> å”¤é†’åŽï¼Œçº¿ç¨‹é‡æ–°åŽ»ç«žäº‰é”ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸‰ä¸ªçº¿ç¨‹å¾ªçŽ¯æ‰“å° ABC 10 æ¬¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ThreadDemo&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">static&lt;/span> &lt;span class="n">ReentrantLock&lt;/span> &lt;span class="n">lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ReentrantLock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">static&lt;/span> &lt;span class="n">Condition&lt;/span> &lt;span class="n">conditionA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newCondition&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">static&lt;/span> &lt;span class="n">Condition&lt;/span> &lt;span class="n">conditionB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newCondition&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">static&lt;/span> &lt;span class="n">Condition&lt;/span> &lt;span class="n">conditionC&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newCondition&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 0-&amp;gt;print A 1-&amp;gt;print B 2-&amp;gt;print C
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">commonState&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">MyTread&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">MyThread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">state&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">10&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">state&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">commonState&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conditionA&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;A&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">commonState&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conditionB&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">singnal&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">state&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">commonState&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conditionB&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;B&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">commonState&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conditionC&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">singnal&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">state&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">commonState&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conditoinC&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">await&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;C&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">commonState&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conditionA&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">singnal&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printStackTrace&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lock&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">MyThread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">)).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">MyThread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">)).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">MyThread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="o">)).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="reentrantreadwritelock">ReentrantReadWriteLock&lt;/h3>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://tech.meituan.com/2018/11/15/java-lock.html" target="_blank" rel="noopener"
>https://tech.meituan.com/2018/11/15/java-lock.html&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼</title><link>https://emerywan.github.io/blog/p/thread/singleton/</link><pubDate>Mon, 11 Apr 2022 18:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/singleton/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/8.jpeg" alt="Featured image of post çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼" />&lt;p>å•ä¾‹æ¨¡å¼æ‰€è¦å®žçŽ°çš„ç›®æ ‡ï¼šä¿æŒä¸€ä¸ªç±»æœ‰ä¸”åªæœ‰ä¸€ä¸ªå®žä¾‹ã€‚&lt;/p>
&lt;p>å‡ºäºŽæ€§èƒ½çš„è€ƒè™‘ï¼Œä¸å°‘å•ä¾‹æ¨¡å¼éƒ½ä¼šé‡‡ç”¨å»¶è¿ŸåŠ è½½çš„æ–¹å¼ã€‚æ ¹æ®æ˜¯å¦å»¶è¿Ÿåˆ›å»ºå¯¹è±¡ï¼Œå¯ä»¥åˆ†ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ðŸ¤© é¥¿æ±‰å¼&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ðŸ˜ª æ‡’æ±‰å¼&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="-æ‡’æ±‰å¼">ðŸ˜ª æ‡’æ±‰å¼&lt;/h2>
&lt;h3 id="å•çº¿ç¨‹çš„å•ä¾‹æ¨¡å¼">å•çº¿ç¨‹çš„å•ä¾‹æ¨¡å¼&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Singleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æž„é€ å™¨ç§æœ‰ï¼Œå…¶ä»–ç±»æ— æ³•é€šè¿‡ new åˆå§‹åŒ–
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="nf">Singleton&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºå¹¶è¿”å›žè¯¥ç±»çš„å”¯ä¸€å®žä¾‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="nf">getInstance&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Singleton&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">someService&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ä¸€äº›ä¸šåŠ¡ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="-åŠ é”çš„å•ä¾‹æ¨¡å¼">ðŸ”’ åŠ é”çš„å•ä¾‹æ¨¡å¼&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>synchronized&lt;/code> åŠ é”å®žçŽ°çº¿ç¨‹å®‰å…¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Singleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="nf">Singleton&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// public static synchronized getInstance()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="nf">getInstance&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">synchronized&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Singleton&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// ä¸æŽ¨è ðŸ™…â€â™‚ï¸ æ¯æ¬¡åˆ¤ç©ºæ“ä½œï¼Œéƒ½è¦èŽ·å–é”ï¼Œå¼€é”€æžå¤§
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kc">null&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Singleton&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>ä½¿ç”¨åŒé‡æ£€éªŒåˆ¤æ–­&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Singleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">volatile&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="nf">Singleton&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="nf">getInstance&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">instance&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">synchronized&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Singleton&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">instance&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Singleton&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ &lt;code>volatile&lt;/code> ä¿®é¥°å®žä¾‹ï¼Œåˆ©ç”¨äº†ä»¥ä¸‹ä¸¤ä¸ªä½œç”¨ï¼š&lt;/p>
&lt;p>(1) ä¿éšœå¯è§æ€§ï¼š&lt;/p>
&lt;p>ä¸€ä¸ªçº¿ç¨‹åˆå§‹åŒ–äº† &lt;code>instance&lt;/code> çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è¯»å–åˆ°ç›¸åº”çš„å€¼ã€‚&lt;/p>
&lt;p>(2) ä¿éšœæœ‰åºæ€§ï¼š&lt;/p>
&lt;p>ä¿éšœä¸€ä¸ªçº¿ç¨‹è¯»å–åˆ°çš„ &lt;code>instance&lt;/code> å¼•ç”¨çš„å®žä¾‹å·²ç»åˆå§‹åŒ–å®Œæ¯•ã€‚&lt;/p>
&lt;p>å¯¹è±¡å®žä¾‹åŒ–ä¼šåˆ†è§£æˆä»¥ä¸‹å‡ ä¸ªå­æ“ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>åˆ†é…å¯¹è±¡æ‰€éœ€çš„ç©ºé—´&lt;/li>
&lt;li>åˆå§‹åŒ– instance å¼•ç”¨çš„å¯¹è±¡&lt;/li>
&lt;li>å°†å¯¹è±¡çš„å¼•ç”¨å†™å…¥å…±äº«å˜é‡&lt;/li>
&lt;/ul>
&lt;p>ç”±äºŽ JVM å…·æœ‰æŒ‡ä»¤é‡æŽ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ &lt;code>1-&amp;gt;3-&amp;gt;2&lt;/code>ã€‚æŒ‡ä»¤é‡æŽ’åœ¨å•çº¿ç¨‹çŽ¯å¢ƒä¸‹ä¸ä¼šå‡ºçŽ°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹èŽ·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®žä¾‹ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼šçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3 åŽï¼Œæ­¤æ—¶ T2 è°ƒç”¨ &lt;code>getInstance()&lt;/code> åŽå‘çŽ° &lt;code>instance&lt;/code> ä¸ä¸ºç©ºï¼Œå› æ­¤ç›´æŽ¥è¿”å›žï¼Œä½†æ­¤æ—¶ &lt;code>instance&lt;/code> è¿˜æœªè¢«åˆå§‹åŒ–ã€‚&lt;/p>
&lt;h3 id="é™æ€å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼">é™æ€å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Singleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="nf">Singleton&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">InstanceHolder&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// é™æ€å†…éƒ¨ç±»
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¿å­˜å¤–éƒ¨ç±»çš„å”¯ä¸€å®žä¾‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="n">INSTANCE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Singleton&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="nf">getInstance&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">InstanceHolder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">INSTANCE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">someService&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Singleton&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getInstance&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">someService&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“å¤–éƒ¨ç±»åŠ è½½æ—¶ï¼Œå†…éƒ¨ç±»ä¸ä¼šåŠ è½½ï¼Œå¹¶ä¸”é™æ€å˜é‡åªä¼šæœ‰é»˜è®¤å€¼ï¼ˆnullï¼‰ã€‚&lt;/p>
&lt;p>ç±»çš„é™æ€å˜é‡è¢«åˆæ¬¡è®¿é—®æ‰ä¼šè§¦å‘ Java è™šæ‹Ÿæœºå¯¹è¯¥ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œä¼šå˜ä¸ºå…¶åˆå§‹å€¼ã€‚&lt;/p>
&lt;h3 id="æžšä¸¾å•ä¾‹">æžšä¸¾å•ä¾‹&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">enum&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">INSTANCE&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Singleton&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// ç§æœ‰æž„é€ å™¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pubilc&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">someService&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ä¸šåŠ¡ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å­—æ®µ &lt;code>INSTANCE&lt;/code> æ˜¯æžšä¸¾ç±»çš„å”¯ä¸€å®žä¾‹ã€‚åœ¨ &lt;code>Singleton.INSTANCE&lt;/code> åˆæ¬¡è¢«å¼•ç”¨æ—¶æ‰ä¼šè¢«åˆå§‹åŒ–ã€‚&lt;/p>
&lt;h2 id="-é¥¿æ±‰å¼">ðŸ¤© é¥¿æ±‰å¼&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">pubilc&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Singleton&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åœ¨åˆ›å»ºæ—¶ç›´æŽ¥åˆå§‹åŒ–ï¼Œå¤©ç”Ÿçº¿ç¨‹å®‰å…¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Singleton&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">println&lt;/span> &lt;span class="nf">Singleton&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pubilc&lt;/span> &lt;span class="n">staitc&lt;/span> &lt;span class="n">Singleton&lt;/span> &lt;span class="nf">getInstance&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Java å¹¶å‘ - Semaphore å®žçŽ°åŽŸç†</title><link>https://emerywan.github.io/blog/p/thread/semaphore/</link><pubDate>Mon, 11 Apr 2022 14:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/semaphore/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/27.jpeg" alt="Featured image of post Java å¹¶å‘ - Semaphore å®žçŽ°åŽŸç†" />&lt;p>&lt;a class="link" href="https://www.bilibili.com/video/BV1z7411H7zd?p=266&amp;amp;vd_source=7708cdc540d8ed89c3bf3206996477cd" target="_blank" rel="noopener"
>https://www.bilibili.com/video/BV1z7411H7zd?p=266&amp;vd_source=7708cdc540d8ed89c3bf3206996477cd&lt;/a>&lt;/p></description></item><item><title>Java å¹¶å‘ - é”æœºåˆ¶</title><link>https://emerywan.github.io/blog/p/thread/lock/</link><pubDate>Mon, 11 Apr 2022 14:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/lock/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/7.jpeg" alt="Featured image of post Java å¹¶å‘ - é”æœºåˆ¶" />&lt;p>åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹ä¼šå¯¹åŒä¸€ä¸ªèµ„æºè¿›è¡Œäº‰æŠ¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡å¼•å…¥&lt;strong>é”æœºåˆ¶&lt;/strong>ï¼Œä½¿ç”¨ä¸€ç§æŠ½è±¡çš„é”ï¼Œå¯¹èµ„æºè¿›è¡Œé”å®šï¼Œè¾¾åˆ°åŒæ­¥è®¿é—®ã€‚&lt;/p>
&lt;h2 id="å®žçŽ°">å®žçŽ°&lt;/h2>
&lt;p>Java é‡‡ç”¨äº†ä¸¤ç§å®žçŽ°æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>é˜»å¡žåŒæ­¥ï¼ˆðŸ˜¢ æ‚²è§‚é”ï¼‰ï¼šðŸ“ é€‚åˆäºŽå†™å¤šè¯»å°‘çš„åœºæ™¯ã€‚å…ˆåŠ é”ï¼Œä¿è¯å†™æ“ä½œæ—¶çš„æ•°æ®æ­£ç¡®ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>åŸºäºŽ &lt;code>Object&lt;/code> çš„ &lt;code>synchronized&lt;/code> å†…éƒ¨é” ðŸ”’&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åŸºäºŽ &lt;code>API&lt;/code> ç±»åº“çš„ &lt;code>java.util.concurrent.locks.Lock&lt;/code> ðŸ”’&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>éžé˜»å¡žåŒæ­¥ï¼ˆðŸ˜ ä¹è§‚é”ï¼‰ï¼šðŸ“– é€‚åˆäºŽè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚ä¸åŠ é”ï¼Œå¯ä»¥å¤§å¹…æé«˜è¯»çš„æ€§èƒ½ã€‚&lt;/p>
&lt;ul>
&lt;li>åŸºäºŽ &lt;code>CAS&lt;/code> çš„ä¹è§‚é”&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="-æ‚²è§‚é”">ðŸ˜¢ æ‚²è§‚é”&lt;/h2>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/lock/pessimistic_lock.png"
width="1203"
height="435"
srcset="https://emerywan.github.io/blog/blog/p/thread/lock/pessimistic_lock_hu0c6cbd403a1714d2f5c0f487acc85888_127050_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/lock/pessimistic_lock_hu0c6cbd403a1714d2f5c0f487acc85888_127050_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="pessimistic"
class="gallery-image"
data-flex-grow="276"
data-flex-basis="663px"
>&lt;/p>
&lt;p>åœ¨ Java ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡ï¼ˆObjectï¼‰ï¼Œéƒ½æ‹¥æœ‰ä¸€æŠŠé”ï¼Œå­˜æ”¾åœ¨å¯¹è±¡å¤´ä¸­ï¼Œè®°å½•äº†å½“å‰å¯¹è±¡è¢«å“ªä¸ªçº¿ç¨‹æ‰€å ç”¨ã€‚&lt;/p>
&lt;h3 id="å†…éƒ¨é”-synchronized">å†…éƒ¨é” synchronized&lt;/h3>
&lt;p>&lt;code>synchronized&lt;/code> å…³é”®å­—å¯ä»¥ç”¨æ¥åŒæ­¥çº¿ç¨‹ï¼Œå…¶è¢«ç¼–è¯‘åŽï¼Œä¼šç”Ÿæˆ &lt;code>monitorenter&lt;/code> å’Œ &lt;code>moniterexit&lt;/code> ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹çš„åŒæ­¥ã€‚&lt;/p>
&lt;p>è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½éœ€è¦ä¸€ä¸ª &lt;code>reference&lt;/code> ç±»åž‹çš„å‚æ•°æ¥æŒ‡æ˜Žè¦é”å®šå’Œè§£é”çš„å¯¹è±¡ã€‚å¦‚æžœ &lt;code>Java&lt;/code> æºç ä¸­çš„ &lt;code>synchronized&lt;/code> æ˜Žç¡®æŒ‡å®šäº†å¯¹è±¡å‚æ•°ï¼Œé‚£å°±ä»¥è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ä½œä¸º &lt;code>reference&lt;/code>ï¼›å¦‚æžœæ²¡æœ‰æ˜Žç¡®æŒ‡å®šï¼Œå°±æ ¹æ® &lt;code>synchronized&lt;/code> ä¿®é¥°çš„æ–¹æ³•ç±»åž‹ï¼ˆå®žä¾‹æ–¹æ³•æˆ–ç±»æ–¹æ³•ï¼‰ï¼Œæ¥å†³å®šæ˜¯å–ä»£ç æ‰€åœ¨çš„å¯¹è±¡å®žä¾‹è¿˜æ˜¯å–ç±»åž‹å¯¹åº”çš„ Class å¯¹è±¡æ¥ä½œä¸ºçº¿ç¨‹è¦æŒæœ‰çš„é”ã€‚&lt;/p>
&lt;p>åŠ é”æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¯¹è±¡é”&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä¿®é¥°å®žä¾‹æ–¹æ³• &lt;code>pubilc sychronized void method() { ... }&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»£ç å—é”ä½å½“å‰å¯¹è±¡ &lt;code>synchronized(this)&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>ç±»é”&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä¿®é¥°é™æ€æ–¹æ³• &lt;code>public static synchronized void method() { ... }&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»£ç å—é”å®š class å¯¹è±¡ &lt;code>synchronized(MyClass.class) { ... }&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;code>synchronized&lt;/code> æ˜¯éžå…¬å¹³é”ã€‚ä¸€æŠŠé”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹èŽ·å–ï¼Œæ²¡æœ‰èŽ·å¾—é”çš„çº¿ç¨‹åªèƒ½ç­‰å¾…ã€‚çº¿ç¨‹å¯¹å†…éƒ¨é”çš„ç”³è¯·å’Œé‡Šæ”¾ç”± &lt;code>Java&lt;/code> è™šæ‹Ÿæœºè´Ÿè´£å®žæ–½ã€‚&lt;/p>
&lt;p>&lt;code>synchronized&lt;/code> ä¿®é¥°çš„æ–¹æ³•ï¼Œæ— è®ºæ–¹æ³•æ­£å¸¸æ‰§è¡Œå®Œè¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½ä¼šé‡Šæ”¾é”ã€‚&lt;/p>
&lt;h3 id="jdk-16-å¯¹-synchronized-çš„ä¼˜åŒ–">JDK 1.6 å¯¹ synchronized çš„ä¼˜åŒ–&lt;/h3>
&lt;p>&lt;code>synchronized&lt;/code> ä¾èµ–äºŽ &lt;code>JVM&lt;/code>ï¼Œä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿåº•å±‚çš„ &lt;code>Mutex Lock&lt;/code> å®žçŽ°ã€‚&lt;/p>
&lt;p>Java çº¿ç¨‹çš„å®žçŽ°æ˜¯å¯¹æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æ˜ å°„ï¼Œæ¯å½“å”¤é†’æˆ–æŒ‚èµ·ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œéƒ½è¦åˆ‡æ¢åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ€ï¼Œä»£ä»·æ˜¯éžå¸¸æ˜‚è´µçš„ã€‚&lt;/p>
&lt;p>JDK 1.6 å¯¹é”çš„å®žçŽ°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚ &lt;code>é”ç²—åŒ–&lt;/code>ï¼Œ&lt;code>é”æ¶ˆé™¤&lt;/code>ï¼Œ&lt;code>è½»é‡çº§é”&lt;/code>ï¼Œ&lt;code>åå‘é”&lt;/code>ï¼Œ&lt;code>è‡ªæ—‹é”&lt;/code>ï¼Œ&lt;code>é€‚åº”æ€§è‡ªæ—‹&lt;/code>ç­‰ã€‚&lt;/p>
&lt;p>å¯¹è±¡é”ä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼š&lt;/p>
&lt;blockquote>
&lt;p>æ— é” -&amp;gt; åå‘é” -&amp;gt; è½»é‡çº§é” -&amp;gt; é‡é‡çº§é”&lt;/p>
&lt;/blockquote>
&lt;p>ä¼šéšç€ç«žäº‰æƒ…å†µé€æ¸å‡çº§ï¼ˆä¸å¯ä»¥é™çº§ï¼‰ï¼Œæé«˜èŽ·å–é”å’Œé‡Šæ”¾é”çš„æ•ˆçŽ‡ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ðŸ”’ æ— é”çŠ¶æ€&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æŸäº›èµ„æºä¸ä¼šå‡ºçŽ°å¤šçº¿ç¨‹ç«žäº‰çš„æƒ…å†µï¼Œéšæ„å¤šä¸ªçº¿ç¨‹è°ƒç”¨&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆ©ç”¨å…¶ä»–ä¸€äº›æ–¹å¼æŽ§åˆ¶åŒæ­¥ã€‚å¦‚ï¼šCAS&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>ä¸å¯¹èµ„æºè¿›è¡Œæ“ä½œç³»ç»Ÿçº§åˆ«çš„é”å®šã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ðŸ”’ åå‘é”&lt;/p>
&lt;ul>
&lt;li>é€‚åˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—çš„åœºæ™¯&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹çš„ç«žäº‰ï¼Œæ¯æ¬¡éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡èŽ·å–é”ï¼Œé‚£ä¹ˆå¯¹è±¡é”ä¼šâ€œè®°ä½â€è¿™ä¸ªçº¿ç¨‹ï¼Œåªè¦æ˜¯è¿™ä¸ªçº¿ç¨‹è¿‡æ¥ï¼Œå°±ç›´æŽ¥æŠŠé”äº¤å‡ºåŽ»ã€‚&lt;/p>
&lt;p>å¦‚æžœå¯¹è±¡å‘çŽ°ç›®å‰ä¸æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯æœ‰å¤šä¸ªçº¿ç¨‹åœ¨ç«žäº‰é”ï¼Œåå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ðŸ”’ è½»é‡çº§é”&lt;/p>
&lt;ul>
&lt;li>é€‚åˆåŒæ­¥ä»£ç å—çš„æ‰§è¡Œé€Ÿåº¦éžå¸¸å¿«çš„åœºæ™¯&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å½“é”å‡çº§ä¸ºè½»é‡çº§é”çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡ CAS è¿›è¡Œè‡ªæ—‹ç­‰å¾…æ¥èŽ·å–é”ï¼Œä¸ä¼šé˜»å¡žï¼Œä»Žè€Œæé«˜æ€§èƒ½ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ðŸ”’ é‡é‡çº§é”&lt;/p>
&lt;ul>
&lt;li>é€‚åˆåŒæ­¥ä»£ç å—æ‰§è¡Œé€Ÿåº¦è¾ƒé•¿çš„åœºæ™¯&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å¯¹è±¡é”çŠ¶æ€è¢«æ ‡è®°ä¸ºé‡é‡çº§é”ï¼Œéœ€è¦é€šè¿‡ Monitor æ¥å¯¹çº¿ç¨‹è¿›è¡ŒæŽ§åˆ¶ã€‚&lt;/p>
&lt;h2 id="-ä¹è§‚é”-cas">ðŸ˜ ä¹è§‚é” CAS&lt;/h2>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/lock/optimistic_lock.png"
width="1037"
height="468"
srcset="https://emerywan.github.io/blog/blog/p/thread/lock/optimistic_lock_hu036037785ffcb4d154b9171a46e6bd40_99684_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/lock/optimistic_lock_hu036037785ffcb4d154b9171a46e6bd40_99684_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="optimistic"
class="gallery-image"
data-flex-grow="221"
data-flex-basis="531px"
>&lt;/p>
&lt;p>åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼ŒåŒæ­¥ä»£ç å—æ‰§è¡Œçš„æ—¶é—´è¿œè¿œå°äºŽçº¿ç¨‹åˆ‡æ¢çš„è€—æ—¶ã€‚æ‰€ä»¥å¸Œæœ›èƒ½å¤Ÿåœ¨ç”¨æˆ·æ€ä¸­å¯¹çº¿ç¨‹çš„åˆ‡æ¢è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·æ•ˆçŽ‡æ›´é«˜ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬è®©çº¿ç¨‹â€œä¹è§‚åœ°â€åå¤å°è¯•èŽ·å–å…±äº«èµ„æºï¼Œå½“å‘çŽ°ç©ºé—²æ—¶ä¾¿è¿›è¡Œä½¿ç”¨ï¼Œå¦åˆ™ç»§ç»­â€œä¹è§‚åœ°â€è¿›è¡Œé‡è¯•ã€‚&lt;/p>
&lt;p>åŸºäºŽä»¥ä¸Šæƒ³æ³•ï¼Œè¯žç”Ÿäº† &lt;code>CAS (Compare And Swap)&lt;/code> ç®—æ³•ï¼šæ¯”è¾ƒå¹¶äº¤æ¢ã€‚&lt;/p>
&lt;p>CASç®—æ³•æ¶‰åŠåˆ°ä¸‰ä¸ªæ“ä½œæ•°ï¼š&lt;/p>
&lt;ul>
&lt;li>éœ€è¦è¯»å†™çš„å†…å­˜å€¼ addr&lt;/li>
&lt;li>è¿›è¡Œæ¯”è¾ƒçš„å€¼ oldValue&lt;/li>
&lt;li>è¦å†™å…¥çš„æ–°å€¼ newValue&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">cas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">oldValue&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">newValue&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Executes atomically. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">addr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">old&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¸ª cas å‡½æ•°çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•åŒæ­¥æŽªæ–½ï¼Œä¼¼ä¹Žè¿˜æ˜¯å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>å½“ A çº¿ç¨‹æ¯”è¾ƒäº† oldValue çš„å€¼æ˜¯æƒ³è¦çš„ï¼Œä½†æ˜¯è¿™ä¸ªçž¬é—´ï¼ŒB çº¿ç¨‹çªç„¶æŠ¢åˆ°äº†æ—¶é—´ç‰‡ï¼Œæ›´æ”¹äº†å€¼ï¼›ä½†æ˜¯ A çº¿ç¨‹å¹¶ä¸çŸ¥é“ï¼Œå°†å€¼æ”¹æˆäº† newValueï¼Œè¿™å°±å‡ºçŽ°äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒA B ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶èŽ·å¾—äº†èµ„æºã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œ&lt;code>CAS&lt;/code> çš„æ“ä½œå¿…é¡»æ˜¯ &lt;code>åŽŸå­æ€§&lt;/code> çš„ã€‚è¿™ä¸ªåŽŸå­æ“ä½œï¼Œ&lt;strong>ç”±è®¡ç®—æœºå¤„ç†å™¨æŒ‡ä»¤é›†æä¾›ï¼Œç›´æŽ¥ç”±ç¡¬ä»¶ä¿éšœã€‚&lt;/strong>&lt;/p>
&lt;h3 id="åŽŸå­å˜é‡ç±»">åŽŸå­å˜é‡ç±»&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>åŸºç¡€æ•°æ®ç±»åž‹&lt;/p>
&lt;ul>
&lt;li>AtomicInteger&lt;/li>
&lt;li>AtomicLong&lt;/li>
&lt;li>AtomicBoolean&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>æ•°ç»„ç±»åž‹&lt;/p>
&lt;ul>
&lt;li>AtomicIntegerArray&lt;/li>
&lt;li>AtomicLongArray&lt;/li>
&lt;li>AtomicReferenceArray&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å­—æ®µæ›´æ–°ç±»åž‹&lt;/p>
&lt;ul>
&lt;li>AtomicIntegerFieldUpdater&lt;/li>
&lt;li>AtomicLongFieldUpdater&lt;/li>
&lt;li>AtomicReferenceFieldUpdater&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å¼•ç”¨ç±»åž‹&lt;/p>
&lt;ul>
&lt;li>AtomicReference&lt;/li>
&lt;li>AtomicStampedReference&lt;/li>
&lt;li>AtomicMarkableReference&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Demo&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">AtomicInteger&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicInteger&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; : &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">n&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">incrementAndGet&lt;/span>&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">},&lt;/span> &lt;span class="s">&amp;#34;Thread&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>AtomicInteger&lt;/code> ä¸»è¦ç”±ä¸€ä¸ª &lt;code>Unsafe&lt;/code> ç±»åž‹çš„å®žä¾‹ &lt;code>unsafe&lt;/code> å’Œ &lt;code>Long&lt;/code> ç±»åž‹çš„ &lt;code>offset&lt;/code> å®žçŽ°ã€‚&lt;/p>
&lt;p>Java é€šè¿‡ &lt;code>Unsafe&lt;/code> çš„ CAS æ“ä½œæ¥å¯¹ &lt;code>volatile int&lt;/code> å€¼è¿›è¡Œæ›´æ–°ã€‚æ ¹æ® &lt;code>value&lt;/code> åœ¨å¯¹è±¡ä¸­çš„åç§»é‡ï¼ŒCAS æ“ä½œå†…å­˜æ•°æ®ï¼Œæ‰§è¡Œä¸€äº›åº•å±‚ï¼Œå’Œå¹³å°ç›¸å…³çš„æ–¹æ³•ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// setup to use Unsafe.compareAndSwapInt for updates
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Unsafe&lt;/span> &lt;span class="n">unsafe&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Unsafe&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getUnsafe&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">valueOffset&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">static&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">valueOffset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unsafe&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">objectFieldOffset&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AtomicInteger&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDeclareFiele&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="o">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span> &lt;span class="kd">volatile&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¾‹å¦‚ &lt;code>incrementAndGet()&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// AtomicInteger.java
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">public&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">incrementAndGet&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">unsafe&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAndAddInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">valueOffset&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Unsafe.java
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">public&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">getAndAddInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">o&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">delta&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">do&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getIntVolatile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">o&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">compareAndSwapInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">o&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">delta&lt;/span>&lt;span class="o">));&lt;/span> &lt;span class="c1">// è‡ªæ—‹ï¼Œå¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°é…ç½®ï¼Œé»˜è®¤æ˜¯ 10
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kd">native&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="nf">compareAndSwapInt&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">o&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">expected&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¼ºç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¾ªçŽ¯å¼€é”€å¤§&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åªèƒ½å¤„ç†ä¸€ä¸ªå…±äº«å˜é‡&lt;/p>
&lt;ul>
&lt;li>å°è£…æˆå¯¹è±¡ AtomicReference&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>ABA&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="aba-é—®é¢˜">ABA é—®é¢˜&lt;/h3>
&lt;p>CAS éœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™æ£€æŸ¥å†…å­˜å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œæ²¡æœ‰å‘ç”Ÿå˜åŒ–æ‰ä¼šæ›´æ–°å†…å­˜å€¼ã€‚&lt;/p>
&lt;p>å¦‚æžœå†…å­˜å€¼åŽŸæ¥æ˜¯ Aï¼ŒåŽæ¥å˜æˆäº† Bï¼Œç„¶åŽåˆå˜æˆäº† Aï¼Œé‚£ä¹ˆ CAS è¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘çŽ°å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®žé™…ä¸Šæ˜¯æœ‰å˜åŒ–çš„ã€‚&lt;/p>
&lt;p>&lt;code>A -&amp;gt; B -&amp;gt; A&lt;/code>&lt;/p>
&lt;p>å¯ä»¥ä¸ºå…±äº«å˜é‡å¼•å…¥ä¸€ä¸ªä¿®è®¢å·ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œæ¯æ¬¡æ›´æ–°éƒ½ä¼šæ›´æ–°ç›¸åº”çš„ä¿®è®¢å·ï¼Œåˆ¤æ–­å˜é‡çš„å€¼æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹ç»™ä¿®æ”¹è¿‡ã€‚&lt;code>AtomicStampedReference&lt;/code>&lt;/p>
&lt;p>&lt;code>[A, 0] -&amp;gt; [B, 1] -&amp;gt; [A, 2]&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;Hello&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;World&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// initialRef initialStamp
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">AtomicStampedReference&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">reference&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">AtomicStampedReference&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// expectedReference newStamp
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">reference&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">attemptStamp&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// å¯¹ç‰ˆæœ¬å·è¿›è¡Œä¿®æ”¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// expectedReference newReference expectedStamp newStamp
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">reference&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// CAS æ“ä½œéœ€è¦åŒæ—¶æä¾› é¢„æœŸå€¼ æ–°å€¼ é¢„æœŸç‰ˆæœ¬å· æ–°ç‰ˆæœ¬å·
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://tech.meituan.com/2018/11/15/java-lock.html" target="_blank" rel="noopener"
>https://tech.meituan.com/2018/11/15/java-lock.html&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Javaå¹¶å‘ - çº¿ç¨‹æ± </title><link>https://emerywan.github.io/blog/p/thread/threadpool/</link><pubDate>Wed, 30 Mar 2022 16:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/threadpool/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/9.jpeg" alt="Featured image of post Javaå¹¶å‘ - çº¿ç¨‹æ± " />&lt;h2 id="åˆ›å»º">åˆ›å»º&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="nf">ThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">corePoolSize&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">maximumPoolSize&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">long&lt;/span> &lt;span class="n">keepAliveTime&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TimeUnit&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BlockingQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">workQueue&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ThreadFactory&lt;/span> &lt;span class="n">threadFactory&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RejectedExecutionHandler&lt;/span> &lt;span class="n">handler&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>&lt;code>corePoolSize&lt;/code> æ ¸å¿ƒçº¿ç¨‹æ•°&lt;/p>
&lt;ul>
&lt;li>æ¯æ¬¡å‘çº¿ç¨‹æ± æäº¤ä¸€ä¸ªå¤šçº¿ç¨‹ä»»åŠ¡ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œæ— è®ºæ˜¯å¦æœ‰ç©ºé—²çº¿ç¨‹ï¼Œç›´åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°çš„æ•°é‡ï¼Œæ‰ä¼šå¼€å§‹å¤ç”¨çº¿ç¨‹èµ„æºã€‚&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>prestartAllCoreThreads()&lt;/code> ç›´æŽ¥åˆå§‹åŒ–å…¨éƒ¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>maximumPoolSize&lt;/code> æœ€å¤§çº¿ç¨‹æ•°&lt;/p>
&lt;ul>
&lt;li>å½“æ‰€æœ‰çº¿ç¨‹éƒ½å¤„äºŽè¿è¡ŒçŠ¶æ€ï¼Œä¸”ç­‰å¾…é˜Ÿåˆ—å·²æ»¡ï¼Œä¼šå¼€å§‹åˆ›å»ºéžæ ¸å¿ƒçº¿ç¨‹ï¼Œä½†ä¸è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>keepAliveTime&lt;/code> çº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´&lt;/p>
&lt;ul>
&lt;li>éžæ ¸å¿ƒçº¿ç¨‹è¶…è¿‡æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œä¼šè‡ªåŠ¨é”€æ¯&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>unit&lt;/code> æœ€å¤§ç©ºé—²æ—¶é—´å•ä½&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>workQueue&lt;/code> çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—&lt;/p>
&lt;ul>
&lt;li>æ ¸å¿ƒçº¿ç¨‹æ•°å·²æ»¡æ—¶ï¼Œä¼šå°†ä»»åŠ¡æš‚å­˜åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°çº¿ç¨‹èµ„æºå¯ç”¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>threadFactory&lt;/code> çº¿ç¨‹åˆ›å»ºå·¥åŽ‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>handler&lt;/code> æ‹’ç»ç­–ç•¥&lt;/p>
&lt;ul>
&lt;li>å½“ç­‰å¾…é˜Ÿåˆ—å·²æ»¡ï¼Œå¹¶ä¸”è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ–°çš„ä»»åŠ¡ä¼šè¿›è¡Œæ‹’ç»å¤„ç†&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="çº¿ç¨‹æ± çš„å¤§å°">çº¿ç¨‹æ± çš„å¤§å°&lt;/h3>
&lt;ul>
&lt;li>CPU å¯†é›†åž‹&lt;/li>
&lt;/ul>
&lt;p>ä¸»è¦æ˜¯æ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼Œç›¸åº”å¾ˆå¿«ï¼ŒCPU åˆ©ç”¨çŽ‡é«˜ã€‚æŽ¨èï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° + 1&lt;/p>
&lt;ul>
&lt;li>IO å¯†é›†åž‹&lt;/li>
&lt;/ul>
&lt;p>ä¸»è¦æ˜¯è¿›è¡Œ IO æ“ä½œï¼Œå¦‚ç¡¬ç›˜è¯»å–æ•°æ®ç­‰ï¼ŒIO æ“ä½œæ—¶é—´é•¿ï¼ŒCPU åˆ©ç”¨ä¸é«˜ï¼ŒæŽ¨èï¼šæ ¸å¿ƒçº¿ç¨‹æ•° = 2 * CPU æ ¸å¿ƒæ•°ã€‚&lt;/p>
&lt;h3 id="æ‹’ç»ç­–ç•¥">æ‹’ç»ç­–ç•¥&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>AbortPolicy&lt;/p>
&lt;ul>
&lt;li>æŠ›å‡ºå¼‚å¸¸æ‹’ç»ä»»åŠ¡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>DiscardPolicy&lt;/p>
&lt;ul>
&lt;li>ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œæ‹’ç»ä»»åŠ¡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>DiscardOldestPolicy&lt;/p>
&lt;ul>
&lt;li>ä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>CallerRunsPolicy&lt;/p>
&lt;ul>
&lt;li>å°†ä»»åŠ¡äº¤ç»™è°ƒç”¨çº¿ç¨‹æ‰§è¡Œ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// execute
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// do ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// submit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">future&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">submit&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// do...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;è¿”å›žå€¼&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">String&lt;/span> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">future&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¸¸è§çš„çº¿ç¨‹æ± ">å¸¸è§çš„çº¿ç¨‹æ± &lt;/h2>
&lt;h3 id="newsinglethreadexecutor">newSingleThreadExecutor&lt;/h3>
&lt;ul>
&lt;li>åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± &lt;/li>
&lt;li>å”¯ä¸€çº¿ç¨‹å¯ä»¥ä¿è¯æ‰€æäº¤çš„ä»»åŠ¡é¡ºåºæ‰§è¡Œ&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">ExecutorService&lt;/span> &lt;span class="nf">newSingleThreadExecutor&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">FinalizableDelegatedExecutorService&lt;/span>&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">ThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">0L&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">LinkedBlockingQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="o">&amp;gt;()));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="newfixedthreadpool">newFixedThreadPool&lt;/h3>
&lt;ul>
&lt;li>å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± &lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">ExecutorService&lt;/span> &lt;span class="nf">newFixedThreadPool&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">nThreads&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">nThread&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">nThread&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">0L&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">LinkedBlockingQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="o">&amp;gt;());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="newcachedthreadpool">newCachedThreadPool&lt;/h3>
&lt;ul>
&lt;li>æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ± &lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">ExecutorService&lt;/span> &lt;span class="nf">newCachedThreadPool&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MAX_VALUE&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">60L&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">SynchronousQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="o">&amp;gt;());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“æäº¤æ–°ä»»åŠ¡æ—¶ï¼Œå¦‚æžœçº¿ç¨‹æ± ä¸ºç©ºæˆ–æ²¡æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚&lt;/p>
&lt;p>å½“çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTime=60sï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾çº¿ç¨‹èµ„æºã€‚é•¿æ—¶é—´ç©ºé—²çš„ CachedThreadPool ä¸ä¼šæŒæœ‰ä»»åŠ¡ä»»ä½•çº¿ç¨‹èµ„æºã€‚&lt;/p>
&lt;h2 id="scheduledthreadpoolexecutor">ScheduledThreadPoolExecutor&lt;/h2>
&lt;p>&lt;code>ScheduledThreadPoolExecutor&lt;/code> å¯ä»¥ç”¨æ¥æäº¤å®šæ—¶ä»»åŠ¡ï¼Œ&lt;code>extends ThreadPoolExecutor&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="n">ScheduledExecutorService&lt;/span> &lt;span class="nf">newScheduledThreadPool&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">corePoolSize&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ScheduledThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">corePoolSize&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>ScheduledThreadPoolExecutor&lt;/code> æœ€å¤§çº¿ç¨‹æ± å®¹é‡ä¸º &lt;code>Integer.MAX_VALUE&lt;/code>ï¼›éƒ½æ˜¯é‡‡ç”¨çš„&lt;code>DelayedWorkQueue&lt;/code> ä½œä¸ºç­‰å¾…é˜Ÿåˆ—ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ScheduledExecutorService&lt;/span> &lt;span class="n">executor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newScheduledThreadPool&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å»¶è¿Ÿ 3 s åŽæ‰§è¡Œä»»åŠ¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">schedule&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;å®šæ—¶ä»»åŠ¡&amp;#34;&lt;/span>&lt;span class="o">),&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">shutdown&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ScheduledExecutorService&lt;/span> &lt;span class="n">executor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newScheduledThreadPool&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å»¶è¿Ÿ 3 s åŽï¼Œæ¯ 1 s æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">scheduleAtFixedRate&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;å®šæ—¶ä»»åŠ¡&amp;#34;&lt;/span>&lt;span class="o">),&lt;/span> &lt;span class="n">3&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SECONDS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="forkjoinpool">ForkJoinPool&lt;/h2>
&lt;blockquote>
&lt;p>Fork -&amp;gt; æ‹†åˆ† Pool -&amp;gt; åˆå¹¶&lt;/p>
&lt;/blockquote>
&lt;p>æŠŠå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡ï¼Œæœ€åŽæ±‡æ€»å¤šä¸ªå°ä»»åŠ¡çš„ç»“æžœï¼Œå¾—åˆ°æ•´å¤§ä»»åŠ¡çš„ç»“æžœã€‚è¿™äº›å°ä»»åŠ¡éƒ½æ˜¯åŒæ—¶è¿›è¡Œï¼Œå¯æé«˜è¿ç®—æ•ˆçŽ‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Demo&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ForkJoinTask&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">task&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SubTask&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ForkJoinPool&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">commonPool&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">invoke&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">SubTask&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">RecursiveTask&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">private&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="nf">SubTask&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">protected&lt;/span> &lt;span class="n">Integer&lt;/span> &lt;span class="nf">compute&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">end&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">125&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="c1">// ä»»åŠ¡è¶³å¤Ÿå°ï¼Œç›´æŽ¥è®¡ç®—
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; å¼€å§‹è®¡ç®— &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;-&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;çš„å€¼&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ä»»åŠ¡å¤ªå¤§ï¼Œæ‹†åˆ†æˆå­ä»»åŠ¡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">SubTask&lt;/span> &lt;span class="n">subTask1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SubTask&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">end&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">2&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">subTask1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">fork&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">SubTask&lt;/span> &lt;span class="n">subTask2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SubTask&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">end&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">subTask2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">fork&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">subTask1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">join&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">subTask2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">join&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å·¥ä½œçªƒå–ï¼š&lt;/p>
&lt;p>å­ä»»åŠ¡ä¼šè¢«æ”¾åˆ°ä¸åŒçš„é˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸ªé˜Ÿåˆ—ä¼šæœ‰å¯¹åº”çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ã€‚&lt;/p>
&lt;p>è‹¥æŸä¸ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è®¡ç®—å®Œæ¯•ï¼Œä½†å…¶ä»–çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡ï¼Œä¼šä»Žå…¶ä»–é˜Ÿåˆ—ä¸­â€œçªƒå–â€ä»»åŠ¡ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://segmentfault.com/a/1190000039267451" target="_blank" rel="noopener"
>https://segmentfault.com/a/1190000039267451&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Java å¤šçº¿ç¨‹</title><link>https://emerywan.github.io/blog/p/thread/thread/</link><pubDate>Wed, 30 Mar 2022 14:02:02 +0800</pubDate><guid>https://emerywan.github.io/blog/p/thread/thread/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/9.jpeg" alt="Featured image of post Java å¤šçº¿ç¨‹" />&lt;h2 id="-è¿›ç¨‹ä¸Žçº¿ç¨‹">ðŸ­ è¿›ç¨‹ä¸Žçº¿ç¨‹&lt;/h2>
&lt;p>&lt;strong>è¿›ç¨‹&lt;/strong>æ˜¯ç¨‹åºå‘æ“ä½œç³»ç»Ÿç”³è¯·èµ„æºçš„åŸºæœ¬å•ä½ã€‚&lt;/p>
&lt;p>&lt;strong>çº¿ç¨‹&lt;/strong>æ˜¯è¿›ç¨‹ä¸­å¯ç‹¬ç«‹æ‰§è¡Œçš„æœ€å°å•ä½ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…æ‹¬å¤šä¸ªçº¿ç¨‹ï¼ŒåŒä¸€è¿›ç¨‹ä¸­æ‰€æœ‰çº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹ä¸­çš„èµ„æºã€‚&lt;/p>
&lt;h3 id="æ— å¤„ä¸åœ¨çš„çº¿ç¨‹">æ— å¤„ä¸åœ¨çš„çº¿ç¨‹&lt;/h3>
&lt;ul>
&lt;li>main çº¿ç¨‹&lt;/li>
&lt;li>åžƒåœ¾å›žæ”¶çº¿ç¨‹&lt;/li>
&lt;li>Web æœåŠ¡å™¨è¯·æ±‚å¤„ç†çº¿ç¨‹&lt;/li>
&lt;/ul>
&lt;h2 id="-å¹¶å‘ä¸Žå¹¶è¡Œ">ðŸ¹ å¹¶å‘ä¸Žå¹¶è¡Œ&lt;/h2>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/thread/concurrent-and-parallel.jpg"
width="600"
height="451"
srcset="https://emerywan.github.io/blog/blog/p/thread/thread/concurrent-and-parallel_hufc79b6e20e4f7d694c9a67d5fcfb6f12_40736_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/thread/thread/concurrent-and-parallel_hufc79b6e20e4f7d694c9a67d5fcfb6f12_40736_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
alt="ConcurrentAndParallel"
class="gallery-image"
data-flex-grow="133"
data-flex-basis="319px"
>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¹¶å‘ &lt;code>Concurrent&lt;/code>&lt;/p>
&lt;ul>
&lt;li>æŒ‡åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œäº¤æ›¿çš„å®Œæˆå¤šä¸ªä»»åŠ¡ï¼ˆä¸€ä¸ª CPU æ ¸å¿ƒäº¤æ›¿æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å¹¶è¡Œ &lt;code>Parallel&lt;/code>&lt;/p>
&lt;ul>
&lt;li>é½å¤´å¹¶è¿›åœ°æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼ˆå¤šä¸ª CPU æ ¸å¿ƒåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="-åŒæ­¥ä¸Žå¼‚æ­¥">ðŸ¦Š åŒæ­¥ä¸Žå¼‚æ­¥&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>åŒæ­¥&lt;/p>
&lt;ul>
&lt;li>éœ€è¦ç­‰å¾…ç»“æžœè¿”å›žï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å¼‚æ­¥&lt;/p>
&lt;ul>
&lt;li>ä¸éœ€è¦ç­‰å¾…ç»“æžœè¿”å›žï¼Œå°±èƒ½ç»§ç»­è¿è¡Œ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="-çº¿ç¨‹çš„åˆ›å»º">ðŸ» çº¿ç¨‹çš„åˆ›å»º&lt;/h2>
&lt;h3 id="extends-thread">extends Thread&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">class&lt;/span> &lt;span class="nc">MyThread&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">Thread&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="implement-runnable">implement Runnable&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">class&lt;/span> &lt;span class="nc">RunnableThread&lt;/span> &lt;span class="n">implement&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">RunnableThread&lt;/span>&lt;span class="o">()).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="implement-callable">implement Callable&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>Callable å¯ä»¥æœ‰è¿”å›žå€¼ï¼Œè¿”å›žå€¼é€šè¿‡ &lt;code>FutureTask&lt;/code> è¿›è¡Œå°è£…ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>call() æ–¹æ³•å…è®¸æŠ›å‡ºå¼‚å¸¸ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">class&lt;/span> &lt;span class="nc">CallbaleThead&lt;/span> &lt;span class="n">implement&lt;/span> &lt;span class="n">Callbale&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="n">Integer&lt;/span> &lt;span class="nf">call&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">666&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">FutureTask&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">futureTask&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">FutureTask&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">CallbaleThead&lt;/span>&lt;span class="o">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">new&lt;/span> &lt;span class="n">Thread&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">futureTask&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">futureTask&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/thread/thread/FutureTask.png"
width="964"
height="706"
srcset="https://emerywan.github.io/blog/blog/p/thread/thread/FutureTask_hu6b05634f3a5f84702cb4db413d8bbef5_51410_480x0_resize_box_3.png 480w, https://emerywan.github.io/blog/blog/p/thread/thread/FutureTask_hu6b05634f3a5f84702cb4db413d8bbef5_51410_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="FutureTask"
class="gallery-image"
data-flex-grow="136"
data-flex-basis="327px"
>&lt;/p>
&lt;h3 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± &lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Demo&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExecutorService&lt;/span> &lt;span class="n">executorService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newFixThreadPool&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">10&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">executorService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">currentThread&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">()));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Demo&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExecutorService&lt;/span> &lt;span class="n">executorService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newFixThreadPool&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">future&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executorService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">submit&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">666&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">future&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="-çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ">ðŸ¼ çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Thread&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Runnable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">enum&lt;/span> &lt;span class="n">State&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NEW&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RUNNABLE&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BLOCKED&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">WAITING&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TIMED_WAITING&lt;/span>&lt;span class="o">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TERMINATED&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>æ–°å»º &lt;code>New&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åˆ›å»ºåŽå°šæœªå¯åŠ¨ã€‚&lt;/p>
&lt;ul>
&lt;li>å¯è¿è¡Œ &lt;code>Runnable&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å¯èƒ½æ­£åœ¨è¿è¡Œï¼Œä¹Ÿå¯èƒ½æ­£åœ¨ç­‰å¾… CPU æ—¶é—´ç‰‡ã€‚&lt;/p>
&lt;ul>
&lt;li>é˜»å¡ž &lt;code>Blocked&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç­‰å¾…èŽ·å–ä¸€ä¸ªæŽ’å®ƒé”ï¼Œå¦‚æžœå…¶çº¿ç¨‹é‡Šæ”¾äº†é”å°±ä¼šç»“æŸæ­¤çŠ¶æ€ã€‚ï¼ˆæœªèŽ·å–è¿‡é”ï¼‰&lt;/p>
&lt;ul>
&lt;li>æ— é™æœŸç­‰å¾… &lt;code>Waiting&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç­‰å¾…å…¶å®ƒçº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ï¼Œå¦åˆ™ä¸ä¼šè¢«åˆ†é… CPU æ—¶é—´ç‰‡ã€‚ï¼ˆèŽ·å–è¿‡é”ï¼Œä½†æ˜¯æ”¾å¼ƒäº†é”ï¼‰&lt;/p>
&lt;ul>
&lt;li>é™æœŸç­‰å¾… &lt;code>Timed Waiting&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ— éœ€ç­‰å¾…å…¶å®ƒçº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ï¼Œåœ¨ä¸€å®šæ—¶é—´ä¹‹åŽä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨å”¤é†’ã€‚&lt;/p>
&lt;ul>
&lt;li>æ­»äº¡ &lt;code>Terminated&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>çº¿ç¨‹ç»“æŸä»»åŠ¡ä¹‹åŽè‡ªå·±ç»“æŸï¼Œæˆ–è€…äº§ç”Ÿäº†å¼‚å¸¸è€Œç»“æŸã€‚&lt;/p>
&lt;h2 id="-ä¸­æ–­çº¿ç¨‹">ðŸ° ä¸­æ–­çº¿ç¨‹&lt;/h2>
&lt;h2 id="-å®ˆæŠ¤çº¿ç¨‹">ðŸ¦Š å®ˆæŠ¤çº¿ç¨‹&lt;/h2>
&lt;p>Java ç¨‹åºçš„å…¥å£æ˜¯ç”± JVM å¯åŠ¨çš„ main çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œmain çº¿ç¨‹å¯ä»¥å¯åŠ¨å…¶ä»–çº¿ç¨‹ã€‚å½“æ‰€æœ‰çº¿ç¨‹è¿è¡Œéƒ½ç»“æŸæ—¶ï¼Œç¨‹åºç»ˆæ­¢ï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰é€€å‡ºï¼Œç¨‹åºå°±ä¸ä¼šç»ˆæ­¢ã€‚&lt;/p>
&lt;p>å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰æ˜¯ä¸€ç§åœ¨åŽå°ä¸ºå…¶ä»–çº¿ç¨‹æœåŠ¡çš„çº¿ç¨‹ã€‚åœ¨ JVM ä¸­ï¼Œåªè¦ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œæ— è®ºå®ˆæŠ¤çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œéƒ½ä¼šé€€å‡ºç¨‹åºã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">thread&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setDaemon&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>JVM çš„åžƒåœ¾å›žæ”¶çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹ã€‚&lt;/p>
&lt;h2 id="-æŸ¥çœ‹è¿›ç¨‹">ðŸ»â€â„ï¸ æŸ¥çœ‹è¿›ç¨‹&lt;/h2>
&lt;h3 id="linux">Linux&lt;/h3>
&lt;ul>
&lt;li>&lt;code>ps&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;code>ps -ef&lt;/code> ï¼šæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹&lt;/p>
&lt;ul>
&lt;li>&lt;code>top&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å‘½ä»¤ä¸‹å¯é€šè¿‡æŒ‰ &lt;code>H&lt;/code> åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹&lt;/p>
&lt;p>&lt;code>top -H -p 4262&lt;/code> ï¼š æŸ¥çœ‹ PID=4262 è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯&lt;/p>
&lt;h3 id="java">Java&lt;/h3>
&lt;ul>
&lt;li>&lt;code>jps&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹&lt;/p>
&lt;ul>
&lt;li>&lt;code>jstack&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;code>jstack 4262&lt;/code> ï¼š æŸ¥çœ‹ PID=4262 çš„ Java è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://pdai.tech/md/java/thread/java-thread-x-thread-basic.html#%e5%ae%9e%e7%8e%b0-callable-%e6%8e%a5%e5%8f%a3" target="_blank" rel="noopener"
>https://pdai.tech/md/java/thread/java-thread-x-thread-basic.html#%e5%ae%9e%e7%8e%b0-callable-%e6%8e%a5%e5%8f%a3&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Java Map æ“ä½œ</title><link>https://emerywan.github.io/blog/p/java-map-traversal/</link><pubDate>Thu, 28 Oct 2021 21:14:45 +0800</pubDate><guid>https://emerywan.github.io/blog/p/java-map-traversal/</guid><description>&lt;img src="https://emerywan.github.io/blog/imgs/11.jpeg" alt="Featured image of post Java Map æ“ä½œ" />&lt;p>åšè‡ªç„¶è¯­è¨€å¤„ç†å†™äº†æŒºä¹…çš„ &lt;code>Python&lt;/code> ï¼Œç»å¸¸è¦å¤„ç†æ•°æ®ã€‚ç”¨ &lt;code>Python&lt;/code> ä¸­çš„å¤„ç†æ•°æ®çœŸçš„æŒºçˆ½çš„ ðŸ«£ï¼Œæˆ‘å¹³å¸¸éƒ½å–œæ¬¢æŠŠå„ç§æ•°æ®éƒ½å¾€ &lt;code>dict&lt;/code>ï¼ˆä¹Ÿå°±æ˜¯ &lt;code>Java&lt;/code> ä¸­çš„ &lt;code>map&lt;/code>ï¼‰ å’Œ &lt;code>json&lt;/code> ä¸Šè½¬ï¼Œç”¨ &lt;code>Python&lt;/code> å¤„ç†è¿™ä¸ªå„ç§æ–¹ä¾¿ã€‚ æœ€è¿‘å†å†™ &lt;code>Java&lt;/code> å°±ç»å¸¸â€œæ‰‹æ®‹â€ï¼Œæ‰€ä»¥æ€»ç»“ä¸€ä¸‹ &lt;code>Java&lt;/code> ä¸­å¤„ç† &lt;code>Map&lt;/code>ã€‚&lt;/p>
&lt;h2 id="-éåŽ†æ–¹å¼">â­ï¸ éåŽ†æ–¹å¼&lt;/h2>
&lt;p>Java éåŽ† Mapï¼Œè¦ä¹ˆå°±æ˜¯éåŽ†å®ƒçš„ &lt;code>Map.Entry&amp;lt;K,V&amp;gt; &amp;lt;- entrySet()&lt;/code>ï¼Œè¦ä¹ˆå°±æ˜¯éåŽ†å®ƒçš„ key &lt;code>KeySet &amp;lt;- keySet()&lt;/code>ã€‚ä¸»è¦å¯ä»¥ç”¨ä¸‹é¢å››ç§æ–¹å¼éåŽ†ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Iterator&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ForEach&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Lambda&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Stream&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>é™¤éžç‰¹æ®Šéœ€è¦ï¼Œå°½é‡ä½¿ç”¨åŽ 3 ç§éåŽ†æ–¹å¼ï¼Œä½¿ç”¨ &lt;code>Iterator&lt;/code> å¯èƒ½æ›´å®¹æ˜“é€ æˆä¸€äº›é”™è¯¯ï¼ˆEffective Java - 58ï¼š&lt;code>for-each&lt;/code> ä¼˜å…ˆäºŽ &lt;code>for&lt;/code> å¾ªçŽ¯ï¼‰ã€‚&lt;/p>
&lt;p>åœ¨ä¸€äº› &lt;code>for-each&lt;/code> ä¸èƒ½èƒœä»»çš„åœ°æ–¹ï¼Œå…¶å®žä¹Ÿæœ‰å¾ˆå¯¹å†…ç½®æ–¹æ³•èƒ½å¤Ÿå®Œæˆæ“ä½œï¼Œä¸ä»…æ›´åŠ ç›´è§‚ï¼Œè€Œä¸”éžå¸¸æ˜“ç”¨ã€‚æ¯”å¦‚åˆ é™¤æ“ä½œï¼š&lt;code>Collection#removeIf()&lt;/code> &lt;code>Java 1.8+&lt;/code>ã€‚&lt;/p>
&lt;h3 id="foreach">ForEach&lt;/h3>
&lt;h4 id="entryset">EntrySet&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="nf">entrySet&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">entry&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="keyset">KeySet&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">keySet&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="lambda">Lambda&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">AbstractMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;,&lt;/span> &lt;span class="n">Cloneable&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Serializable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">forEach&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Biconsumer&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span> &lt;span class="kd">super&lt;/span> &lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="kd">super&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">action&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">forEach&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// key
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// value
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="stream">Stream&lt;/h3>
&lt;h4 id="steram">Steram&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">stream&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">forEach&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="parallelstream">parallelStream&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">parallelStream&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">forEach&lt;/span>&lt;span class="o">((&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="interator">Interator&lt;/h3>
&lt;h4 id="entryset-1">EntrySet&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Iterator&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">iterator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">iterator&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasNext&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">entry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ ¹æ® Effective Java - 57ï¼Œæ›´æŽ¨èä»¥ä¸‹è¿™ç§å†™æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Iterator&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">iterator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">iterator&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasNext&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">entry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="keyset-1">KeySet&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Iteator&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">iterator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">iterator&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasNext&lt;/span>&lt;span class="o">();&lt;/span> &lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iterator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="-ä¸€äº›æ“ä½œ">ðŸŒŸ ä¸€äº›æ“ä½œ&lt;/h2>
&lt;h3 id="åˆ¤ç©º">åˆ¤ç©º&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="err">ðŸ™‹&lt;/span>&lt;span class="n">â€&lt;/span>&lt;span class="err">â™‚&lt;/span>&lt;span class="n">ï¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="o">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">ðŸ™…&lt;/span>&lt;span class="n">â€&lt;/span>&lt;span class="err">â™‚&lt;/span>&lt;span class="n">ï¸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">boolean&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è®¡æ•°--merge">è®¡æ•° / merge()&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="nf">merge&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">BiFunction&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span> &lt;span class="kd">super&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="kd">super&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">remappingFunction&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">merge&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="removeif">removeIf()&lt;/h3>
&lt;blockquote>
&lt;p>ðŸš§ æ³¨æ„ï¼š&lt;/p>
&lt;p>&lt;code>Map&lt;/code> æœ¬èº«æ˜¯æ²¡æœ‰ &lt;code>removeIf()&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">removeIf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">entry&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">removeIf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">removeIf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="absent">absent&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="nf">putIfAbsent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸å­˜åœ¨ key æ—¶ï¼ŒæŒ‰ mappingFunction æ·»åŠ  value
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å­˜åœ¨ key ä¸æ”¹å˜
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">public&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="nf">computeIfAbsent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Function&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span> &lt;span class="kd">super&lt;/span> &lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">mappingFunction&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="nf">computeIfPresent&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">K&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">BiFunction&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span> &lt;span class="kd">super&lt;/span> &lt;span class="n">K&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="kd">super&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">V&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">remappingFunction&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="default">default&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getOrDefault&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="-å‚è€ƒ">ðŸ”— å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://mp.weixin.qq.com/s/zQBN3UvJDhRTKP6SzcZFKw" target="_blank" rel="noopener"
>https://mp.weixin.qq.com/s/zQBN3UvJDhRTKP6SzcZFKw&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>