<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>golang on ä¸€å±‚</title><link>https://emerywan.github.io/blog/tags/golang/</link><description>Recent content in golang on ä¸€å±‚</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Thu, 03 Aug 2023 12:13:14 +0800</lastBuildDate><atom:link href="https://emerywan.github.io/blog/tags/golang/index.xml" rel="self" type="application/rss+xml"/><item><title>golang channel</title><link>https://emerywan.github.io/blog/p/golang/channel/</link><pubDate>Thu, 03 Aug 2023 12:13:14 +0800</pubDate><guid>https://emerywan.github.io/blog/p/golang/channel/</guid><description>&lt;img src="https://emerywan.github.io/blog/p/golang/channel/go-channel.png" alt="Featured image of post golang channel" />&lt;h2 id="å›žé¡¾-channel">å›žé¡¾ Channel&lt;/h2>
&lt;p>åœ¨å¾ˆå¤šä¸»æµçš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹ä¼ é€’æ•°æ®çš„æ–¹å¼ä¸€èˆ¬éƒ½æ˜¯å…±äº«å†…å­˜ï¼Œä¸ºäº†è§£å†³çº¿ç¨‹ç«žäº‰ï¼Œéœ€è¦é™åˆ¶åŒä¸€æ—¶é—´èƒ½å¤Ÿè¯»å†™è¿™äº›å˜é‡çš„çº¿ç¨‹æ•°é‡ã€‚&lt;/p>
&lt;p>è™½ç„¶åœ¨ Go è¯­è¨€ä¸­ä¹Ÿèƒ½ä½¿ç”¨å…±äº«å†…å­˜åŠ äº’æ–¥é”è¿›è¡Œé€šä¿¡ï¼Œä½†æ˜¯ Go è¯­è¨€æä¾›äº†ä¸€ç§ä¸åŒçš„å¹¶å‘æ¨¡åž‹ï¼Œå³é€šä¿¡é¡ºåºè¿›ç¨‹ã€‚Goroutine ä¹‹é—´ä¼šé€šè¿‡ Channel ä¼ é€’æ•°æ®ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ch&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å‘é€æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">ch&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æŽ¥æ”¶æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">ch&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™é‡Œå…³äºŽ channel çš„å…¶ä»–ä½¿ç”¨å°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨-channel">ä¸ºä»€ä¹ˆä½¿ç”¨ Channel&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>é¿å…åç¨‹ç«žäº‰å’Œæ•°æ®å†²çªé—®é¢˜&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ›´é«˜çº§çš„æŠ½è±¡ï¼Œé™ä½Žå¼€å‘éš¾åº¦ï¼Œå¢žåŠ ç¨‹åºå¯è¯»æ€§&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¨¡å—ä¹‹é—´æ›´å®¹æ˜“è§£è€¦ï¼Œå¢žåŠ æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="channel-åº•å±‚ç»“æž„">Channel åº•å±‚ç»“æž„&lt;/h2>
&lt;p>channel çš„æ•°æ®ç»“æž„æ˜¯ &lt;code>runtime/chan.go&lt;/code> ä¸­çš„ä¸€ä¸ª &lt;code>hchan&lt;/code> ç»“æž„ä½“ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">hchan&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">qcount&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// channel ä¸­çš„å…ƒç´ ä¸ªæ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">dataqsiz&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// channel èƒ½å­˜æ”¾çš„å…ƒç´ å®¹é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span> &lt;span class="c1">// ç”¨äºŽå­˜æ”¾å…ƒç´ çš„çŽ¯å½¢ç¼“å†²åŒºï¼ŒæŒ‡å‘ç¬¬ä¸€ç¼“å­˜çš„ç¬¬ä¸€ä¸ªæ•°æ®æˆå‘˜
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">elemsize&lt;/span> &lt;span class="kt">uint16&lt;/span> &lt;span class="c1">// channel å…ƒç´ ç±»åž‹çš„å¤§å°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">closed&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="c1">// æ ‡è¯† channel æ˜¯å¦å…³é—­![](
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">elemtype&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">_type&lt;/span> &lt;span class="c1">// channel å…ƒç´ ç±»åž‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">sendx&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// å‘é€å…ƒç´ è¿›å…¥çŽ¯å½¢ç¼“å†²åŒºçš„ index
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">recvx&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// æŽ¥æ”¶å…ƒç´ æ‰€å¤„çš„çŽ¯å½¢ç¼“å†²åŒºçš„ index
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">recvq&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="c1">// ç­‰å¾…æŽ¥æ”¶æ•°æ®çš„åç¨‹é“¾è¡¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">sendq&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="c1">// ç­‰å¾…å‘é€æ•°æ®çš„åç¨‹é“¾è¡¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">lock&lt;/span> &lt;span class="nx">mutex&lt;/span> &lt;span class="c1">// äº’æ–¥é”ï¼Œä¿æŠ¤ hchan ç»“æž„ä½“æœ¬èº«
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¦‚æ‹¬ä¸€ä¸‹ï¼ŒChannel ä¸»è¦ç”±ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ç»„æˆã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ðŸ’¿ ä¸€ä¸ªçŽ¯å½¢ç¼“å­˜ &lt;code>buf&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ðŸ”— ä¸¤ä¸ªé“¾è¡¨ï¼ˆå‘é€åç¨‹é“¾è¡¨ &lt;code>recvq waitq&lt;/code> / æŽ¥æ”¶åç¨‹é“¾è¡¨ &lt;code>sendq waitq&lt;/code> ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ðŸ”’ ä¸€ä¸ªä¿æŠ¤ hchan çš„äº’æ–¥é” &lt;code>mutex&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/golang/channel/1.jpg"
width="1464"
height="945"
srcset="https://emerywan.github.io/blog/blog/p/golang/channel/1_hu78b1cec7845d67025bf678ce3560df05_214267_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/golang/channel/1_hu78b1cec7845d67025bf678ce3560df05_214267_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="154"
data-flex-basis="371px"
>&lt;/p>
&lt;h3 id="-çŽ¯å½¢ç¼“å­˜-buf">ðŸ’¿ çŽ¯å½¢ç¼“å­˜ buf&lt;/h3>
&lt;p>åœ¨ &lt;code>hchan&lt;/code> ç»“æž„ä½“ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹å­—æ®µç»„æˆäº†ä¸€ä¸ªçŽ¯å½¢ç¼“å­˜åŒºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">qcount&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// channel ä¸­çš„å…ƒç´ ä¸ªæ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// channel èƒ½å­˜æ”¾çš„å…ƒç´ å®¹é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">buf&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span> &lt;span class="c1">// ç”¨äºŽå­˜æ”¾å…ƒç´ çš„çŽ¯å½¢ç¼“å†²åŒºï¼ŒæŒ‡å‘ç¬¬ä¸€ç¼“å­˜çš„ç¬¬ä¸€ä¸ªæ•°æ®æˆå‘˜
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">elemsize&lt;/span> &lt;span class="kt">uint16&lt;/span> &lt;span class="c1">// channel å…ƒç´ ç±»åž‹çš„å¤§å°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">elemtype&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">_type&lt;/span> &lt;span class="c1">// channel å…ƒç´ ç±»åž‹
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ðŸ’¡ ä½¿ç”¨çŽ¯å½¢ç¼“å­˜åŒºçš„å¥½å¤„ï¼šçŽ¯å½¢åœ°ä½¿ç”¨æ•°æ®ï¼Œç±»ä¼¼äºŽä¸€ä¸ªçŽ¯å½¢é“¾è¡¨ï¼Œå¤§å¹…é™ä½Ž GC çš„å¼€é”€ï¼Œä½¿ç”¨æ—¶ä¸éœ€è¦å›žæ”¶å†…å­˜ã€‚&lt;/p>
&lt;h3 id="-å‘é€æŽ¥æ”¶åç¨‹é“¾è¡¨">ðŸ”— å‘é€/æŽ¥æ”¶åç¨‹é“¾è¡¨&lt;/h3>
&lt;p>åœ¨ &lt;code>hchan&lt;/code> ä¸­ï¼Œé€šè¿‡ &lt;code>recvx&lt;/code> å’Œ &lt;code>revcq&lt;/code> ç»„æˆäº†ä¸€ä¸ªæŽ¥æ”¶é“¾è¡¨ï¼›é€šè¿‡ &lt;code>sendx&lt;/code> å’Œ &lt;code>sendq&lt;/code> ç»„æˆäº†ä¸€ä¸ªå‘é€é“¾è¡¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">sendx&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// å‘é€å…ƒç´ è¿›å…¥çŽ¯å½¢ç¼“å†²åŒºçš„ indexï¼ˆæ¸¸æ ‡ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">recvx&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// æŽ¥æ”¶å…ƒç´ æ‰€å¤„çš„çŽ¯å½¢ç¼“å†²åŒºçš„ indexï¼ˆæ¸¸æ ‡ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">recvq&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="c1">// ç­‰å¾…æŽ¥æ”¶æ•°æ®çš„åç¨‹é“¾è¡¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">sendq&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="c1">// ç­‰å¾…å‘é€æ•°æ®çš„åç¨‹é“¾è¡¨
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç­‰å¾…å‘é€å’ŒæŽ¥æ”¶çš„åç¨‹åŒå‘é“¾è¡¨ &lt;code>recvq&lt;/code> &lt;code>sendq&lt;/code> éƒ½æ˜¯ &lt;code>waitq&lt;/code> ç±»åž‹ã€‚&lt;code>waitq&lt;/code> æ˜¯ &lt;code>chan.go&lt;/code> ä¸­å®šä¹‰çš„ç»“æž„ä½“ï¼Œæœ‰ &lt;code>first&lt;/code> å’Œ &lt;code>last&lt;/code> ä¸¤ä¸ªå±žæ€§ï¼Œåˆ†åˆ«æŒ‡å‘é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå’Œæœ€åŽä¸€ä¸ªæˆå‘˜ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">first&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sudog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">last&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sudog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¸ª &lt;code>waitq&lt;/code> ä¸­çš„æŒ‡é’ˆéƒ½æ˜¯ &lt;code>sudog&lt;/code> ç±»åž‹ã€‚&lt;code>sudog&lt;/code> æ˜¯åç¨‹çš„ä¸€ä¸ªåŒ…è£…ï¼Œå°†ä¸€ä¸ªåç¨‹åŒ…è£…æˆä¸€ä¸ªèŠ‚ç‚¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">sudog&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">g&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">next&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sudog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">prev&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sudog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">elem&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ... å…¶ä»–å±žæ€§
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>g&lt;/code> åŒ…è£…äº†åç¨‹ï¼Œä½¿ç”¨ &lt;code>next&lt;/code> &lt;code>prev&lt;/code> æŒ‡é’ˆï¼Œå°†åç¨‹ä¸²è”æˆä¸€ä¸ªé“¾è¡¨ã€‚&lt;/p>
&lt;p>&lt;code>elem&lt;/code> æ˜¯ &lt;code>unsafe&lt;/code> çš„ä¸‡èƒ½æŒ‡é’ˆï¼Œå­˜å‚¨äº†æƒ³è¦æŽ¥æ”¶å˜é‡çš„æ•°æ®çš„æŒ‡é’ˆã€‚æ¯”å¦‚ &lt;code>i &amp;lt;- ch&lt;/code>ï¼Œè¿™é‡Œ &lt;code>elem&lt;/code> å°±ä¼šå­˜å‚¨è¿™ä¸ªå˜é‡ &lt;code>i&lt;/code> çš„æŒ‡é’ˆã€‚&lt;/p>
&lt;h3 id="-ä¿æŠ¤-hchan-çš„äº’æ–¥é”-mutex">ðŸ”’ ä¿æŠ¤ hchan çš„äº’æ–¥é” &lt;code>mutex&lt;/code>&lt;/h3>
&lt;p>è¿™ä¸ª &lt;code>lock mutex&lt;/code> ç”¨æ¥ä¿æŠ¤ &lt;code>hchan struct&lt;/code> çš„æ‰€æœ‰å­—æ®µï¼Œæ‰€æœ‰åç¨‹æƒ³è¦æ“ä½œ &lt;code>hchan&lt;/code> è¿™ä¸ªç»“æž„ä½“çš„å†…å®¹ï¼Œå°±éœ€è¦åŠ è¿™ä¸ª &lt;code>mutex&lt;/code> é”ã€‚&lt;/p>
&lt;p>å¹¶ä¸æ˜¯ç”¨æ¥æŽ’é˜Ÿå‘é€æ•°æ®ã€æŽ¥æ”¶æ•°æ®çš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä¸ºä»€ä¹ˆ channel çš„å†…éƒ¨æœ‰é”ï¼Œè¿˜èƒ½è¾¾åˆ°é«˜å¹¶å‘é‡å‘¢ï¼Ÿ&lt;/p>
&lt;p>channel çš„äº’æ–¥é”åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä»…ç”¨äºŽä¿æŠ¤å°‘æ•°å…³é”®æ“ä½œï¼Œè€Œä¸æ˜¯æ¯æ¬¡è¯»å†™æ“ä½œéƒ½åŠ é”ï¼Œåªæœ‰åœ¨å†™æ•°æ®/è¯»æ•°æ®çš„ä¸€çž¬é—´éœ€è¦åŠ é”ï¼Œä¸éœ€è¦ä¸€ç›´åŠ é”ã€‚&lt;/p>
&lt;p>ä½¿ç”¨äº†å…¶ä»–ä¸€äº›æŠ€æœ¯æ¥æé«˜ channel çš„æ€§èƒ½ï¼Œæ¯”å¦‚ä½¿ç”¨æ— é”çš„å¾ªçŽ¯é˜Ÿåˆ—å®žçŽ°ç¼“å†²åŒºï¼Œå‡å°‘é”çš„ä½¿ç”¨ã€‚&lt;/p>
&lt;p>Go è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿï¼ˆruntimeï¼‰å†…éƒ¨å¯¹é”æœ‰ä¸€äº›ä¼˜åŒ–æŠ€æœ¯ï¼Œå¯ä»¥å‡å°‘äº’æ–¥é”çš„å¼€é”€ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="-channel-å‘é€æ•°æ®åŽŸç†">ðŸ™‹â€â™‚ï¸ channel å‘é€æ•°æ®åŽŸç†&lt;/h2>
&lt;p>å¦‚æžœæˆ‘ä»¬æƒ³å‘ channel ä¸­å‘é€æ•°æ®ï¼Œä¼šä½¿ç”¨ &lt;code>&amp;lt;-&lt;/code> å…³é”®å­—ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ch&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å‘é€æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">ch&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¸ª &lt;code>&amp;lt;-&lt;/code> æ˜¯ go ä¸­çš„â€œè¯­æ³•ç³–â€ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µï¼Œä¼šæŠŠ &lt;code>&amp;lt;-&lt;/code> è½¬æ¢æˆ &lt;code>chansend1()&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// chan.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// entry point for c &amp;lt;- x from compiled code.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//go:nosplit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chansend1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">chansend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">getcallerpc&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="-å‘é€æƒ…å½¢">ðŸ“š å‘é€æƒ…å½¢&lt;/h3>
&lt;p>channel çš„å‘é€æƒ…å½¢å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>âž¡ï¸ ç›´æŽ¥å‘é€&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ðŸ’¾ æ”¾å…¥ç¼“å­˜&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ðŸ’¤ ä¼‘çœ ç­‰å¾…&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="-ç›´æŽ¥å‘é€">âž¡ï¸ ç›´æŽ¥å‘é€&lt;/h4>
&lt;p>å½“å‘é€æ•°æ®æ—¶ï¼Œåœ¨ &lt;code>hchan&lt;/code> çš„ &lt;code>recvq&lt;/code> ä¸­å­˜åœ¨ä¼‘çœ ç­‰å¾…æŽ¥æ”¶çš„åç¨‹ã€‚ï¼ˆè¿™ä¸ªæ—¶å€™ç¼“å­˜ä¸€å®šä¸ºç©ºï¼Œæˆ–è€…æ²¡æœ‰ç¼“å­˜ï¼Œä¸ç”¨è€ƒè™‘ï¼‰&lt;/p>
&lt;p>ç›´æŽ¥å°†æ•°æ®æ‹·è´ç»™è¯¥åç¨‹çš„æŽ¥æ”¶å˜é‡ï¼Œå¹¶å”¤é†’åœ¨ &lt;code>recvq&lt;/code> ä¸­çš„è¿™ä¸ªç­‰å¾…åç¨‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/golang/channel/2.jpg"
width="1000"
height="680"
srcset="https://emerywan.github.io/blog/blog/p/golang/channel/2_hu266b57f27733842b4de3c5ae688ce188_59720_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/golang/channel/2_hu266b57f27733842b4de3c5ae688ce188_59720_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="147"
data-flex-basis="352px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// chan.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chansend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">block&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callerpc&lt;/span> &lt;span class="kt">uintptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">sg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">dequeue&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">sg&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Found a waiting receiver. We pass the value we want to send
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// directly to the receiver, bypassing the channel buffer (if any).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ..
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>åŠ é”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»Žé˜»å¡žåº¦åç¨‹é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª goroutine çš„å°è£…å¯¹è±¡ sudogï¼Œå¦‚æžœä¸ä¸º nilï¼Œç›´æŽ¥å‘é€&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨ send æ–¹æ³•ä¸­ï¼Œä¼šåŸºäºŽ memmove æ–¹æ³•ï¼Œç›´æŽ¥å°†å…ƒç´ æ‹·è´äº¤ç»™ sudog å¯¹åº”çš„ goroutine&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨ send æ–¹æ³•ä¸­ä¼šå®Œæˆè§£é”åŠ¨ä½œ&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="-æ”¾å…¥ç¼“å­˜">ðŸ’¾ æ”¾å…¥ç¼“å­˜&lt;/h4>
&lt;p>å½“æ²¡æœ‰åç¨‹åœ¨ç­‰å¾…æŽ¥æ”¶æ•°æ®ï¼Œä½†æ˜¯è¿˜æœ‰ç¼“å­˜ç©ºé—´ &lt;code>qcount &amp;lt; dataqsiz&lt;/code>ï¼Œå°†æ•°æ®æ”¾å…¥çŽ¯å½¢ç¼“å­˜ï¼Œç»´æŠ¤ç´¢å¼• &lt;code>sendx&lt;/code> &lt;code>qcount&lt;/code>ï¼ŒæˆåŠŸè¿”å›žã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/golang/channel/3.jpg"
width="1000"
height="668"
srcset="https://emerywan.github.io/blog/blog/p/golang/channel/3_hu266b57f27733842b4de3c5ae688ce188_49519_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/golang/channel/3_hu266b57f27733842b4de3c5ae688ce188_49519_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="149"
data-flex-basis="359px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// chan.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chansend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">block&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callerpc&lt;/span> &lt;span class="kt">uintptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">qcount&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Space is available in the channel buffer. Enqueue the element to send.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">qp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">chanbuf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">typedmemmove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">qp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">qcount&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>åŠ é”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å°†å½“å‰å…ƒç´ æ·»åŠ åˆ°çŽ¯å½¢ç¼“å†²åŒº &lt;code>sendx&lt;/code> å¯¹åº”çš„ä½ç½®&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç»´æŠ¤ç´¢å¼• &lt;code>sendx++&lt;/code> &lt;code>qcount++&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è§£é”ï¼Œè¿”å›žæˆåŠŸ&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="-ç­‰å¾…ä¼‘çœ ">ðŸ’¤ ç­‰å¾…ä¼‘çœ &lt;/h4>
&lt;p>å½“æ²¡æœ‰åç¨‹åœ¨ä¼‘çœ ç­‰å¾…æ•°æ®ï¼Œå¹¶ä¸”ç¼“å­˜å·²ç»æ»¡äº†ï¼ˆæˆ–æ²¡æœ‰ç¼“å­˜ï¼‰ï¼Œå°†è‡ªå·±åŒ…è£…æˆä¸€ä¸ª &lt;code>sudog&lt;/code>ï¼Œæ”¾å…¥ &lt;code>sendq&lt;/code> é˜Ÿåˆ—ï¼Œè§£é”åŽè¿›è¡Œä¼‘çœ ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/golang/channel/4.jpg"
width="1181"
height="764"
srcset="https://emerywan.github.io/blog/blog/p/golang/channel/4_hu80309041e5bf5d6f5c3d8c77d1463a3a_68006_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/golang/channel/4_hu80309041e5bf5d6f5c3d8c77d1463a3a_68006_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="154"
data-flex-basis="370px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">chansend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">block&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callerpc&lt;/span> &lt;span class="kt">uintptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Block on the channel.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">gp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getg&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">acquireSudog&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// åŒ…è£…æˆ sudog
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elem&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ep&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">gp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">waiting&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mysg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">enqueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// å…¥é˜Ÿ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Store8&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parkingOnChan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">gopark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">chanparkcommit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">waitReasonChanSend&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">traceEvGoBlockSend&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// ä¼‘çœ ï¼Œä¹‹åŽæ”¹åç¨‹å¡åœ¨è¿™æ®µä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">KeepAlive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ep&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// someone woke us up.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">mysg&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">waiting&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// å”¤é†’è¿™ä¸ªåç¨‹ï¼Œåªéœ€è¦ç»´æŠ¤ä¸€ä¸‹æ•°æ®å³å¯ï¼ˆè¯¥åç¨‹è¢«å”¤é†’ï¼Œæ•°æ®å·²ç»æ˜¯è¢«å–èµ°äº†çš„ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">throw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;G waiting list is corrupted&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">waiting&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activeStackChans&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">closed&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">success&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">releasetime&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">blockevent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">releasetime&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">t0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">releaseSudog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">closed&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">throw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;chansend: spurious wakeup&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">plainError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;send on closed channel&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>åŠ é”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æž„é€ å°è£…å½“å‰ goroutine çš„ sudog å¯¹è±¡&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®ŒæˆæŒ‡é’ˆæŒ‡å‘ï¼Œå»ºç«‹ sudogã€goroutineã€channel ä¹‹é—´çš„æŒ‡å‘å…³ç³»&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æŠŠ sudog æ·»åŠ åˆ°å½“å‰ channel çš„é˜»å¡žå†™åç¨‹é˜Ÿåˆ—ä¸­&lt;/p>
&lt;/li>
&lt;li>
&lt;p>park å½“å‰åç¨‹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å€˜è‹¥åç¨‹ä»Ž park ä¸­è¢«å”¤é†’ï¼Œåˆ™å›žæ”¶ sudogï¼ˆsudogèƒ½è¢«å”¤é†’ï¼Œå…¶å¯¹åº”çš„å…ƒç´ å¿…ç„¶å·²ç»è¢«è¯»åç¨‹å–èµ°ï¼Œç»´æŠ¤å…¶ä»–æ•°æ®ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è§£é”&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="-chanel-æŽ¥æ”¶æ•°æ®åŽŸç†">ðŸ’â€â™‚ï¸ Chanel æŽ¥æ”¶æ•°æ®åŽŸç†&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ch&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å‘é€æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">ch&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æŽ¥æ”¶æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">ch&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŽ¥æ”¶æ•°æ®çš„ &lt;code>&amp;lt;-&lt;/code> åŒæ ·æ˜¯ go ä¸­çš„â€œè¯­æ³•ç³–â€ã€‚&lt;/p>
&lt;p>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œå¦‚æžœæ˜¯ &lt;code>i &amp;lt;- ch&lt;/code> ä¼šè½¬æ¢æˆ &lt;code>runtime.chanrecv1()&lt;/code>ï¼›å¦‚æžœæ˜¯ &lt;code>i, ok &amp;lt;- ch&lt;/code> ä¼šè½¬åŒ–æˆ &lt;code>runtime.chanrecv2()&lt;/code>ï¼Œä¸¤è€…æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ &lt;code>chanrecv()&lt;/code> æ–¹æ³•ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// entry points for &amp;lt;- c from compiled code.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//go:nosplit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chanrecv1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">chanrecv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//go:nosplit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chanrecv2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">received&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">received&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">chanrecv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="-æŽ¥æ”¶æƒ…å½¢">ðŸ“š æŽ¥æ”¶æƒ…å½¢&lt;/h3>
&lt;p>å¯ä»¥å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››å¤§ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>âž¡ï¸ æŽ¥æ”¶æœ‰é˜»å¡žçš„å‘é€åç¨‹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ðŸ’¿ æŽ¥æ”¶æ— é˜»å¡žå‘é€åç¨‹ï¼Œä¸”ç¼“å†²åŒºæœ‰å…ƒç´ &lt;/p>
&lt;/li>
&lt;li>
&lt;p>ðŸ’¤ æŽ¥æ”¶æ— é˜»å¡žå‘é€åç¨‹ï¼Œä¸”ç¼“å†²åŒºæ— å…ƒç´ &lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="-æŽ¥æ”¶æœ‰é˜»å¡žçš„å‘é€åç¨‹">âž¡ï¸ æŽ¥æ”¶æœ‰é˜»å¡žçš„å‘é€åç¨‹&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>æ— ç¼“å†²åŒºï¼Œæœ‰åç¨‹åœ¨ &lt;code>sendq&lt;/code> ä¸­ç­‰å¾…å‘é€æ•°æ®ï¼Œç›´æŽ¥å°†æ•°æ®ä»Žå‘é€åç¨‹ä¸­æ‹·è´è¿‡æ¥ï¼Œå†å”¤é†’è¯¥å‘é€åç¨‹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœ‰ç¼“å†²åŒºï¼Œè¯»å–ç¼“å†²åŒº &lt;code>recvx&lt;/code> å…ƒç´ ï¼Œå°† &lt;code>sendq&lt;/code> ä¸­çš„ä¸€ä¸ªå‘é€åç¨‹çš„å…ƒç´ å†™å…¥ç¼“å†²åŒºã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ä¸ºä»€ä¹ˆæœ‰å‘é€åç¨‹é˜»å¡žçš„æ—¶å€™ï¼Œè¿˜æ˜¯è¦ä»Žç¼“å­˜ä¸­èŽ·å–æ•°æ®å‘¢ï¼Ÿ&lt;/p>
&lt;p>ç¼“å­˜åŒºçš„æ•°æ®ä¸€å®šæ¯”ç­‰å¾…å‘é€çš„åç¨‹ä¸­çš„æ•°æ®æ›´æ—©ï¼›å¦‚æžœä¸ä»Žç¼“å­˜ä¸­æŽ¥æ”¶ï¼Œç¼“å­˜ä¸­çš„æ•°æ®å¯èƒ½ä¸€ç›´æ‹¿ä¸èµ°ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/golang/channel/5.jpg"
width="1000"
height="742"
srcset="https://emerywan.github.io/blog/blog/p/golang/channel/5_hu266b57f27733842b4de3c5ae688ce188_73103_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/golang/channel/5_hu266b57f27733842b4de3c5ae688ce188_73103_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="134"
data-flex-basis="323px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// chan.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chanrecv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">block&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">selected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">received&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Just found waiting sender with not closed.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">sg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">dequeue&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">sg&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">recv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">recv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sg&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sudog&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">unlockf&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">skip&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// copy data from sender
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">recvDirect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Queue is full. Take the item at the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// head of the queue. Make the sender enqueue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// its item at the tail of the queue. Since the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// queue is full, those are both the same slot.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">qp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">chanbuf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">typedmemmove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">qp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">typedmemmove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">qp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elem&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span> &lt;span class="c1">// c.sendx = (c.sendx+1) % c.dataqsiz
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elem&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">g&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">unlockf&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">success&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">goready&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">skip&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>åŠ é”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä»Žé˜»å¡žå‘é€åç¨‹é˜Ÿåˆ—ä¸­èŽ·å–åˆ°ä¸€ä¸ªå‘é€åç¨‹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å€˜è‹¥ channel æ— ç¼“å†²åŒºï¼Œåˆ™ç›´æŽ¥è¯»å–å‘é€åç¨‹å…ƒç´ ï¼Œå¹¶å”¤é†’å‘é€åç¨‹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å€˜è‹¥ channel æœ‰ç¼“å†²åŒºï¼Œåˆ™è¯»å–ç¼“å†²åŒºå¤´éƒ¨å…ƒç´ ï¼Œå¹¶å°†å‘é€åç¨‹å…ƒç´ å‘é€å…¥ç¼“å†²åŒºå°¾éƒ¨åŽå”¤é†’å‘é€åç¨‹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è§£é”ï¼Œè¿”å›ž&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="-æŽ¥æ”¶æ— é˜»å¡žå‘é€åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ ">ðŸ’¿ æŽ¥æ”¶æ— é˜»å¡žå‘é€åç¨‹ï¼Œä¸”ç¼“å†²åŒºæœ‰å…ƒç´ &lt;/h4>
&lt;p>åœ¨ channel ä¸­ï¼Œå¦‚æžœæ²¡æœ‰åç¨‹åœ¨å‘é€é˜Ÿåˆ— &lt;code>sendq&lt;/code> ç­‰å¾…æŽ¥æ”¶ï¼Œåˆ¤æ–­è¯¥ channel ä¸­æœ‰æ— ç¼“å­˜ï¼Œå¦‚æžœæœ‰ï¼Œç›´æŽ¥ä»Žç¼“å­˜ä¸­å–èµ°ä¸€ä¸ªæ•°æ®ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/golang/channel/6.jpg"
width="1000"
height="671"
srcset="https://emerywan.github.io/blog/blog/p/golang/channel/6_hu266b57f27733842b4de3c5ae688ce188_50425_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/golang/channel/6_hu266b57f27733842b4de3c5ae688ce188_50425_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="149"
data-flex-basis="357px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">chanrecv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">block&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">selected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">received&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">qcount&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Receive directly from queue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">qp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">chanbuf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">typedmemmove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">qp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">typedmemclr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">qp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">qcount&lt;/span>&lt;span class="o">--&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>åŠ é”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>èŽ·å– &lt;code>recvx&lt;/code> å¯¹åº”ä½ç½®çš„å…ƒç´ &lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>recvx++&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>qcount--&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è§£é”ï¼Œè¿”å›ž&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="-æŽ¥æ”¶æ— é˜»å¡žå‘é€åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ ">ðŸ’¤ æŽ¥æ”¶æ— é˜»å¡žå‘é€åç¨‹ï¼Œä¸”ç¼“å†²åŒºæ— å…ƒç´ &lt;/h4>
&lt;p>åœ¨ channel ä¸­ï¼Œå¦‚æžœåœ¨ &lt;code>sendq&lt;/code> ä¸­æ²¡æœ‰åç¨‹åœ¨ç­‰å¾…å‘é€æ•°æ®ï¼Œå¹¶ä¸” &lt;code>buf&lt;/code> ä¸­æ²¡æœ‰ç¼“å­˜ï¼Œå°†è¯¥æŽ¥æ”¶åç¨‹åŒ…è£…æˆ &lt;code>sudog&lt;/code>ï¼Œå¹¶æ”¾å…¥ç­‰å¾…é˜Ÿåˆ— &lt;code>recvq&lt;/code> ä¸­ï¼Œè¿›è¡Œä¼‘çœ ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ”¾å…¥é˜Ÿåˆ—çš„æŽ¥æ”¶åç¨‹ï¼Œå½“è¢«å”¤é†’æ—¶ï¼Œæ•°æ®å·²ç»æ‹·è´åˆ°ä½ï¼Œä¸éœ€è¦è€ƒè™‘å¦‚ä½•æ‹·è´ã€‚&lt;/p>
&lt;p>&lt;img src="https://emerywan.github.io/blog/blog/p/golang/channel/7.jpg"
width="1106"
height="671"
srcset="https://emerywan.github.io/blog/blog/p/golang/channel/7_hu4e8996cd4c4e0e970e0cf1eb006e512e_60652_480x0_resize_q75_box.jpg 480w, https://emerywan.github.io/blog/blog/p/golang/channel/7_hu4e8996cd4c4e0e970e0cf1eb006e512e_60652_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="164"
data-flex-basis="395px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">chanrecv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">block&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">selected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">received&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getg&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">acquireSudog&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elem&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ep&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">waiting&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mysg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">gp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">enqueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Store8&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parkingOnChan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">gopark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">chanparkcommit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">waitReasonChanReceive&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">traceEvGoBlockRecv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">waiting&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">success&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">success&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">releaseSudog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">success&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>åŠ é”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å°è£…å½“å‰æŽ¥æ”¶åç¨‹çš„ &lt;code>sudog&lt;/code> å¯¹è±¡&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®ŒæˆæŒ‡é’ˆæŒ‡å‘ï¼Œå»ºç«‹ &lt;code>sudog&lt;/code>ã€&lt;code>goroutine&lt;/code>ã€&lt;code>channel&lt;/code> ä¹‹é—´çš„æŒ‡å‘å…³ç³»&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æŠŠ &lt;code>sudog&lt;/code> æ·»åŠ åˆ°å½“å‰ &lt;code>channel&lt;/code> çš„é˜»å¡žè¯»åç¨‹é˜Ÿåˆ—ä¸­&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>park&lt;/code> å½“å‰åç¨‹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å€˜è‹¥åç¨‹ä»Ž &lt;code>park&lt;/code> ä¸­è¢«å”¤é†’ï¼Œåˆ™å›žæ”¶ &lt;code>sudog&lt;/code>ï¼ˆ&lt;code>sudog&lt;/code>èƒ½è¢«å”¤é†’ï¼Œå…¶å¯¹åº”çš„å…ƒç´ å¿…ç„¶å·²ç»è¢«å†™å…¥ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è§£é”ï¼Œè¿”å›ž&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒ">ðŸ“–å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://zhuanlan.zhihu.com/p/597232906" target="_blank" rel="noopener"
>https://zhuanlan.zhihu.com/p/597232906&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://juejin.cn/post/7265891728163635215?searchId=202308131806253D2D64A0EC686F660F01" target="_blank" rel="noopener"
>https://juejin.cn/post/7265891728163635215?searchId=202308131806253D2D64A0EC686F660F01&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å›¾ç‰‡å…¨éƒ¨æ¥è‡ªäºŽ &lt;a class="link" href="https://zhuanlan.zhihu.com/p/597232906" target="_blank" rel="noopener"
>https://zhuanlan.zhihu.com/p/597232906&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description></item></channel></rss>